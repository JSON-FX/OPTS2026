# Story 3.3: Transaction Actions Schema & Models

**Status**: Ready for Review
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As a developer, I need database tables and Eloquent models to record transaction actions (Endorse, Receive, Complete), so that the system can track the complete endorsement history and audit trail for each transaction.

---

## Acceptance Criteria

1. **Transaction Actions Table Migration**: Migration created for `transaction_actions` table with columns:
   - `id` (primary key, auto-increment)
   - `transaction_id` (foreign key to transactions)
   - `action_type` (enum: 'endorse', 'receive', 'complete', 'hold', 'cancel', 'bypass')
   - `action_taken_id` (foreign key to action_taken repository, nullable)
   - `from_office_id` (foreign key to offices, nullable) - office sending the transaction
   - `to_office_id` (foreign key to offices, nullable) - office receiving the transaction
   - `from_user_id` (foreign key to users) - user performing the action
   - `to_user_id` (foreign key to users, nullable) - target user (for receive)
   - `workflow_step_id` (foreign key to workflow_steps, nullable) - current step when action occurred
   - `is_out_of_workflow` (boolean, default: false) - flagged for out-of-sequence routing
   - `notes` (text, nullable) - additional notes/comments
   - `reason` (text, nullable) - reason for hold/cancel/bypass actions
   - `ip_address` (string 45, nullable) - for audit trail
   - `created_at` (timestamp)
   - Foreign key constraints with ON DELETE RESTRICT
   - Indexes on `transaction_id`, `action_type`, `from_office_id`, `to_office_id`, `created_at`

2. **Transaction Tracking Columns**: Migration to add tracking columns to `transactions` table:
   - `current_step_id` (foreign key to workflow_steps, nullable) - current position in workflow
   - `received_at` (timestamp, nullable) - when current office received the transaction
   - `endorsed_at` (timestamp, nullable) - when transaction was last endorsed
   - Indexes on `current_step_id`, `received_at`

3. **TransactionAction Eloquent Model**: `app/Models/TransactionAction.php` created with:
   - Fillable: all columns except `id`, `created_at`
   - Casts: `is_out_of_workflow` as boolean, `created_at` as datetime
   - Relationships:
     - `belongsTo(Transaction::class)`
     - `belongsTo(ActionTaken::class, 'action_taken_id')`
     - `belongsTo(Office::class, 'from_office_id')`
     - `belongsTo(Office::class, 'to_office_id')`
     - `belongsTo(User::class, 'from_user_id')`
     - `belongsTo(User::class, 'to_user_id')`
     - `belongsTo(WorkflowStep::class, 'workflow_step_id')`
   - Scopes:
     - `scopeOfType($query, $type)` - filter by action_type
     - `scopeOutOfWorkflow($query)` - filter is_out_of_workflow = true
     - `scopeForTransaction($query, $transactionId)`
     - `scopeByOffice($query, $officeId)` - from or to office
   - Constants for action types:
     ```php
     const TYPE_ENDORSE = 'endorse';
     const TYPE_RECEIVE = 'receive';
     const TYPE_COMPLETE = 'complete';
     const TYPE_HOLD = 'hold';
     const TYPE_CANCEL = 'cancel';
     const TYPE_BYPASS = 'bypass';
     ```

4. **Transaction Model Enhancement**: Update `app/Models/Transaction.php` with:
   - New relationship: `hasMany(TransactionAction::class)`
   - New relationship: `belongsTo(WorkflowStep::class, 'current_step_id')`
   - Accessor: `getActionsHistoryAttribute()` - returns actions ordered by created_at desc
   - Accessor: `getLastActionAttribute()` - returns most recent action
   - Accessor: `getCurrentHolderAttribute()` - returns current office and user
   - Method: `isAtStep($stepOrder)` - checks if at specific workflow step
   - Method: `hasBeenReceivedByCurrentOffice()` - checks if received_at is set

5. **TypeScript Interfaces**: Add interfaces in `resources/js/types/models.ts`:
   ```typescript
   type ActionType = 'endorse' | 'receive' | 'complete' | 'hold' | 'cancel' | 'bypass';

   interface TransactionAction {
     id: number;
     transaction_id: number;
     action_type: ActionType;
     action_taken_id: number | null;
     from_office_id: number | null;
     to_office_id: number | null;
     from_user_id: number;
     to_user_id: number | null;
     workflow_step_id: number | null;
     is_out_of_workflow: boolean;
     notes: string | null;
     reason: string | null;
     ip_address: string | null;
     created_at: string;

     // Relationships
     transaction?: Transaction;
     action_taken?: ActionTaken;
     from_office?: Office;
     to_office?: Office;
     from_user?: User;
     to_user?: User;
     workflow_step?: WorkflowStep;
   }
   ```

6. **Model Factory**: `database/factories/TransactionActionFactory.php` created for testing

7. **Database Seeder**: Update seeders to create sample transaction actions demonstrating:
   - Complete endorsement chain (endorse → receive → endorse → receive → complete)
   - Mix of action types
   - Some out-of-workflow examples

8. **Migration Rollback**: Each migration includes proper `down()` method

9. **Test Coverage**: Feature tests verify:
   - Transaction-Action relationship (one-to-many)
   - All scopes work correctly
   - Model accessors return expected data
   - Foreign key constraints enforced
   - is_out_of_workflow flag works

---

## Dev Notes

### Transaction Action Flow Concept

The action system tracks every movement of a transaction:

```
Transaction Created (status: Created)
  ↓
[ENDORSE] Originating Office → Budget Office
  ↓
[RECEIVE] Budget Office accepts
  ↓
[ENDORSE] Budget Office → BAC Office
  ↓
[RECEIVE] BAC Office accepts
  ↓
... continues through workflow ...
  ↓
[COMPLETE] Final office marks complete
```

Each action creates a `transaction_actions` record capturing:
- Who did what (from_user_id, action_type)
- From where to where (from_office_id, to_office_id)
- When (created_at)
- At what workflow step (workflow_step_id)
- Whether it was out-of-workflow (is_out_of_workflow)

### Key Design Decisions

1. **Separate Action Types**: Rather than a generic "action" with free-text, we use typed actions (endorse, receive, complete, etc.) for reliable querying and state machine logic.

2. **Nullable Office Fields**: `from_office_id` is null for initial creation; `to_office_id` is null for complete/hold/cancel actions.

3. **IP Address Logging**: Per NFR4, we capture IP address for audit trail compliance.

4. **Workflow Step Reference**: Captures which step the transaction was at when the action occurred, enabling timeline reconstruction even if workflow is later modified.

5. **Out-of-Workflow Flag**: Critical for misroute detection (FR14). Set when `to_office_id` doesn't match the expected next office per workflow.

### Action Type Semantics

| Action Type | From Office | To Office | Description |
|------------|-------------|-----------|-------------|
| endorse | Current holder | Target office | Send transaction to next office |
| receive | Sending office | Receiving office | Accept transaction at current office |
| complete | Current holder | null | Mark transaction finished |
| hold | Current holder | null | Pause transaction processing |
| cancel | Current holder | null | Cancel transaction |
| bypass | Admin's office | Corrected office | Admin redirect (misroute correction) |

### Migration File Naming

```
2025_11_XX_000300_create_transaction_actions_table.php
2025_11_XX_000400_add_transaction_tracking_columns.php
```

### Reference Files

- Transaction model: `app/Models/Transaction.php`
- Workflow models: Story 3.1
- Action Taken repository: Story 1.6
- Audit requirements: PRD NFR4

### Story Dependencies

**Depends on**:
- Story 3.1 (Workflow Schema & Model Foundation) - for workflow_step_id FK
- Story 2.1 (Database Schema) - for transactions table
- Story 1.6 (Action Taken Repository) - for action_taken_id FK

**Blocks**:
- Story 3.4 (Endorse Action Implementation)
- Story 3.5 (Receive Action Implementation)
- Story 3.6 (Complete Action Implementation)
- Story 3.8 (Out-of-Workflow Detection)
- Story 3.10 (Timeline Visualization)

---

## Tasks

### Task 1: Create Transaction Actions Migration
**Estimate**: 30 minutes
- Create migration file for `transaction_actions` table
- Define all columns per AC#1
- Add foreign key constraints with ON DELETE RESTRICT
- Add indexes on key columns
- Define `down()` method

**Verification**:
```bash
php artisan migrate --pretend
```

### Task 2: Create Transaction Tracking Columns Migration
**Estimate**: 20 minutes
- Create migration to alter `transactions` table
- Add `current_step_id` (FK to workflow_steps)
- Add `received_at` (timestamp, nullable)
- Add `endorsed_at` (timestamp, nullable)
- Add indexes
- Define `down()` method

**Verification**:
```bash
php artisan migrate --pretend
```

### Task 3: Create TransactionAction Model
**Estimate**: 45 minutes
- Create `app/Models/TransactionAction.php`
- Define fillable array with all columns
- Define casts for boolean and datetime fields
- Implement all relationships (7 total)
- Implement scopes: `ofType`, `outOfWorkflow`, `forTransaction`, `byOffice`
- Define action type constants
- Add PHPDoc comments

**Verification**:
```bash
php artisan tinker
# Test relationships and scopes
```

### Task 4: Update Transaction Model
**Estimate**: 30 minutes
- Update `app/Models/Transaction.php`
- Add `hasMany(TransactionAction::class)` relationship
- Add `belongsTo(WorkflowStep::class, 'current_step_id')` relationship
- Add `current_step_id`, `received_at`, `endorsed_at` to fillable
- Add datetime casts for new timestamp fields
- Implement accessors: `actionsHistory`, `lastAction`, `currentHolder`
- Implement methods: `isAtStep()`, `hasBeenReceivedByCurrentOffice()`

**Verification**:
```bash
php artisan tinker
# Test: Transaction::first()->actions
```

### Task 5: Create Model Factory
**Estimate**: 25 minutes
- Create `database/factories/TransactionActionFactory.php`
- Generate realistic action data
- Handle nullable fields appropriately
- Create state methods for each action type (e.g., `->endorse()`, `->receive()`)

**Verification**:
```bash
php artisan tinker
# Test: TransactionAction::factory()->endorse()->create()
```

### Task 6: Update Database Seeder
**Estimate**: 40 minutes
- Update or create seeder for transaction actions
- Create sample endorsement chains for existing transactions
- Include examples of all action types
- Include some out-of-workflow examples
- Ensure realistic from/to office progressions

**Verification**:
```bash
php artisan db:seed
```

### Task 7: Add TypeScript Interfaces
**Estimate**: 15 minutes
- Update `resources/js/types/models.ts`
- Add `ActionType` type union
- Add `TransactionAction` interface with all fields
- Update `Transaction` interface with new fields and relationships

**Verification**:
```bash
npm run build
```

### Task 8: Write Feature Tests
**Estimate**: 1 hour
- Create `tests/Feature/Models/TransactionActionTest.php`:
  - Test action-transaction relationship
  - Test action-office relationships (from/to)
  - Test action-user relationships (from/to)
  - Test action-workflow_step relationship
  - Test all scopes
  - Test is_out_of_workflow filtering
- Create `tests/Feature/Models/TransactionActionsIntegrationTest.php`:
  - Test Transaction->actions relationship
  - Test actionsHistory accessor ordering
  - Test lastAction accessor
  - Test currentHolder accessor

**Verification**:
```bash
php artisan test --filter=TransactionAction
```

### Task 9: Run Migrations and Verify
**Estimate**: 15 minutes
- Run migrations: `php artisan migrate`
- Run seeders: `php artisan db:seed`
- Verify relationships in tinker
- Run full test suite

**Verification**:
```bash
php artisan migrate:fresh --seed
php artisan test
```

---

## Acceptance Checklist

- [x] transaction_actions table created with all columns
- [x] All foreign key constraints properly defined
- [x] Indexes added on key query columns
- [x] transactions table enhanced with tracking columns
- [x] TransactionAction model implements all relationships
- [x] TransactionAction model implements all scopes
- [x] Action type constants defined
- [x] Transaction model updated with new relationships and accessors
- [x] Model factory generates valid test data
- [x] Seeder creates realistic action chains
- [x] TypeScript interfaces match database schema
- [x] Feature tests cover relationships and scopes
- [x] All existing tests continue to pass
- [x] Migration rollbacks work correctly

**Definition of Done**: Transaction actions can be recorded and queried with full relationship support, scopes work correctly, and the foundation is ready for action implementation stories.

---

## Dev Agent Record

**Story**: 3.3 - Transaction Actions Schema & Models
**Status**: Ready for Review
**Assigned**: James (Dev Agent)
**Agent Model Used**: Claude Opus 4.5
**Start Date**: 2025-12-09
**Completion Date**: 2025-12-09

### Files Created
- [x] `database/migrations/2025_12_09_000100_create_transaction_actions_table.php`
- [x] `database/migrations/2025_12_09_000200_add_transaction_tracking_columns.php`
- [x] `app/Models/TransactionAction.php`
- [x] `database/factories/TransactionActionFactory.php`
- [x] `database/factories/ActionTakenFactory.php` (added to support tests)
- [x] `database/seeders/TransactionActionSeeder.php`
- [x] `tests/Feature/Models/TransactionActionTest.php`
- [x] `tests/Feature/Models/TransactionActionsIntegrationTest.php`

### Files Modified
- [x] `app/Models/Transaction.php`
- [x] `database/seeders/DatabaseSeeder.php`
- [x] `resources/js/types/models.ts`

### Test Results
- [x] Migration tests: Verified with migrate --pretend and actual migration
- [x] Model tests: 37 passing (82 assertions)
- [x] Rollback tests: Verified both migrations rollback correctly

### Debug Log References
None - no issues encountered during implementation.

### Completion Notes
- Created `transaction_actions` table with all required columns, FKs, and indexes per AC#1
- Added tracking columns (`current_step_id`, `received_at`, `endorsed_at`) to transactions table per AC#2
- TransactionAction model implements all 7 relationships and 4 scopes per AC#3
- Transaction model enhanced with new relationships and accessors per AC#4
- TypeScript interfaces updated with ActionType and TransactionAction per AC#5
- Factory created with state methods for all action types per AC#6
- Created new TransactionActionSeeder demonstrating complete chains, partial chains, and out-of-workflow examples per AC#7
- All migrations have proper down() methods and rollbacks verified per AC#8
- All 37 new tests passing per AC#9

### Change Log
| Date | Change | Files |
|------|--------|-------|
| 2025-12-09 | Created transaction_actions migration | database/migrations/2025_12_09_000100_create_transaction_actions_table.php |
| 2025-12-09 | Created transaction tracking columns migration | database/migrations/2025_12_09_000200_add_transaction_tracking_columns.php |
| 2025-12-09 | Created TransactionAction model with relationships and scopes | app/Models/TransactionAction.php |
| 2025-12-09 | Updated Transaction model with actions relationship and tracking | app/Models/Transaction.php |
| 2025-12-09 | Created TransactionActionFactory with state methods | database/factories/TransactionActionFactory.php |
| 2025-12-09 | Created ActionTakenFactory for test support | database/factories/ActionTakenFactory.php |
| 2025-12-09 | Created TransactionActionSeeder | database/seeders/TransactionActionSeeder.php |
| 2025-12-09 | Updated DatabaseSeeder | database/seeders/DatabaseSeeder.php |
| 2025-12-09 | Added TypeScript interfaces | resources/js/types/models.ts |
| 2025-12-09 | Created feature tests | tests/Feature/Models/TransactionActionTest.php, tests/Feature/Models/TransactionActionsIntegrationTest.php |

---

## QA Results

### Review Date: 2025-12-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - This is a well-executed database schema and model story. The implementation demonstrates strong adherence to Laravel conventions, proper use of strict typing, comprehensive PHPDoc documentation, and thorough test coverage.

**Highlights:**
- Clean migration structure with proper FK constraints and indexes
- Model follows Laravel best practices with explicit `$fillable`, typed casts, and proper relationship definitions
- Constants for action types improve code maintainability and reduce magic strings
- Setting `UPDATED_AT = null` correctly reflects that actions are immutable audit records
- Factory provides excellent state methods for testing different action types
- Tests cover all relationships, scopes, accessors, and edge cases

### Refactoring Performed

None required. The implementation is clean and follows project standards.

### Compliance Check

- Coding Standards: ✓ Follows PSR-12, strict_types, proper naming conventions
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ 37 tests with 82 assertions covering all acceptance criteria
- All ACs Met: ✓ All 9 acceptance criteria fully implemented

### Improvements Checklist

- [x] All migrations have proper `down()` methods (verified rollback works)
- [x] Model uses constants instead of magic strings for action types
- [x] PHPDoc blocks document all properties and relationships
- [x] TypeScript interfaces match PHP models exactly
- [x] Factory provides state methods for all 6 action types
- [x] Seeder demonstrates all action patterns (complete chain, partial, mixed)
- [x] Tests cover all 4 scopes, 7 relationships, and 3 accessors/methods
- [ ] Consider adding a `scopeRecent()` scope for common query pattern (future enhancement)
- [ ] Consider adding `action_type` enum class for stronger typing (future enhancement)

### Security Review

✓ **No security concerns identified**
- IP address logging implemented per NFR4 audit requirements
- Foreign key constraints use ON DELETE RESTRICT preventing orphan records
- No mass assignment vulnerabilities (`$fillable` properly configured)
- Audit trail is append-only (no `updated_at` timestamp)

### Performance Considerations

✓ **No performance concerns identified**
- Proper indexes on frequently queried columns (`transaction_id`, `action_type`, `from_office_id`, `to_office_id`, `created_at`)
- Index on `current_step_id` and `received_at` in transactions table
- Relationships use lazy loading by default (appropriate for this model)

### Files Modified During Review

None - no modifications needed.

### Test Coverage Summary

| Test Category | Tests | Assertions |
|--------------|-------|------------|
| TransactionActionTest | 22 | ~50 |
| TransactionActionsIntegrationTest | 15 | ~32 |
| **Total** | **37** | **82** |

### Requirements Traceability

| AC# | Requirement | Test Coverage |
|-----|-------------|---------------|
| 1 | transaction_actions table | `test_transaction_action_can_be_created` |
| 2 | Transaction tracking columns | `test_new_fields_are_fillable`, `test_received_at_and_endorsed_at_are_cast_to_datetime` |
| 3 | TransactionAction model | All relationship and scope tests |
| 4 | Transaction model enhancement | `test_transaction_has_many_actions`, `test_actions_history_accessor_returns_actions_ordered_by_created_at_desc`, `test_last_action_accessor_returns_most_recent_action`, `test_current_holder_accessor_returns_office_and_user`, `test_is_at_step_returns_true_for_matching_step_order`, `test_has_been_received_by_current_office_returns_true_when_received_at_set` |
| 5 | TypeScript interfaces | Verified `npm run build` passes |
| 6 | Model factory | All factory state tests |
| 7 | Database seeder | Seeder creates complete, partial, and mixed chains |
| 8 | Migration rollback | Verified manually - both migrations roll back correctly |
| 9 | Test coverage | 37 tests covering all requirements |

### Gate Status

**Gate**: PASS → docs/qa/gates/3.3-transaction-actions-schema-models.yml
**Quality Score**: 100

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, no issues identified.
