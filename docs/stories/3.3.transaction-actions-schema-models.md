# Story 3.3: Transaction Actions Schema & Models

**Status**: Draft
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As a developer, I need database tables and Eloquent models to record transaction actions (Endorse, Receive, Complete), so that the system can track the complete endorsement history and audit trail for each transaction.

---

## Acceptance Criteria

1. **Transaction Actions Table Migration**: Migration created for `transaction_actions` table with columns:
   - `id` (primary key, auto-increment)
   - `transaction_id` (foreign key to transactions)
   - `action_type` (enum: 'endorse', 'receive', 'complete', 'hold', 'cancel', 'bypass')
   - `action_taken_id` (foreign key to action_taken repository, nullable)
   - `from_office_id` (foreign key to offices, nullable) - office sending the transaction
   - `to_office_id` (foreign key to offices, nullable) - office receiving the transaction
   - `from_user_id` (foreign key to users) - user performing the action
   - `to_user_id` (foreign key to users, nullable) - target user (for receive)
   - `workflow_step_id` (foreign key to workflow_steps, nullable) - current step when action occurred
   - `is_out_of_workflow` (boolean, default: false) - flagged for out-of-sequence routing
   - `notes` (text, nullable) - additional notes/comments
   - `reason` (text, nullable) - reason for hold/cancel/bypass actions
   - `ip_address` (string 45, nullable) - for audit trail
   - `created_at` (timestamp)
   - Foreign key constraints with ON DELETE RESTRICT
   - Indexes on `transaction_id`, `action_type`, `from_office_id`, `to_office_id`, `created_at`

2. **Transaction Tracking Columns**: Migration to add tracking columns to `transactions` table:
   - `current_step_id` (foreign key to workflow_steps, nullable) - current position in workflow
   - `received_at` (timestamp, nullable) - when current office received the transaction
   - `endorsed_at` (timestamp, nullable) - when transaction was last endorsed
   - Indexes on `current_step_id`, `received_at`

3. **TransactionAction Eloquent Model**: `app/Models/TransactionAction.php` created with:
   - Fillable: all columns except `id`, `created_at`
   - Casts: `is_out_of_workflow` as boolean, `created_at` as datetime
   - Relationships:
     - `belongsTo(Transaction::class)`
     - `belongsTo(ActionTaken::class, 'action_taken_id')`
     - `belongsTo(Office::class, 'from_office_id')`
     - `belongsTo(Office::class, 'to_office_id')`
     - `belongsTo(User::class, 'from_user_id')`
     - `belongsTo(User::class, 'to_user_id')`
     - `belongsTo(WorkflowStep::class, 'workflow_step_id')`
   - Scopes:
     - `scopeOfType($query, $type)` - filter by action_type
     - `scopeOutOfWorkflow($query)` - filter is_out_of_workflow = true
     - `scopeForTransaction($query, $transactionId)`
     - `scopeByOffice($query, $officeId)` - from or to office
   - Constants for action types:
     ```php
     const TYPE_ENDORSE = 'endorse';
     const TYPE_RECEIVE = 'receive';
     const TYPE_COMPLETE = 'complete';
     const TYPE_HOLD = 'hold';
     const TYPE_CANCEL = 'cancel';
     const TYPE_BYPASS = 'bypass';
     ```

4. **Transaction Model Enhancement**: Update `app/Models/Transaction.php` with:
   - New relationship: `hasMany(TransactionAction::class)`
   - New relationship: `belongsTo(WorkflowStep::class, 'current_step_id')`
   - Accessor: `getActionsHistoryAttribute()` - returns actions ordered by created_at desc
   - Accessor: `getLastActionAttribute()` - returns most recent action
   - Accessor: `getCurrentHolderAttribute()` - returns current office and user
   - Method: `isAtStep($stepOrder)` - checks if at specific workflow step
   - Method: `hasBeenReceivedByCurrentOffice()` - checks if received_at is set

5. **TypeScript Interfaces**: Add interfaces in `resources/js/types/models.ts`:
   ```typescript
   type ActionType = 'endorse' | 'receive' | 'complete' | 'hold' | 'cancel' | 'bypass';

   interface TransactionAction {
     id: number;
     transaction_id: number;
     action_type: ActionType;
     action_taken_id: number | null;
     from_office_id: number | null;
     to_office_id: number | null;
     from_user_id: number;
     to_user_id: number | null;
     workflow_step_id: number | null;
     is_out_of_workflow: boolean;
     notes: string | null;
     reason: string | null;
     ip_address: string | null;
     created_at: string;

     // Relationships
     transaction?: Transaction;
     action_taken?: ActionTaken;
     from_office?: Office;
     to_office?: Office;
     from_user?: User;
     to_user?: User;
     workflow_step?: WorkflowStep;
   }
   ```

6. **Model Factory**: `database/factories/TransactionActionFactory.php` created for testing

7. **Database Seeder**: Update seeders to create sample transaction actions demonstrating:
   - Complete endorsement chain (endorse → receive → endorse → receive → complete)
   - Mix of action types
   - Some out-of-workflow examples

8. **Migration Rollback**: Each migration includes proper `down()` method

9. **Test Coverage**: Feature tests verify:
   - Transaction-Action relationship (one-to-many)
   - All scopes work correctly
   - Model accessors return expected data
   - Foreign key constraints enforced
   - is_out_of_workflow flag works

---

## Dev Notes

### Transaction Action Flow Concept

The action system tracks every movement of a transaction:

```
Transaction Created (status: Created)
  ↓
[ENDORSE] Originating Office → Budget Office
  ↓
[RECEIVE] Budget Office accepts
  ↓
[ENDORSE] Budget Office → BAC Office
  ↓
[RECEIVE] BAC Office accepts
  ↓
... continues through workflow ...
  ↓
[COMPLETE] Final office marks complete
```

Each action creates a `transaction_actions` record capturing:
- Who did what (from_user_id, action_type)
- From where to where (from_office_id, to_office_id)
- When (created_at)
- At what workflow step (workflow_step_id)
- Whether it was out-of-workflow (is_out_of_workflow)

### Key Design Decisions

1. **Separate Action Types**: Rather than a generic "action" with free-text, we use typed actions (endorse, receive, complete, etc.) for reliable querying and state machine logic.

2. **Nullable Office Fields**: `from_office_id` is null for initial creation; `to_office_id` is null for complete/hold/cancel actions.

3. **IP Address Logging**: Per NFR4, we capture IP address for audit trail compliance.

4. **Workflow Step Reference**: Captures which step the transaction was at when the action occurred, enabling timeline reconstruction even if workflow is later modified.

5. **Out-of-Workflow Flag**: Critical for misroute detection (FR14). Set when `to_office_id` doesn't match the expected next office per workflow.

### Action Type Semantics

| Action Type | From Office | To Office | Description |
|------------|-------------|-----------|-------------|
| endorse | Current holder | Target office | Send transaction to next office |
| receive | Sending office | Receiving office | Accept transaction at current office |
| complete | Current holder | null | Mark transaction finished |
| hold | Current holder | null | Pause transaction processing |
| cancel | Current holder | null | Cancel transaction |
| bypass | Admin's office | Corrected office | Admin redirect (misroute correction) |

### Migration File Naming

```
2025_11_XX_000300_create_transaction_actions_table.php
2025_11_XX_000400_add_transaction_tracking_columns.php
```

### Reference Files

- Transaction model: `app/Models/Transaction.php`
- Workflow models: Story 3.1
- Action Taken repository: Story 1.6
- Audit requirements: PRD NFR4

### Story Dependencies

**Depends on**:
- Story 3.1 (Workflow Schema & Model Foundation) - for workflow_step_id FK
- Story 2.1 (Database Schema) - for transactions table
- Story 1.6 (Action Taken Repository) - for action_taken_id FK

**Blocks**:
- Story 3.4 (Endorse Action Implementation)
- Story 3.5 (Receive Action Implementation)
- Story 3.6 (Complete Action Implementation)
- Story 3.8 (Out-of-Workflow Detection)
- Story 3.10 (Timeline Visualization)

---

## Tasks

### Task 1: Create Transaction Actions Migration
**Estimate**: 30 minutes
- Create migration file for `transaction_actions` table
- Define all columns per AC#1
- Add foreign key constraints with ON DELETE RESTRICT
- Add indexes on key columns
- Define `down()` method

**Verification**:
```bash
php artisan migrate --pretend
```

### Task 2: Create Transaction Tracking Columns Migration
**Estimate**: 20 minutes
- Create migration to alter `transactions` table
- Add `current_step_id` (FK to workflow_steps)
- Add `received_at` (timestamp, nullable)
- Add `endorsed_at` (timestamp, nullable)
- Add indexes
- Define `down()` method

**Verification**:
```bash
php artisan migrate --pretend
```

### Task 3: Create TransactionAction Model
**Estimate**: 45 minutes
- Create `app/Models/TransactionAction.php`
- Define fillable array with all columns
- Define casts for boolean and datetime fields
- Implement all relationships (7 total)
- Implement scopes: `ofType`, `outOfWorkflow`, `forTransaction`, `byOffice`
- Define action type constants
- Add PHPDoc comments

**Verification**:
```bash
php artisan tinker
# Test relationships and scopes
```

### Task 4: Update Transaction Model
**Estimate**: 30 minutes
- Update `app/Models/Transaction.php`
- Add `hasMany(TransactionAction::class)` relationship
- Add `belongsTo(WorkflowStep::class, 'current_step_id')` relationship
- Add `current_step_id`, `received_at`, `endorsed_at` to fillable
- Add datetime casts for new timestamp fields
- Implement accessors: `actionsHistory`, `lastAction`, `currentHolder`
- Implement methods: `isAtStep()`, `hasBeenReceivedByCurrentOffice()`

**Verification**:
```bash
php artisan tinker
# Test: Transaction::first()->actions
```

### Task 5: Create Model Factory
**Estimate**: 25 minutes
- Create `database/factories/TransactionActionFactory.php`
- Generate realistic action data
- Handle nullable fields appropriately
- Create state methods for each action type (e.g., `->endorse()`, `->receive()`)

**Verification**:
```bash
php artisan tinker
# Test: TransactionAction::factory()->endorse()->create()
```

### Task 6: Update Database Seeder
**Estimate**: 40 minutes
- Update or create seeder for transaction actions
- Create sample endorsement chains for existing transactions
- Include examples of all action types
- Include some out-of-workflow examples
- Ensure realistic from/to office progressions

**Verification**:
```bash
php artisan db:seed
```

### Task 7: Add TypeScript Interfaces
**Estimate**: 15 minutes
- Update `resources/js/types/models.ts`
- Add `ActionType` type union
- Add `TransactionAction` interface with all fields
- Update `Transaction` interface with new fields and relationships

**Verification**:
```bash
npm run build
```

### Task 8: Write Feature Tests
**Estimate**: 1 hour
- Create `tests/Feature/Models/TransactionActionTest.php`:
  - Test action-transaction relationship
  - Test action-office relationships (from/to)
  - Test action-user relationships (from/to)
  - Test action-workflow_step relationship
  - Test all scopes
  - Test is_out_of_workflow filtering
- Create `tests/Feature/Models/TransactionActionsIntegrationTest.php`:
  - Test Transaction->actions relationship
  - Test actionsHistory accessor ordering
  - Test lastAction accessor
  - Test currentHolder accessor

**Verification**:
```bash
php artisan test --filter=TransactionAction
```

### Task 9: Run Migrations and Verify
**Estimate**: 15 minutes
- Run migrations: `php artisan migrate`
- Run seeders: `php artisan db:seed`
- Verify relationships in tinker
- Run full test suite

**Verification**:
```bash
php artisan migrate:fresh --seed
php artisan test
```

---

## Acceptance Checklist

- [ ] transaction_actions table created with all columns
- [ ] All foreign key constraints properly defined
- [ ] Indexes added on key query columns
- [ ] transactions table enhanced with tracking columns
- [ ] TransactionAction model implements all relationships
- [ ] TransactionAction model implements all scopes
- [ ] Action type constants defined
- [ ] Transaction model updated with new relationships and accessors
- [ ] Model factory generates valid test data
- [ ] Seeder creates realistic action chains
- [ ] TypeScript interfaces match database schema
- [ ] Feature tests cover relationships and scopes
- [ ] All existing tests continue to pass
- [ ] Migration rollbacks work correctly

**Definition of Done**: Transaction actions can be recorded and queried with full relationship support, scopes work correctly, and the foundation is ready for action implementation stories.

---

## Dev Agent Record

**Story**: 3.3 - Transaction Actions Schema & Models
**Status**: Draft
**Assigned**:
**Start Date**:
**Completion Date**:

### Files Created
- [ ] `database/migrations/YYYY_MM_DD_HHMMSS_create_transaction_actions_table.php`
- [ ] `database/migrations/YYYY_MM_DD_HHMMSS_add_transaction_tracking_columns.php`
- [ ] `app/Models/TransactionAction.php`
- [ ] `database/factories/TransactionActionFactory.php`
- [ ] `tests/Feature/Models/TransactionActionTest.php`
- [ ] `tests/Feature/Models/TransactionActionsIntegrationTest.php`

### Files Modified
- [ ] `app/Models/Transaction.php`
- [ ] `database/seeders/TransactionSeeder.php` (or new seeder)
- [ ] `resources/js/types/models.ts`

### Test Results
- [ ] Migration tests: X passing
- [ ] Model tests: X passing
- [ ] All project tests: X passing

### Implementation Notes
*(To be filled by dev agent)*

### Time Log
*(To be filled by dev agent)*

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
