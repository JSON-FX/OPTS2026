# Story 3.7: Transaction State Machine

**Status**: Done
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As a developer, I need a robust state machine governing transaction status transitions with validation rules, so that transactions progress through valid states only and all transitions are properly logged.

---

## Acceptance Criteria

1. **State Machine Definition**: Implement a state machine for Transaction status with:
   - States: `Created`, `In Progress`, `Completed`, `On Hold`, `Cancelled`
   - Valid transitions defined and enforced:
     ```
     Created → In Progress (on first endorsement)
     In Progress → Completed (on complete action at final step)
     In Progress → On Hold (admin action with reason)
     In Progress → Cancelled (admin action with reason)
     On Hold → In Progress (admin resume action)
     On Hold → Cancelled (admin action with reason)
     ```
   - Invalid transitions throw exceptions

2. **Automatic Status Transitions**: System automatically transitions status:
   - `Created → In Progress`: When transaction receives first endorsement
   - `In Progress → Completed`: When complete action performed at final step

3. **Admin Hold/Cancel Actions**: Administrators can:
   - Place transaction "On Hold" from "In Progress" status
     - Required reason field
     - Creates transaction_action with type 'hold'
     - Creates status history record
   - Cancel transaction from "In Progress" or "On Hold" status
     - Required reason field
     - Creates transaction_action with type 'cancel'
     - Creates status history record
     - Terminal state (no further actions)
   - Resume transaction from "On Hold" back to "In Progress"
     - Creates status history record
     - Transaction resumes at same workflow step

4. **Hold/Cancel UI**: On Transaction Detail page (Admin only):
   - "Hold" button visible when status is "In Progress"
   - "Cancel" button visible when status is "In Progress" or "On Hold"
   - "Resume" button visible when status is "On Hold"
   - Each action opens modal with:
     - Reason field (required)
     - Confirmation button
   - Success toast on action completion

5. **Status Display Enhancement**:
   - Status badges with appropriate colors:
     - Created: Gray
     - In Progress: Blue
     - Completed: Green
     - On Hold: Yellow/Amber
     - Cancelled: Red
   - Status change history visible on transaction detail
   - Current status prominently displayed

6. **State Machine Service**: `app/Services/TransactionStateMachine.php`:
   - `canTransitionTo($status)`: Check if transition is valid
   - `transitionTo($status, $reason)`: Perform transition with logging
   - `getAvailableTransitions()`: Return list of valid next states
   - Throws `InvalidStateTransitionException` on invalid attempts

7. **Status History Display**: Transaction detail shows:
   - Timeline of status changes
   - Each entry shows: old status → new status, reason (if any), user, timestamp
   - Integrated with action history or separate section

8. **Validation Rules Enforcement**:
   - Cannot endorse/receive/complete held or cancelled transactions
   - Cannot hold/cancel completed transactions
   - Status checks integrated into all action methods

---

## Dev Notes

### State Transition Diagram

```
                    ┌──────────────┐
                    │   Created    │
                    └──────┬───────┘
                           │ First endorsement
                           ▼
    ┌──────────────────────────────────────────────┐
    │              In Progress                      │
    │  (normal workflow: endorse → receive → ...)   │
    └──────┬────────────────┬──────────────┬───────┘
           │                │              │
     Admin │ Hold    Admin │ Cancel   Complete │ (at final step)
           ▼                │              ▼
    ┌──────────────┐        │       ┌──────────────┐
    │   On Hold    │        │       │  Completed   │
    │              │◄───────┼───────│  (terminal)  │
    └──────┬───────┘        │       └──────────────┘
           │                │
     Admin │ Resume         │
           │                │
           └────────────────┤
                     Admin  │ Cancel
                            ▼
                     ┌──────────────┐
                     │  Cancelled   │
                     │  (terminal)  │
                     └──────────────┘
```

### State Machine Implementation

```php
// app/Services/TransactionStateMachine.php
class TransactionStateMachine
{
    protected array $transitions = [
        'Created' => ['In Progress'],
        'In Progress' => ['Completed', 'On Hold', 'Cancelled'],
        'On Hold' => ['In Progress', 'Cancelled'],
        'Completed' => [], // Terminal
        'Cancelled' => [], // Terminal
    ];

    public function __construct(
        protected Transaction $transaction
    ) {}

    public function canTransitionTo(string $newStatus): bool
    {
        $currentStatus = $this->transaction->status;
        return in_array($newStatus, $this->transitions[$currentStatus] ?? []);
    }

    public function transitionTo(string $newStatus, ?string $reason = null, ?User $user = null): void
    {
        if (!$this->canTransitionTo($newStatus)) {
            throw new InvalidStateTransitionException(
                "Cannot transition from {$this->transaction->status} to {$newStatus}"
            );
        }

        $oldStatus = $this->transaction->status;
        $user = $user ?? auth()->user();

        DB::transaction(function () use ($newStatus, $oldStatus, $reason, $user) {
            $this->transaction->update(['status' => $newStatus]);

            TransactionStatusHistory::create([
                'transaction_id' => $this->transaction->id,
                'old_status' => $oldStatus,
                'new_status' => $newStatus,
                'reason' => $reason,
                'changed_by_user_id' => $user->id,
            ]);
        });
    }

    public function getAvailableTransitions(): array
    {
        return $this->transitions[$this->transaction->status] ?? [];
    }

    public function isTerminal(): bool
    {
        return empty($this->getAvailableTransitions());
    }
}
```

### Hold/Cancel/Resume Actions in EndorsementService

```php
// Add to EndorsementService
public function hold(Transaction $transaction, User $user, string $reason): TransactionAction
{
    return DB::transaction(function () use ($transaction, $user, $reason) {
        $stateMachine = new TransactionStateMachine($transaction);
        $stateMachine->transitionTo('On Hold', $reason, $user);

        return TransactionAction::create([
            'transaction_id' => $transaction->id,
            'action_type' => TransactionAction::TYPE_HOLD,
            'from_office_id' => $user->office_id,
            'from_user_id' => $user->id,
            'reason' => $reason,
            'ip_address' => request()->ip(),
        ]);
    });
}

public function cancel(Transaction $transaction, User $user, string $reason): TransactionAction
{
    return DB::transaction(function () use ($transaction, $user, $reason) {
        $stateMachine = new TransactionStateMachine($transaction);
        $stateMachine->transitionTo('Cancelled', $reason, $user);

        return TransactionAction::create([
            'transaction_id' => $transaction->id,
            'action_type' => TransactionAction::TYPE_CANCEL,
            'from_office_id' => $user->office_id,
            'from_user_id' => $user->id,
            'reason' => $reason,
            'ip_address' => request()->ip(),
        ]);
    });
}

public function resume(Transaction $transaction, User $user, ?string $reason = null): void
{
    $stateMachine = new TransactionStateMachine($transaction);
    $stateMachine->transitionTo('In Progress', $reason ?? 'Resumed by administrator', $user);
}
```

### Integration with Existing Actions

```php
// In endorse() method, add status transition check
public function endorse(Transaction $transaction, ...): TransactionAction
{
    // Verify transaction is in valid state for endorsement
    if (!in_array($transaction->status, ['Created', 'In Progress'])) {
        throw new InvalidOperationException(
            "Cannot endorse transaction with status: {$transaction->status}"
        );
    }

    // ... existing endorsement logic ...

    // If first endorsement, transition from Created to In Progress
    if ($transaction->status === 'Created') {
        $stateMachine = new TransactionStateMachine($transaction);
        $stateMachine->transitionTo('In Progress', 'First endorsement', $user);
    }

    // ... rest of method ...
}
```

### Status Badge Colors (Tailwind)

```typescript
const statusColors: Record<TransactionStatus, string> = {
  'Created': 'bg-gray-100 text-gray-800',
  'In Progress': 'bg-blue-100 text-blue-800',
  'Completed': 'bg-green-100 text-green-800',
  'On Hold': 'bg-yellow-100 text-yellow-800',
  'Cancelled': 'bg-red-100 text-red-800',
};
```

### Reference Files

- EndorsementService: Stories 3.4, 3.5, 3.6
- Transaction model: Story 2.1
- TransactionStatusHistory: Story 2.1
- Transaction detail page: Story 2.9

### Story Dependencies

**Depends on**:
- Story 3.4 (Endorse Action) - integrates state machine
- Story 3.5 (Receive Action) - integrates state machine
- Story 3.6 (Complete Action) - integrates state machine
- Story 3.3 (Transaction Actions Schema) - for hold/cancel action recording

**Blocks**:
- None (but improves robustness of all transaction operations)

---

## Tasks

### Task 1: Create State Machine Service
**Estimate**: 1 hour
- Create `app/Services/TransactionStateMachine.php`
- Define state transition rules
- Implement `canTransitionTo()` method
- Implement `transitionTo()` method with history logging
- Implement `getAvailableTransitions()` method
- Implement `isTerminal()` method
- Create `InvalidStateTransitionException`

**Verification**: Test state machine in tinker

### Task 2: Add Hold/Cancel/Resume to EndorsementService
**Estimate**: 45 minutes
- Add `hold()` method
- Add `cancel()` method
- Add `resume()` method
- Add authorization checks (`canHold`, `canCancel`, `canResume`)

**Verification**: Service methods work in tinker

### Task 3: Integrate State Machine with Existing Actions
**Estimate**: 30 minutes
- Update `endorse()` to check valid states and auto-transition Created → In Progress
- Update `receive()` to check valid states
- Update `complete()` to use state machine for status change
- Add status checks to prevent actions on held/cancelled transactions

**Verification**: Actions respect state rules

### Task 4: Create Hold/Cancel/Resume Controllers
**Estimate**: 45 minutes
- Create `app/Http/Controllers/TransactionHoldController.php`
- Create `app/Http/Controllers/TransactionCancelController.php`
- Create Form Request classes for reason validation
- Implement store methods for each action

**Verification**: Routes respond correctly

### Task 5: Add Routes
**Estimate**: 10 minutes
- Add routes:
  - `POST /transactions/{transaction}/hold`
  - `POST /transactions/{transaction}/cancel`
  - `POST /transactions/{transaction}/resume`
- Apply auth and Administrator role middleware

**Verification**: Routes registered

### Task 6: Create Admin Action Modals
**Estimate**: 1 hour
- Create `resources/js/Components/HoldTransactionModal.tsx`
- Create `resources/js/Components/CancelTransactionModal.tsx`
- Create `resources/js/Components/ResumeTransactionModal.tsx`
- Each with reason field (required for hold/cancel)
- Confirmation buttons

**Verification**: Modals render and submit correctly

### Task 7: Update Transaction Detail Page
**Estimate**: 45 minutes
- Add Hold/Cancel/Resume buttons (Admin only)
- Conditional visibility based on current status
- Integrate modals
- Update status badge with colors
- Add status history section/timeline

**Verification**: Buttons show/hide correctly, status displays properly

### Task 8: Create Status Badge Component
**Estimate**: 20 minutes
- Create `resources/js/Components/StatusBadge.tsx`
- Configurable for Transaction and Procurement statuses
- Color-coded per status

**Verification**: Badge renders with correct colors

### Task 9: Write State Machine Unit Tests
**Estimate**: 1 hour
- Create `tests/Unit/Services/TransactionStateMachineTest.php`:
  - Test valid transitions succeed
  - Test invalid transitions throw exception
  - Test getAvailableTransitions returns correct states
  - Test isTerminal for Completed and Cancelled
  - Test status history created on transition

**Verification**:
```bash
php artisan test --filter=TransactionStateMachine
```

### Task 10: Write Feature Tests
**Estimate**: 1 hour
- Create `tests/Feature/TransactionStateTest.php`:
  - Test hold action creates action and changes status
  - Test cancel action creates action and changes status
  - Test resume action changes status back to In Progress
  - Test cannot endorse held transaction
  - Test cannot endorse cancelled transaction
  - Test cannot hold completed transaction
  - Test auto-transition Created → In Progress on first endorsement

**Verification**:
```bash
php artisan test --filter=TransactionState
```

---

## Acceptance Checklist

- [ ] State machine defines all valid transitions
- [ ] Invalid transitions throw descriptive exceptions
- [ ] Created → In Progress auto-transitions on first endorsement
- [ ] In Progress → Completed transitions on complete action
- [ ] Admin can hold In Progress transactions with reason
- [ ] Admin can cancel In Progress or On Hold transactions with reason
- [ ] Admin can resume On Hold transactions
- [ ] Hold/Cancel/Resume create appropriate action records
- [ ] Status history records created for all transitions
- [ ] Cannot endorse/receive/complete held or cancelled transactions
- [ ] Status badges display with correct colors
- [ ] Status history visible on transaction detail
- [ ] Admin action buttons show/hide based on role and status
- [ ] Unit tests pass for state machine
- [ ] Feature tests pass for state transitions

**Definition of Done**: Transaction status transitions are governed by a robust state machine, admin hold/cancel/resume actions work correctly, and all transitions are properly logged with reasons.

---

## Dev Agent Record

**Story**: 3.7 - Transaction State Machine
**Status**: Ready for review
**Assigned**: Dev Agent
**Start Date**: 2026-02-09
**Completion Date**: 2026-02-09

### Files Created
- [x] `app/Services/TransactionStateMachine.php`
- [x] `app/Exceptions/InvalidStateTransitionException.php`
- [x] `app/Http/Controllers/TransactionHoldController.php`
- [x] `app/Http/Controllers/TransactionCancelController.php`
- [x] `app/Http/Controllers/TransactionResumeController.php`
- [x] `app/Http/Requests/HoldTransactionRequest.php`
- [x] `app/Http/Requests/CancelTransactionRequest.php`
- [x] `resources/js/Components/HoldTransactionModal.tsx`
- [x] `resources/js/Components/CancelTransactionModal.tsx`
- [x] `resources/js/Components/ResumeTransactionModal.tsx`
- [x] `resources/js/Components/StatusBadge.tsx` (already existed with correct implementation)
- [x] `tests/Unit/Services/TransactionStateMachineTest.php`
- [x] `tests/Feature/TransactionStateTest.php`

### Files Modified
- [x] `app/Services/EndorsementService.php` - Added hold/cancel/resume methods, integrated state machine with endorse/complete
- [x] `routes/web.php` - Added hold/cancel/resume routes in Administrator middleware group
- [x] `resources/js/Pages/PurchaseRequests/Show.tsx` - Added admin action buttons (Hold/Cancel/Resume), StatusBadge, hide workflow buttons for terminal states
- [x] `app/Http/Controllers/PurchaseRequestController.php` - Added canHold/canCancel/canResume props

### Test Results
- [x] Unit tests: 27 passing (34 assertions) - TransactionStateMachineTest
- [x] Feature tests: 28 passing (55 assertions) - TransactionStateTest
- [x] TypeScript: Compiles cleanly
- [x] Playwright E2E tests: `tests/e2e/state-machine.spec.ts` created

### Implementation Notes
- TransactionStateMachine defines valid transitions map and enforces them with InvalidStateTransitionException
- Terminal states: Completed and Cancelled (no further transitions allowed)
- endorse() auto-transitions Created -> In Progress on first endorsement
- complete() uses state machine instead of direct status update
- Hold/Cancel require Administrator role only (not Endorser)
- Cancel allowed from both "In Progress" and "On Hold"
- Resume only creates status history (no TransactionAction record, just state transition)
- StatusBadge component was already implemented with correct color mappings
- Fixed pre-existing JSX syntax error in PurchaseRequests/Show.tsx (missing closing brace)
- PO and VCH show pages do not yet have admin action buttons (scope limited to PR show page)

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
