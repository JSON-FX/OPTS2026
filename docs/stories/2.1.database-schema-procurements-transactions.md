# Story 2.1: Database Schema - Procurements & Transactions Tables

**Status**: Draft
**Epic**: Epic 2 - Procurement & Transaction Lifecycle
**Story Statement**: As a developer, I need database tables for procurements and transactions (PR/PO/VCH) so that the system can store and manage procurement records throughout their lifecycle.

---

## Acceptance Criteria

1. **Procurements Table Migration**: Migration created for `procurements` table with columns:
   - `id` (primary key, auto-increment)
   - `end_user_id` (foreign key to offices)
   - `particular_id` (foreign key to particulars)
   - `purpose` (text, nullable)
   - `abc_amount` (decimal 15,2, unsigned)
   - `date_of_entry` (date)
   - `status` (enum: Created, In Progress, Completed, On Hold, Cancelled, default: Created)
   - `created_by_user_id` (foreign key to users)
   - `created_at`, `updated_at`, `deleted_at` (soft deletes)
   - Foreign key constraints with ON DELETE RESTRICT
   - Index on `status` and `date_of_entry`

2. **Transactions Table Migration**: Migration created for `transactions` table with columns:
   - `id` (primary key, auto-increment)
   - `procurement_id` (foreign key to procurements)
   - `category` (enum: PR, PO, VCH)
   - `reference_number` (string 50, unique, indexed)
   - `status` (enum: Created, In Progress, Completed, On Hold, Cancelled, default: Created)
   - `workflow_id` (foreign key to workflows, nullable - Epic 3)
   - `current_office_id` (foreign key to offices, nullable)
   - `current_user_id` (foreign key to users, nullable)
   - `created_by_user_id` (foreign key to users)
   - `created_at`, `updated_at`, `deleted_at` (soft deletes)
   - Foreign key constraints with ON DELETE RESTRICT
   - Unique index on `reference_number`
   - Index on `procurement_id`, `category`, `status`

3. **Purchase Requests Table Migration**: Migration created for `purchase_requests` table with columns:
   - `id` (primary key, auto-increment)
   - `transaction_id` (foreign key to transactions, unique)
   - `supplier_id` (foreign key to suppliers)
   - `purpose` (text)
   - `estimated_budget` (decimal 15,2, unsigned)
   - `date_of_pr` (date)
   - `created_at`, `updated_at`
   - Foreign key constraint with ON DELETE RESTRICT

4. **Purchase Orders Table Migration**: Migration created for `purchase_orders` table with columns:
   - `id` (primary key, auto-increment)
   - `transaction_id` (foreign key to transactions, unique)
   - `supplier_id` (foreign key to suppliers)
   - `supplier_address` (text - immutable snapshot)
   - `purchase_request_id` (foreign key to purchase_requests - denormalized parent reference)
   - `particulars` (text - snapshot from procurement)
   - `fund_type_id` (foreign key to fund_types)
   - `total_cost` (decimal 15,2, unsigned)
   - `date_of_po` (date)
   - `delivery_date` (date, nullable)
   - `delivery_term` (integer, nullable - days)
   - `payment_term` (integer, nullable - days)
   - `amount_in_words` (text)
   - `mode_of_procurement` (string 100)
   - `created_at`, `updated_at`
   - Foreign key constraints with ON DELETE RESTRICT

5. **Vouchers Table Migration**: Migration created for `vouchers` table with columns:
   - `id` (primary key, auto-increment)
   - `transaction_id` (foreign key to transactions, unique)
   - `purchase_order_id` (foreign key to purchase_orders - denormalized parent reference)
   - `supplier_id` (foreign key to suppliers)
   - `obr_number` (string 50, nullable)
   - `particulars` (text - snapshot from procurement)
   - `gross_amount` (decimal 15,2, unsigned)
   - `created_at`, `updated_at`
   - Foreign key constraints with ON DELETE RESTRICT

6. **Procurement Status History Table Migration**: Migration created for `procurement_status_history` table with columns:
   - `id` (primary key, auto-increment)
   - `procurement_id` (foreign key to procurements)
   - `old_status` (enum: Created, In Progress, Completed, On Hold, Cancelled, nullable)
   - `new_status` (enum: Created, In Progress, Completed, On Hold, Cancelled)
   - `reason` (text, nullable)
   - `changed_by_user_id` (foreign key to users)
   - `created_at`
   - Foreign key constraints with ON DELETE CASCADE
   - Index on `procurement_id` and `created_at`

7. **Transaction Status History Table Migration**: Migration created for `transaction_status_history` table with columns:
   - `id` (primary key, auto-increment)
   - `transaction_id` (foreign key to transactions)
   - `old_status` (enum: Created, In Progress, Completed, On Hold, Cancelled, nullable)
   - `new_status` (enum: Created, In Progress, Completed, On Hold, Cancelled)
   - `reason` (text, nullable)
   - `changed_by_user_id` (foreign key to users)
   - `created_at`
   - Foreign key constraints with ON DELETE CASCADE
   - Index on `transaction_id` and `created_at`

8. **Reference Sequences Table Migration**: Migration created for `reference_sequences` table with columns:
   - `id` (primary key, auto-increment)
   - `category` (enum: PR, PO, VCH, unique)
   - `year` (integer, unsigned)
   - `last_sequence` (integer, unsigned, default: 0)
   - `created_at`, `updated_at`
   - Unique index on (`category`, `year`)

9. **Foreign Key Constraints**: All foreign key constraints implemented with ON DELETE RESTRICT for referential integrity (except history tables use CASCADE)

10. **Soft Deletes**: Eloquent SoftDeletes trait configured for procurements and transactions tables (not type-specific tables)

11. **Database Indexes**: Performance indexes created on:
    - `procurements.status`, `procurements.date_of_entry`
    - `transactions.procurement_id`, `transactions.category`, `transactions.status`, `transactions.reference_number` (unique)
    - `procurement_status_history.procurement_id`, `procurement_status_history.created_at`
    - `transaction_status_history.transaction_id`, `transaction_status_history.created_at`
    - `reference_sequences.category`, `reference_sequences.year` (unique)

12. **Enum Consistency**: Status enum values identical across procurements, transactions, and history tables: Created, In Progress, Completed, On Hold, Cancelled

13. **Migration Rollback**: Each migration includes proper `down()` method with DROP TABLE and DROP INDEX statements

14. **Test Coverage**: Migration tests verify table structure, foreign key constraints, and indexes

15. **Development Seeders**: Seeder classes created for sample procurement and transaction data (10 procurements, 20 transactions with mix of PR/PO/VCH)

16. **Documentation**: Migration files include comments explaining database relationship pattern and business rules

---

## Dev Notes

### Database Relationship Pattern

**CRITICAL**: This story implements a specific database relationship pattern that must be followed consistently:

- **Single `transactions` table** stores ALL transaction types (PR, PO, VCH) differentiated by `category` enum field
- **Separate type-specific tables** (`purchase_requests`, `purchase_orders`, `vouchers`) contain additional fields specific to each transaction type
- **Foreign key relationship**: Type-specific tables have `transaction_id` (FK to `transactions.id`, unique constraint)
- **Laravel models**:
  - `Transaction` base model with relationship: `hasOne(PurchaseRequest|PurchaseOrder|Voucher)`
  - `PurchaseRequest`, `PurchaseOrder`, `Voucher` models with relationship: `belongsTo(Transaction)`
  - Each type-specific model can access transaction fields via `$pr->transaction->reference_number`

**Why this pattern?**
- Unified reference number generation across all transaction types
- Consistent workflow/status tracking regardless of type
- Simplified procurement → transactions relationship (one-to-many from procurements)
- Type-specific fields isolated in separate tables (e.g., PO has delivery_date, VCH has obr_number)

### Migration File Locations

All migrations for this story should be created in `database/migrations/` with timestamp prefix `2025_10_31_HHMMSS_`:

1. `create_procurements_table.php`
2. `create_transactions_table.php`
3. `create_purchase_requests_table.php`
4. `create_purchase_orders_table.php`
5. `create_vouchers_table.php`
6. `create_procurement_status_history_table.php`
7. `create_transaction_status_history_table.php`
8. `create_reference_sequences_table.php`

**Order matters**: Execute migrations in the order listed above due to foreign key dependencies.

### Field-Specific Notes

**Decimal Precision**: All monetary fields use `decimal(15,2)` for 13 integer digits + 2 decimal places (supports up to ₱9,999,999,999.99)

**Soft Deletes**: Only `procurements` and `transactions` tables use soft deletes (type-specific tables do not, since they depend on transactions)

**Nullable Fields**:
- `transactions.workflow_id` - Epic 3 will populate this
- `transactions.current_office_id`, `transactions.current_user_id` - null when no workflow active
- `purchase_orders.delivery_date`, `delivery_term`, `payment_term` - optional fields
- `vouchers.obr_number` - optional field
- History tables: `old_status` is null for initial record creation

**Immutable Snapshots**:
- `purchase_orders.supplier_address` - captured at PO creation time, does not update if supplier changes
- `purchase_orders.particulars`, `vouchers.particulars` - snapshot from `procurements.particular_id` name at transaction creation

**Denormalized Parent References**:
- `purchase_orders.purchase_request_id` - redundant FK for quick lookup (can also traverse via `transactions.procurement_id`)
- `vouchers.purchase_order_id` - redundant FK for quick lookup

### Testing Strategy

From Story 1.2 (Database Schema for Repositories) pattern:
- Migration tests: Verify table existence, column types, foreign keys, indexes
- Rollback tests: Ensure `down()` methods work correctly
- Constraint tests: Verify ON DELETE RESTRICT prevents orphaned records
- Seeder tests: Ensure sample data adheres to business rules (e.g., PO must reference existing PR)

### Reference Files

- **Previous migration pattern**: Story 1.2 created offices, suppliers, particulars, fund_types, action_taken tables (see `database/migrations/2025_10_30_*`)
- **TypeScript interfaces**: `docs/architecture/data-models.md` defines Procurement, Transaction, PR/PO/VCH interfaces
- **Tech stack**: MySQL 8.0+, Eloquent ORM (see `docs/architecture/tech-stack.md`)

### Story Dependencies

**Depends on**: Story 1.2 (Database Schema for Repositories) - requires existing tables: offices, suppliers, particulars, fund_types, users

**Blocks**:
- Story 2.2 (Reference Number Generation Service) - requires `reference_sequences` table
- Story 2.3 (Procurement CRUD Operations) - requires `procurements` table
- Story 2.4 (Transaction Dependencies & Business Rule Validation) - requires all tables

---

## Tasks

### Task 1: Create Procurements Migration
**Estimate**: 30 minutes
- Create migration file `database/migrations/2025_10_31_120000_create_procurements_table.php`
- Define `up()` method with Schema::create for procurements table
- Add all columns per AC#1 with correct types, constraints
- Add foreign key constraints to offices, particulars, users (ON DELETE RESTRICT)
- Add indexes on status, date_of_entry
- Define `down()` method with Schema::dropIfExists
- Add docblock comment explaining procurement entity purpose

**Verification**:
```bash
php artisan migrate --pretend # Check SQL output
```

### Task 2: Create Transactions Migration
**Estimate**: 35 minutes
- Create migration file `database/migrations/2025_10_31_120100_create_transactions_table.php`
- Define `up()` method with Schema::create for transactions table
- Add all columns per AC#2 with correct types, constraints
- Add foreign key constraints to procurements, workflows, offices, users (ON DELETE RESTRICT)
- Add unique index on reference_number
- Add composite indexes on (procurement_id, category, status)
- Define `down()` method with Schema::dropIfExists
- Add docblock comment explaining database relationship pattern

**Verification**:
```bash
php artisan migrate --pretend
```

### Task 3: Create Type-Specific Tables Migrations
**Estimate**: 1.5 hours
- Create migration file `database/migrations/2025_10_31_120200_create_purchase_requests_table.php` per AC#3
- Create migration file `database/migrations/2025_10_31_120300_create_purchase_orders_table.php` per AC#4
- Create migration file `database/migrations/2025_10_31_120400_create_vouchers_table.php` per AC#5
- Each migration:
  - Define `up()` method with Schema::create
  - Add `transaction_id` FK with UNIQUE constraint
  - Add all type-specific columns with correct types
  - Add foreign key constraints with ON DELETE RESTRICT
  - Define `down()` method with Schema::dropIfExists
  - Add docblock comment explaining type-specific fields

**Verification**:
```bash
php artisan migrate --pretend
```

### Task 4: Create Status History Migrations
**Estimate**: 45 minutes
- Create migration file `database/migrations/2025_10_31_120500_create_procurement_status_history_table.php` per AC#6
- Create migration file `database/migrations/2025_10_31_120600_create_transaction_status_history_table.php` per AC#7
- Each migration:
  - Define `up()` method with Schema::create
  - Add columns for old_status, new_status, reason, changed_by_user_id, created_at
  - Add foreign key constraints with ON DELETE CASCADE
  - Add composite indexes on (entity_id, created_at)
  - Define `down()` method with Schema::dropIfExists
  - Add docblock comment explaining audit trail purpose

**Verification**:
```bash
php artisan migrate --pretend
```

### Task 5: Create Reference Sequences Migration
**Estimate**: 20 minutes
- Create migration file `database/migrations/2025_10_31_120700_create_reference_sequences_table.php` per AC#8
- Define `up()` method with Schema::create
- Add columns: category (enum), year (integer), last_sequence (integer default 0)
- Add unique index on (category, year)
- Define `down()` method with Schema::dropIfExists
- Add docblock comment explaining atomic sequence generation purpose

**Verification**:
```bash
php artisan migrate --pretend
```

### Task 6: Create Development Seeders
**Estimate**: 1 hour
- Create `database/seeders/ProcurementSeeder.php`:
  - Generate 10 procurements with varied statuses (Created, In Progress, Completed)
  - Use existing offices, particulars, users from Story 1.2 seeders
  - Set realistic abc_amount values (₱5,000 to ₱500,000)
  - Set date_of_entry within last 90 days
- Create `database/seeders/TransactionSeeder.php`:
  - Generate 20 transactions linked to procurements
  - Mix of PR, PO, VCH categories
  - Ensure PR → PO → VCH dependencies are logical (VCH references PO, PO references PR)
  - Generate reference numbers manually (Story 2.2 will automate this)
  - Populate type-specific tables with sample data
- Update `database/seeders/DatabaseSeeder.php` to call new seeders

**Verification**:
```bash
php artisan db:seed --class=ProcurementSeeder
php artisan db:seed --class=TransactionSeeder
```

### Task 7: Write Migration Tests
**Estimate**: 1.5 hours
- Create `tests/Feature/Migrations/ProcurementsTableTest.php`:
  - Test table exists after migration
  - Test column types and constraints
  - Test foreign key constraints (ON DELETE RESTRICT)
  - Test indexes on status, date_of_entry
  - Test soft deletes column exists
  - Test rollback drops table
- Create `tests/Feature/Migrations/TransactionsTableTest.php`:
  - Test table exists, column types, constraints
  - Test foreign key constraints
  - Test unique index on reference_number
  - Test composite indexes
  - Test soft deletes column exists
  - Test rollback drops table
- Create `tests/Feature/Migrations/TypeSpecificTablesTest.php`:
  - Test purchase_requests, purchase_orders, vouchers tables exist
  - Test unique constraint on transaction_id
  - Test foreign key constraints
- Create `tests/Feature/Migrations/StatusHistoryTablesTest.php`:
  - Test history tables exist
  - Test foreign key CASCADE delete behavior
  - Test composite indexes
- Create `tests/Feature/Migrations/ReferenceSequencesTableTest.php`:
  - Test table exists, unique constraint on (category, year)

**Verification**:
```bash
php artisan test --filter=Migrations
```

### Task 8: Run Migrations and Verify
**Estimate**: 15 minutes
- Run migrations: `php artisan migrate`
- Verify tables created: `php artisan db:show`
- Inspect table structure: `php artisan schema:dump`
- Run seeders: `php artisan db:seed`
- Verify foreign key constraints with invalid data attempts
- Test rollback: `php artisan migrate:rollback` then re-migrate

**Verification**:
```bash
php artisan migrate:fresh --seed
php artisan test # All tests should pass
```

### Task 9: Update TypeScript Interfaces (if needed)
**Estimate**: 15 minutes
- Verify `resources/js/types/index.d.ts` has interfaces for Procurement, Transaction, PR/PO/VCH
- If interfaces missing, add TypeScript definitions matching database schema
- Ensure status enum types match database enum values
- Add JSDoc comments referencing this story

**Verification**: TypeScript compilation succeeds with `npm run build`

---

## Acceptance Checklist

- [ ] All 8 migration files created with correct schema definitions
- [ ] All foreign key constraints implemented with ON DELETE RESTRICT (except history tables use CASCADE)
- [ ] All indexes created per AC#11
- [ ] Soft deletes enabled on procurements and transactions tables
- [ ] Enum consistency verified across tables
- [ ] Migration rollback methods tested
- [ ] Development seeders generate valid sample data
- [ ] Migration tests pass (table structure, constraints, indexes)
- [ ] Seeder tests pass (valid data, no constraint violations)
- [ ] Documentation added to migration files explaining database relationship pattern
- [ ] TypeScript interfaces match database schema (if applicable)
- [ ] All 99+ existing tests still pass after migrations

**Definition of Done**: All acceptance criteria met, all tests passing, migrations run successfully in fresh database, seeders generate valid sample data demonstrating procurement → transaction relationships with PR/PO/VCH types.

---

## Dev Agent Record

**Story**: 2.1 - Database Schema - Procurements & Transactions Tables
**Status**: Not Started
**Assigned**: [Dev Agent Name]
**Start Date**: [YYYY-MM-DD]
**Completion Date**: [YYYY-MM-DD]

### Files Created
- [ ] `database/migrations/2025_10_31_120000_create_procurements_table.php`
- [ ] `database/migrations/2025_10_31_120100_create_transactions_table.php`
- [ ] `database/migrations/2025_10_31_120200_create_purchase_requests_table.php`
- [ ] `database/migrations/2025_10_31_120300_create_purchase_orders_table.php`
- [ ] `database/migrations/2025_10_31_120400_create_vouchers_table.php`
- [ ] `database/migrations/2025_10_31_120500_create_procurement_status_history_table.php`
- [ ] `database/migrations/2025_10_31_120600_create_transaction_status_history_table.php`
- [ ] `database/migrations/2025_10_31_120700_create_reference_sequences_table.php`
- [ ] `database/seeders/ProcurementSeeder.php`
- [ ] `database/seeders/TransactionSeeder.php`
- [ ] `tests/Feature/Migrations/ProcurementsTableTest.php`
- [ ] `tests/Feature/Migrations/TransactionsTableTest.php`
- [ ] `tests/Feature/Migrations/TypeSpecificTablesTest.php`
- [ ] `tests/Feature/Migrations/StatusHistoryTablesTest.php`
- [ ] `tests/Feature/Migrations/ReferenceSequencesTableTest.php`

### Files Modified
- [ ] `database/seeders/DatabaseSeeder.php` (added ProcurementSeeder, TransactionSeeder)
- [ ] `resources/js/types/index.d.ts` (if TypeScript interfaces needed)

### Test Results
- [ ] Migration tests: X passing
- [ ] All project tests: X passing

### Implementation Notes
[Dev Agent will document key decisions, challenges, and solutions here]

### Time Log
- Task 1 (Procurements Migration): X minutes
- Task 2 (Transactions Migration): X minutes
- Task 3 (Type-Specific Tables): X minutes
- Task 4 (Status History Tables): X minutes
- Task 5 (Reference Sequences): X minutes
- Task 6 (Seeders): X minutes
- Task 7 (Tests): X minutes
- Task 8 (Run & Verify): X minutes
- Task 9 (TypeScript): X minutes

**Total**: X hours

---

## QA Results

[QA Agent will populate this section after review]

**Gate**: [PASS/FAIL/WAIVER]
**Quality Score**: [0-100]
**Reviewer**: [QA Agent Name]
**Review Date**: [YYYY-MM-DD]

### Evidence
- Tests Reviewed: X
- Tests Passed: X
- Coverage: AC [list covered]
- Gaps: [list any gaps]

### Issues Identified
[QA Agent will list any issues found]

### Recommendations
[QA Agent will provide recommendations]
