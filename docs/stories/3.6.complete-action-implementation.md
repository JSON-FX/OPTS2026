# Story 3.6: Complete Action Implementation

**Status**: Done
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As an Endorser or Administrator at the final workflow step, I want to mark a transaction as complete, so that the procurement progresses and the transaction is finalized.

---

## Acceptance Criteria

1. **Complete Button Visibility**: On Transaction Detail page:
   - "Complete" button visible only when:
     - User has Endorser or Administrator role
     - User's office matches transaction's current_office_id
     - Transaction has been received (received_at is not null)
     - Transaction status is "In Progress"
     - Transaction is at the final workflow step (is_final_step = true)
   - Button styled prominently (green/success color)
   - Button disabled with tooltip when conditions not met

2. **Complete Confirmation Modal**: Clicking "Complete" opens confirmation:
   - Transaction summary (reference number, category, procurement)
   - Workflow completion indicator (all steps shown as complete)
   - **Action Taken** (required, dropdown from action_taken repository)
   - **Notes** (optional, textarea)
   - Warning: "This action will mark the transaction as completed and cannot be undone"
   - Confirm button: "Complete Transaction"
   - Cancel button: Closes modal

3. **Complete Action Processing**: On confirmation:
   - Create `transaction_actions` record with:
     - `action_type`: 'complete'
     - `from_office_id`: Current user's office
     - `to_office_id`: null (no next office)
     - `from_user_id`: Current user
     - `action_taken_id`: Selected action
     - `workflow_step_id`: Final workflow step
     - `notes`: Entered notes
     - `ip_address`: Request IP
   - Update transaction:
     - `status`: 'Completed'
   - Log to `transaction_status_history`:
     - `old_status`: 'In Progress'
     - `new_status`: 'Completed'
     - `changed_by_user_id`: Current user
   - Check and update Procurement status if applicable (FR8)

4. **Procurement Status Update (FR8)**: After transaction completion:
   - If transaction is VCH and PR & PO are also Completed:
     - Update Procurement status to "Completed"
     - Log to procurement_status_history
   - If transaction is PR or PO:
     - Procurement remains "In Progress"

5. **Success Feedback**:
   - Success toast: "Transaction completed successfully"
   - If Procurement also completed: "Procurement completed!"
   - Transaction detail shows "Completed" status
   - Complete action appears in action history
   - Endorse/Receive buttons no longer visible

6. **Completed Transaction Behavior**:
   - No further endorsement actions possible
   - Transaction detail shows "Completed" badge
   - Timeline shows all steps completed
   - Action history shows complete action as final entry

7. **Validation & Error Handling**:
   - Server-side validation via Form Request
   - Verify user at final step
   - Prevent completing non-final step transactions
   - Handle concurrent complete attempts

8. **API Endpoint**: `POST /transactions/{id}/complete`
   - Request body: `{ action_taken_id, notes? }`
   - Response: Updated transaction with completed status

---

## Dev Notes

### Complete Flow Concept

```
Transaction at Final Step (e.g., Releasing Office)
  ↓
User clicks "Complete"
  ↓
Confirmation Modal with Action Taken
  ↓
Complete Action Created
  ↓
Transaction Status → "Completed"
  ↓
If VCH and PR+PO Complete → Procurement Status → "Completed"
```

### Procurement Completion Logic (FR8)

```php
// Procurement status transitions:
// Created → In Progress (when first PR created) [Story 2.x]
// In Progress → Completed (when VCH completed AND PR+PO completed)

public function checkAndUpdateProcurementStatus(Transaction $transaction): void
{
    if ($transaction->category !== 'VCH') {
        return; // Only VCH completion can complete Procurement
    }

    $procurement = $transaction->procurement;

    // Check if all three transactions are completed
    $allCompleted = $procurement->transactions()
        ->whereIn('category', ['PR', 'PO', 'VCH'])
        ->where('status', '!=', 'Completed')
        ->doesntExist();

    if ($allCompleted) {
        $oldStatus = $procurement->status;
        $procurement->update(['status' => 'Completed']);

        ProcurementStatusHistory::create([
            'procurement_id' => $procurement->id,
            'old_status' => $oldStatus,
            'new_status' => 'Completed',
            'reason' => 'All transactions (PR, PO, VCH) completed',
            'changed_by_user_id' => auth()->id(),
        ]);
    }
}
```

### Service Layer Pattern

```php
// app/Services/EndorsementService.php (add complete method)
class EndorsementService
{
    public function complete(
        Transaction $transaction,
        User $user,
        int $actionTakenId,
        ?string $notes = null
    ): TransactionAction {
        return DB::transaction(function () use ($transaction, $user, $actionTakenId, $notes) {
            $this->verifyCanComplete($transaction, $user);

            // Create complete action
            $action = TransactionAction::create([
                'transaction_id' => $transaction->id,
                'action_type' => TransactionAction::TYPE_COMPLETE,
                'action_taken_id' => $actionTakenId,
                'from_office_id' => $user->office_id,
                'to_office_id' => null,
                'from_user_id' => $user->id,
                'workflow_step_id' => $transaction->current_step_id,
                'notes' => $notes,
                'ip_address' => request()->ip(),
            ]);

            // Update transaction status
            $oldStatus = $transaction->status;
            $transaction->update(['status' => 'Completed']);

            // Log status change
            TransactionStatusHistory::create([
                'transaction_id' => $transaction->id,
                'old_status' => $oldStatus,
                'new_status' => 'Completed',
                'changed_by_user_id' => $user->id,
            ]);

            // Check procurement completion
            $this->checkAndUpdateProcurementStatus($transaction);

            return $action;
        });
    }

    public function canComplete(Transaction $transaction, User $user): bool
    {
        return $user->hasRole(['Endorser', 'Administrator'])
            && $user->office_id === $transaction->current_office_id
            && $transaction->received_at !== null
            && $transaction->status === 'In Progress'
            && $transaction->currentStep?->is_final_step === true;
    }
}
```

### Controller Implementation

```php
// app/Http/Controllers/TransactionCompleteController.php
class TransactionCompleteController extends Controller
{
    public function store(CompleteTransactionRequest $request, Transaction $transaction)
    {
        $this->authorize('complete', $transaction);

        $action = $this->endorsementService->complete(
            $transaction,
            $request->user(),
            $request->action_taken_id,
            $request->notes
        );

        $message = 'Transaction completed successfully';

        // Check if procurement also completed
        $procurement = $transaction->fresh()->procurement;
        if ($procurement->status === 'Completed') {
            $message .= '. Procurement fully completed!';
        }

        return redirect()
            ->route('transactions.show', $transaction)
            ->with('success', $message);
    }
}
```

### Reference Files

- EndorsementService: Stories 3.4, 3.5
- Transaction model: Story 2.1, 3.3
- Procurement model: Story 2.1
- Status history: Story 2.1

### Story Dependencies

**Depends on**:
- Story 3.5 (Receive Action) - complete follows final receive
- Story 3.3 (Transaction Actions Schema) - for action recording
- Story 3.1 (Workflow Schema) - for is_final_step check

**Blocks**:
- Story 3.7 (Transaction State Machine) - uses complete for terminal state

---

## Tasks

### Task 1: Update EndorsementService
**Estimate**: 45 minutes
- Add `complete()` method with DB transaction
- Add `canComplete()` verification method
- Add `checkAndUpdateProcurementStatus()` helper
- Ensure status history is logged

**Verification**: Service methods work in tinker

### Task 2: Update Transaction Policy
**Estimate**: 15 minutes
- Add `complete()` authorization method
- Test policy in tinker

**Verification**: Policy check works

### Task 3: Create Complete Controller
**Estimate**: 30 minutes
- Create `app/Http/Controllers/TransactionCompleteController.php`
- Implement `store()` method
- Handle procurement completion message

**Verification**: Route responds correctly

### Task 4: Create Form Request
**Estimate**: 15 minutes
- Create `app/Http/Requests/CompleteTransactionRequest.php`
- Define validation rules for action_taken_id and notes

**Verification**: Validation works

### Task 5: Add Routes
**Estimate**: 10 minutes
- Add route to `routes/web.php`:
  - `POST /transactions/{transaction}/complete` → store
- Apply auth middleware

**Verification**: Route registered

### Task 6: Create Complete Modal Component
**Estimate**: 45 minutes
- Create `resources/js/Components/CompleteTransactionModal.tsx`
- Display transaction summary
- Show workflow completion status
- Action Taken dropdown
- Notes textarea
- Warning message
- Confirm/Cancel buttons

**Verification**: Modal renders correctly

### Task 7: Update Transaction Detail Page
**Estimate**: 30 minutes
- Update `resources/js/Pages/Transactions/Show.tsx`
- Add Complete button with visibility logic
- Pass canComplete prop from controller
- Integrate CompleteTransactionModal
- Handle success response
- Show "Completed" badge for completed transactions

**Verification**: Complete button shows/hides correctly

### Task 8: Update Transaction Show Controller
**Estimate**: 15 minutes
- Update transaction show controller
- Add `canComplete` prop
- Include final step information

**Verification**: Props passed correctly

### Task 9: Write Feature Tests
**Estimate**: 1 hour
- Create `tests/Feature/TransactionCompleteTest.php`:
  - Test complete at final step succeeds
  - Test complete at non-final step fails
  - Test complete creates action with correct data
  - Test transaction status changes to Completed
  - Test status history record created
  - Test procurement status updates when VCH completed
  - Test procurement status unchanged when PR/PO completed
  - Test cannot complete already-completed transaction
  - Test cannot complete unreceived transaction

**Verification**:
```bash
php artisan test --filter=TransactionComplete
```

### Task 10: Write Service Unit Tests
**Estimate**: 30 minutes
- Add tests to `tests/Unit/Services/EndorsementServiceTest.php`:
  - Test canComplete returns correct boolean
  - Test complete updates transaction status
  - Test checkAndUpdateProcurementStatus logic

**Verification**:
```bash
php artisan test --filter=EndorsementService
```

---

## Acceptance Checklist

- [ ] Complete button visible only at final workflow step
- [ ] Complete button disabled with explanation when conditions not met
- [ ] Complete modal shows transaction summary
- [ ] Complete modal shows workflow completion indicator
- [ ] Action Taken dropdown populated and required
- [ ] Warning message displayed about irreversibility
- [ ] Complete action creates transaction_action record
- [ ] Transaction status updated to "Completed"
- [ ] Status history record created
- [ ] Procurement status updates when VCH completed (with PR+PO done)
- [ ] Success toast displayed (with procurement completion if applicable)
- [ ] Completed transaction shows "Completed" badge
- [ ] No endorsement actions available after completion
- [ ] Authorization enforced
- [ ] Feature tests pass
- [ ] Unit tests pass

**Definition of Done**: Users at the final workflow step can complete transactions, which updates transaction status, logs the action, and checks/updates procurement completion status when applicable.

---

## Dev Agent Record

**Story**: 3.6 - Complete Action Implementation
**Status**: Ready for review
**Assigned**: workflow-dev
**Start Date**: 2026-02-09
**Completion Date**: 2026-02-09

### Files Created
- [x] `app/Http/Controllers/TransactionCompleteController.php`
- [x] `app/Http/Requests/CompleteTransactionRequest.php`
- [x] `app/Models/TransactionStatusHistory.php`
- [x] `resources/js/Components/CompleteTransactionModal.tsx`
- [x] `tests/Feature/TransactionCompleteTest.php`
- [x] `tests/e2e/complete-action.spec.ts`

### Files Modified
- [x] `app/Services/EndorsementService.php` - Added complete(), canComplete(), getCannotCompleteReason(), verifyCanComplete(), checkAndUpdateProcurementStatus()
- [x] `app/Policies/TransactionPolicy.php` - Added complete() method
- [x] `routes/web.php` - Added POST /transactions/{transaction}/complete route
- [x] `resources/js/Pages/PurchaseRequests/Show.tsx` - Added Complete button with modal, Completed status badge, hide action buttons for completed transactions
- [x] `app/Http/Controllers/PurchaseRequestController.php` - Added canComplete, cannotCompleteReason, actionTakenOptions props to show()
- [x] `tests/Unit/Services/EndorsementServiceTest.php` - Added 13 tests for canComplete, complete, checkAndUpdateProcurementStatus, getCannotCompleteReason

### Test Results
- [x] Feature tests: 17 passing (34 assertions)
- [x] Unit tests: 45 passing (68 assertions) - includes 13 new for Story 3.6
- [x] All story tests pass (no regressions in Stories 3.4, 3.5)

### Implementation Notes
- Created TransactionStatusHistory model (migration existed but model was missing)
- Complete button only visible when transaction status is not "Completed"
- Receive and Endorse buttons also hidden for completed transactions
- Procurement completion (FR8): Only VCH completion can trigger procurement completion; checks that all PR/PO/VCH are "Completed"
- Controller redirects to category-specific show page (purchase-requests.show, purchase-orders.show, vouchers.show)
- Note: PO and VCH show pages do not yet have endorse/receive/complete buttons (they were not added in Stories 3.4/3.5 either - these pages need a separate update)

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
