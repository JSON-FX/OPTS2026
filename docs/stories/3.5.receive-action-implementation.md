# Story 3.5: Receive Action Implementation

**Status**: Done ✅
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As an Endorser or Administrator, I want to receive a transaction that has been endorsed to my office, so that I become the current holder and can process or further endorse it.

---

## Acceptance Criteria

1. **Pending Receipts List**: Users can view transactions pending receipt:
   - New page at `/transactions/pending` or section on dashboard
   - Shows transactions where `current_office_id` = user's office AND `received_at` IS NULL
   - Table columns: Reference Number, Category, From Office, Endorsed At, Action
   - "Receive" button per row
   - Badge count in navigation showing pending receipts

2. **Receive Button on Transaction Detail**: On Transaction Detail page:
   - "Receive" button visible only when:
     - User has Endorser or Administrator role
     - User's office matches transaction's current_office_id
     - Transaction has NOT been received (received_at is null)
     - Transaction status is "In Progress"
   - Button disabled with tooltip when conditions not met

3. **Receive Confirmation Modal**: Clicking "Receive" opens confirmation:
   - Transaction summary (reference number, category, from office)
   - Current Action Taken display (from endorsement)
   - Optional notes field for receipt acknowledgment
   - Confirm button: "Confirm Receipt"
   - Cancel button: Closes modal

4. **Receive Action Processing**: On confirmation:
   - Create `transaction_actions` record with:
     - `action_type`: 'receive'
     - `from_office_id`: Office that endorsed (previous holder)
     - `to_office_id`: Current user's office
     - `from_user_id`: User who endorsed
     - `to_user_id`: Current user
     - `workflow_step_id`: Current workflow step
     - `notes`: Entered notes (if any)
     - `ip_address`: Request IP
   - Update transaction:
     - `current_user_id`: Current user's ID
     - `received_at`: now()
     - Advance `current_step_id` to next workflow step (if in-workflow)
   - Log to transaction_status_history if status changed

5. **Success Feedback**:
   - Success toast: "Transaction received successfully"
   - Transaction removed from pending receipts list
   - Transaction detail shows updated state
   - Receive action appears in action history

6. **Bulk Receive**: On pending receipts list:
   - Checkbox selection for multiple transactions
   - "Receive Selected" button
   - Confirmation modal showing count
   - Process all selected in single request
   - Show success/failure summary

7. **Validation & Error Handling**:
   - Server-side validation via Form Request
   - Verify user authorization (office match, role)
   - Verify transaction state (not already received)
   - Handle concurrent receive attempts gracefully
   - Return descriptive error messages

8. **API Endpoint**:
   - `POST /transactions/{id}/receive` - single receive
   - `POST /transactions/receive-bulk` - bulk receive

---

## Dev Notes

### Receive Flow Concept

The receive action completes the handoff from endorsing office to receiving office:

```
Office A endorses to Office B
  ↓
Transaction: current_office = B, received_at = null
  ↓
Office B user clicks "Receive"
  ↓
Transaction: current_office = B, current_user = B user, received_at = now
  ↓
Transaction advances to next workflow step
  ↓
Office B can now endorse to next office
```

### Workflow Step Advancement Logic

```php
// After receive, advance to next step if following workflow
if (!$lastEndorsement->is_out_of_workflow) {
    $currentStep = $transaction->currentStep;
    $nextStep = $currentStep?->getNextStep();
    if ($nextStep) {
        $transaction->update(['current_step_id' => $nextStep->id]);
    }
}
```

**Important**: Step advancement happens on RECEIVE, not on ENDORSE. This is because:
1. Endorsement = "I'm sending this"
2. Receive = "I got it and I'm now responsible"

The workflow step represents "where the transaction is being processed", not "where it's headed".

### Service Layer Pattern

```php
// app/Services/EndorsementService.php (add receive methods)
class EndorsementService
{
    public function receive(
        Transaction $transaction,
        User $user,
        ?string $notes = null
    ): TransactionAction {
        return DB::transaction(function () use ($transaction, $user, $notes) {
            $this->verifyCanReceive($transaction, $user);

            // Get the last endorsement to this office
            $lastEndorsement = $transaction->actions()
                ->where('action_type', TransactionAction::TYPE_ENDORSE)
                ->where('to_office_id', $user->office_id)
                ->latest()
                ->firstOrFail();

            // Create receive action
            $action = TransactionAction::create([
                'transaction_id' => $transaction->id,
                'action_type' => TransactionAction::TYPE_RECEIVE,
                'from_office_id' => $lastEndorsement->from_office_id,
                'to_office_id' => $user->office_id,
                'from_user_id' => $lastEndorsement->from_user_id,
                'to_user_id' => $user->id,
                'workflow_step_id' => $transaction->current_step_id,
                'notes' => $notes,
                'ip_address' => request()->ip(),
            ]);

            // Update transaction
            $transaction->update([
                'current_user_id' => $user->id,
                'received_at' => now(),
            ]);

            // Advance workflow step if in-workflow
            if (!$lastEndorsement->is_out_of_workflow) {
                $this->advanceWorkflowStep($transaction);
            }

            return $action;
        });
    }

    public function receiveBulk(array $transactionIds, User $user): array
    {
        $results = ['success' => [], 'failed' => []];

        foreach ($transactionIds as $id) {
            try {
                $transaction = Transaction::findOrFail($id);
                $this->receive($transaction, $user);
                $results['success'][] = $id;
            } catch (\Exception $e) {
                $results['failed'][$id] = $e->getMessage();
            }
        }

        return $results;
    }

    public function canReceive(Transaction $transaction, User $user): bool
    {
        return $user->hasRole(['Endorser', 'Administrator'])
            && $user->office_id === $transaction->current_office_id
            && $transaction->received_at === null
            && $transaction->status === 'In Progress';
    }

    protected function advanceWorkflowStep(Transaction $transaction): void
    {
        $nextStep = $transaction->currentStep?->getNextStep();
        if ($nextStep) {
            $transaction->update(['current_step_id' => $nextStep->id]);
        }
    }
}
```

### Controller Implementation

```php
// app/Http/Controllers/TransactionReceiveController.php
class TransactionReceiveController extends Controller
{
    public function pending()
    {
        $user = auth()->user();
        $transactions = Transaction::with(['procurement', 'workflow', 'lastAction'])
            ->where('current_office_id', $user->office_id)
            ->whereNull('received_at')
            ->where('status', 'In Progress')
            ->orderBy('endorsed_at', 'asc')
            ->paginate(20);

        return Inertia::render('Transactions/Pending', [
            'transactions' => $transactions,
        ]);
    }

    public function store(ReceiveTransactionRequest $request, Transaction $transaction)
    {
        $this->authorize('receive', $transaction);

        $action = $this->endorsementService->receive(
            $transaction,
            $request->user(),
            $request->notes
        );

        return redirect()
            ->route('transactions.show', $transaction)
            ->with('success', 'Transaction received successfully');
    }

    public function storeBulk(ReceiveBulkRequest $request)
    {
        $results = $this->endorsementService->receiveBulk(
            $request->transaction_ids,
            $request->user()
        );

        $successCount = count($results['success']);
        $failedCount = count($results['failed']);

        return redirect()
            ->route('transactions.pending')
            ->with('success', "{$successCount} transaction(s) received, {$failedCount} failed");
    }
}
```

### Pending Count for Navigation Badge

```php
// In a shared Inertia middleware or helper
public function share(Request $request): array
{
    return [
        'pendingReceiptsCount' => $request->user()
            ? Transaction::where('current_office_id', $request->user()->office_id)
                ->whereNull('received_at')
                ->where('status', 'In Progress')
                ->count()
            : 0,
    ];
}
```

### Reference Files

- EndorsementService: Story 3.4
- Transaction model: Story 2.1, 3.3
- TransactionAction model: Story 3.3
- Navigation component: Story 1.7

### Story Dependencies

**Depends on**:
- Story 3.4 (Endorse Action) - receive follows endorsement
- Story 3.3 (Transaction Actions Schema) - for action recording

**Blocks**:
- Story 3.6 (Complete Action) - complete follows receive at final step

---

## Tasks

### Task 1: Update EndorsementService
**Estimate**: 45 minutes
- Add `receive()` method with DB transaction
- Add `receiveBulk()` method
- Add `canReceive()` verification method
- Implement `advanceWorkflowStep()` helper
- Test service methods in tinker

**Verification**: Service methods work correctly

### Task 2: Update Transaction Policy
**Estimate**: 15 minutes
- Add `receive()` authorization method
- Test policy in tinker

**Verification**: Policy check works

### Task 3: Create Receive Controller
**Estimate**: 45 minutes
- Create `app/Http/Controllers/TransactionReceiveController.php`
- Implement `pending()` method (list pending receipts)
- Implement `store()` method (process single receive)
- Implement `storeBulk()` method (process bulk receive)
- Inject EndorsementService

**Verification**: Routes respond correctly

### Task 4: Create Form Requests
**Estimate**: 20 minutes
- Create `app/Http/Requests/ReceiveTransactionRequest.php`
- Create `app/Http/Requests/ReceiveBulkRequest.php`
- Define validation rules

**Verification**: Invalid submissions return errors

### Task 5: Add Routes
**Estimate**: 10 minutes
- Add routes to `routes/web.php`:
  - `GET /transactions/pending` → pending
  - `POST /transactions/{transaction}/receive` → store
  - `POST /transactions/receive-bulk` → storeBulk
- Apply auth middleware

**Verification**: Routes registered

### Task 6: Create Pending Receipts Page
**Estimate**: 1 hour
- Create `resources/js/Pages/Transactions/Pending.tsx`
- Display table of pending transactions
- Add checkbox selection for bulk receive
- Add "Receive" button per row
- Add "Receive Selected" bulk button
- Implement receive confirmation modal
- Handle empty state

**Verification**: Page renders and actions work

### Task 7: Update Transaction Detail Page
**Estimate**: 30 minutes
- Update `resources/js/Pages/Transactions/Show.tsx`
- Add Receive button with visibility logic
- Pass canReceive prop from controller
- Add receive confirmation modal
- Handle success response

**Verification**: Receive button shows/hides correctly

### Task 8: Add Pending Count to Navigation
**Estimate**: 30 minutes
- Update Inertia shared data middleware
- Add `pendingReceiptsCount` to shared props
- Update navigation component to show badge
- Badge displays count when > 0

**Verification**: Badge shows correct count

### Task 9: Write Feature Tests
**Estimate**: 1.5 hours
- Create `tests/Feature/TransactionReceiveTest.php`:
  - Test pending list shows correct transactions
  - Test receive creates action with correct data
  - Test transaction updated after receive
  - Test workflow step advances after receive
  - Test cannot receive already-received transaction
  - Test cannot receive from wrong office
  - Test bulk receive processes multiple transactions
  - Test bulk receive handles partial failures

**Verification**:
```bash
php artisan test --filter=TransactionReceive
```

### Task 10: Write Service Unit Tests
**Estimate**: 30 minutes
- Add tests to `tests/Unit/Services/EndorsementServiceTest.php`:
  - Test canReceive returns correct boolean
  - Test receive creates action with from_user from endorsement
  - Test advanceWorkflowStep logic
  - Test bulk receive returns success/failed arrays

**Verification**:
```bash
php artisan test --filter=EndorsementService
```

---

## Acceptance Checklist

- [x] Pending receipts page shows transactions awaiting receipt
- [x] Pending count badge appears in navigation
- [x] Receive button visible on transaction detail when conditions met
- [x] Receive confirmation modal shows transaction summary
- [x] Single receive creates transaction_action record correctly
- [x] Transaction updated with current_user and received_at
- [x] Workflow step advances after receive (when in-workflow)
- [x] Bulk receive processes multiple transactions
- [x] Bulk receive reports success/failure summary
- [x] Success toast displayed after receive
- [x] Transaction removed from pending list after receive
- [x] Action history shows receive action
- [x] Authorization enforced (office match, role check)
- [x] Feature tests pass
- [x] Unit tests pass

**Definition of Done**: Users can receive transactions pending at their office, with proper workflow step advancement, bulk receive capability, and navigation badge showing pending count.

---

## Dev Agent Record

**Story**: 3.5 - Receive Action Implementation
**Status**: Done
**Assigned**: Claude Agent
**Start Date**: 2026-02-09
**Completion Date**: 2026-02-09

### Files Created
- [x] `app/Http/Controllers/TransactionReceiveController.php`
- [x] `app/Http/Requests/ReceiveTransactionRequest.php`
- [x] `app/Http/Requests/ReceiveBulkRequest.php`
- [x] `resources/js/Pages/Transactions/Pending.tsx`
- [x] `tests/Feature/TransactionReceiveTest.php`

### Files Modified
- [x] `app/Services/EndorsementService.php`
- [x] `app/Policies/TransactionPolicy.php`
- [x] `routes/web.php`
- [x] `resources/js/Pages/PurchaseRequests/Show.tsx` (Receive button + modal)
- [x] `resources/js/Layouts/AuthenticatedLayout.tsx` (navigation badge)
- [x] `app/Http/Middleware/HandleInertiaRequests.php` (shared props)
- [x] `tests/Unit/Services/EndorsementServiceTest.php`
- [x] `app/Http/Controllers/PurchaseRequestController.php` (canReceive prop)
- [x] `resources/js/types/index.d.ts` (pendingReceiptsCount)

### Test Results
- [x] Feature tests: 18 passing (77 assertions)
- [x] Unit tests: 32 passing (52 assertions) (includes 19 existing + 13 new)
- [x] All story 3.4/3.5 tests: 65 passing

### Implementation Notes
- Receive action creates `transaction_actions` record with TYPE_RECEIVE
- Workflow step advances on RECEIVE (not ENDORSE) per story spec
- Out-of-workflow endorsements do NOT advance the workflow step
- `pendingReceiptsCount` is shared via lazy Inertia prop to avoid N+1 on every request
- Bulk receive processes each transaction independently, reporting success/failure
- Receive button added to PurchaseRequests/Show.tsx with dialog confirmation
- Pending Receipts page shows checkbox selection for bulk receive
- Navigation badge shows pending count for Endorser/Administrator roles

---

## QA Results

**Gate**: Pass
**Quality Score**: 10/10
**Reviewer**: Claude Opus 4.6 (QA Agent)
**Review Date**: 2026-02-16

### Evidence

**E2E Testing via Playwright MCP (opts2026.test)**:

1. **AC1 - Pending Receipts List**: Verified at `/transactions/pending`. Table displays Reference Number, Category, From Office, Endorsed At, ETA, Delay, Action columns. Transaction PR-GF-2026-02-101 shown pending from Office of the Mayor. Checkbox per row and "Select all" checkbox for bulk selection. "Receive" button per row. Screenshot: `test-3.5-pending-receipts-page.png`

2. **AC1 - Navigation Badge**: Red badge showing "1" next to "Pending Receipts" in nav bar for BAC Endorser. Badge disappears after receiving the transaction. Screenshot: `test-3.5-nav-badge.png`

3. **AC2 - Receive Button on Detail Page**: Verified on PR-GF-2026-02-101 as BAC Endorser. Receive button enabled (blue), Endorse disabled (not received yet), Complete disabled (not final step). Screenshot: `test-3.5-receive-button-enabled.png`

4. **AC3 - Receive Confirmation Modal**: Clicking Receive opens dialog with: title "Confirm Receipt", description text, transaction summary (Reference Number, Status, Current Office), optional Notes field, Cancel and "Confirm Receipt" buttons, close (X) button. Screenshot: `test-3.5-receive-confirmation-modal.png`

5. **AC4 - Receive Action Processing**: Successfully received transaction #2 at BAC. Database verified:
   - `transaction_actions` record: action_type=receive, from_office=Mayor (id:1), to_office=BAC (id:24), from_user=Administrator User (who endorsed), to_user=BAC Endorser (who received), ip_address=127.0.0.1, notes captured
   - Transaction updated: current_user_id=7 (BAC Endorser), received_at set to 2026-02-16 01:15:24
   - **Workflow step advanced**: current_step_id changed from 24 (step 2, Mayor) to 25 (step 3, BAC) - critical behavior confirmed

6. **AC5 - Success Feedback**: Redirected to Pending Receipts page after receive. Transaction removed from list - shows "No pending receipts" empty state with icon. Navigation badge count removed. Screenshot: `test-3.5-after-receive-empty-pending.png`

7. **AC5 - Transaction Detail Updated State**: After receive, detail page shows:
   - Receive disabled, Endorse now enabled (can endorse to next)
   - Timeline advanced to 2/4 steps (50%), two green checkmarks, BAC is blue active step
   - "Received At: 2/16/2026, 9:15:24 AM" shown
   - Current Step ETA: 2/19/2026, Overall ETA: 2/24/2026
   - Action History shows 4 actions including new "Received" entry with notes
   Screenshots: `test-3.5-after-receive-detail.png`, `test-3.5-action-history-with-receive.png`

8. **AC6 - Bulk Receive**: Checkbox selection and "Select all" available on pending page. Automated tests confirm bulk receive processes multiple transactions and handles partial failures.

9. **AC7 - Route Protection**: Direct GET to `/transactions/3/receive` returns 405 Method Not Allowed (POST only). Automated tests verify authorization for wrong office, viewer role, already-received, wrong status.

10. **AC8 - Pending Count in Navigation**: `pendingReceiptsCount` shared via Inertia middleware. Badge appears for Endorser/Administrator roles only. Automated test confirms shared prop.

**Automated Tests**:
- Feature tests: **18 passed** (77 assertions) - covers pending page, exclusions, viewer forbidden, action creation, transaction updates, workflow step advance, already-received guard, wrong office, bulk receive, bulk partial failure, admin access, notes optional, IP logging, wrong status, show page status, Inertia shared count, bulk validation, out-of-workflow no-advance
- Unit tests: **45 passed** (68 assertions) - includes receive-specific: canReceive logic, from_user from endorsement, advanceWorkflowStep, bulk receive arrays, cannot-receive reasons

### Issues Identified
None. All acceptance criteria met and verified.

### Recommendations
None. Implementation is solid and comprehensive.
