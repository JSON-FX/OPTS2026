# Story 3.11: Workflow Assignment on Transaction Creation

**Status**: Draft
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As an Endorser or Administrator creating a transaction, I want the appropriate workflow automatically assigned based on transaction category, so that the transaction follows the correct approval path from creation.

---

## Acceptance Criteria

1. **Automatic Workflow Assignment**: When a transaction (PR, PO, or VCH) is created:
   - System automatically assigns the active workflow for that category
   - `workflow_id` set on the transaction record
   - `current_step_id` set to the first step of the workflow
   - `current_office_id` set to the creating user's office (originating office)
   - `current_user_id` set to the creating user
   - Transaction status remains "Created" until first endorsement

2. **Workflow Selection Logic**: System selects workflow by:
   - Matching transaction category (PR, PO, VCH)
   - Selecting workflow where `is_active = true`
   - If multiple active workflows exist for category, select most recently created
   - If no active workflow exists, prevent transaction creation with error

3. **Transaction Creation Forms Update**: Update PR, PO, VCH creation forms:
   - Display selected workflow name (read-only)
   - Show workflow steps preview (collapsible)
   - Show expected completion days total
   - Warning if no active workflow available

4. **Validation Rules**: Enforce workflow requirements:
   - Cannot create transaction if no active workflow for category
   - Creating user must belong to an office
   - Office must be configured in system

5. **Initial Endorsement Option**: On transaction creation, optionally allow:
   - "Create & Endorse" button to immediately endorse after creation
   - Target office defaults to first workflow step's expected office
   - Creates transaction then immediately creates endorse action
   - Transitions status from "Created" to "In Progress"

6. **Transaction Record Updates**: On creation, set:
   - `workflow_id`: Assigned workflow
   - `current_step_id`: First step of workflow
   - `current_office_id`: Creating user's office
   - `current_user_id`: Creating user
   - `received_at`: Current timestamp (user "receives" their own creation)
   - `status`: "Created"

7. **Workflow Preview Component**: Display workflow preview showing:
   - List of offices in order
   - Expected days per step
   - Total expected days
   - Visual step indicator

8. **Error Handling**: Handle edge cases:
   - No active workflow → Block creation, show error
   - User has no office → Block creation, show error
   - Workflow deactivated during creation → Validate before save

---

## Dev Notes

### Workflow Selection Service

```php
// app/Services/WorkflowAssignmentService.php
class WorkflowAssignmentService
{
    /**
     * Get the active workflow for a transaction category.
     * Returns null if no active workflow exists.
     */
    public function getActiveWorkflow(string $category): ?Workflow
    {
        return Workflow::where('category', $category)
            ->where('is_active', true)
            ->with('steps.office')
            ->orderByDesc('created_at')
            ->first();
    }

    /**
     * Check if a category has an active workflow.
     */
    public function hasActiveWorkflow(string $category): bool
    {
        return Workflow::where('category', $category)
            ->where('is_active', true)
            ->exists();
    }

    /**
     * Assign workflow to a transaction.
     * Sets workflow_id, current_step_id, and initial office/user.
     */
    public function assignWorkflow(Transaction $transaction, User $user): void
    {
        $workflow = $this->getActiveWorkflow($transaction->category);

        if (!$workflow) {
            throw new NoActiveWorkflowException(
                "No active workflow found for category: {$transaction->category}"
            );
        }

        $firstStep = $workflow->getFirstStep();

        $transaction->update([
            'workflow_id' => $workflow->id,
            'current_step_id' => $firstStep->id,
            'current_office_id' => $user->office_id,
            'current_user_id' => $user->id,
            'received_at' => now(),
        ]);
    }

    /**
     * Get workflow preview data for display.
     */
    public function getWorkflowPreview(string $category): ?array
    {
        $workflow = $this->getActiveWorkflow($category);

        if (!$workflow) {
            return null;
        }

        $steps = $workflow->steps()->ordered()->with('office')->get();

        return [
            'workflow_id' => $workflow->id,
            'workflow_name' => $workflow->name,
            'total_steps' => $steps->count(),
            'total_expected_days' => $steps->sum('expected_days'),
            'steps' => $steps->map(fn ($step) => [
                'step_order' => $step->step_order,
                'office_name' => $step->office->name,
                'expected_days' => $step->expected_days,
                'is_final_step' => $step->is_final_step,
            ]),
        ];
    }
}
```

### Updated Transaction Creation Flow

```php
// In TransactionController or specific PR/PO/VCH controllers
public function store(StoreTransactionRequest $request)
{
    $user = $request->user();

    // Validate user has office
    if (!$user->office_id) {
        return back()->withErrors(['office' => 'You must be assigned to an office to create transactions.']);
    }

    // Check workflow exists
    $workflowService = app(WorkflowAssignmentService::class);
    if (!$workflowService->hasActiveWorkflow($request->category)) {
        return back()->withErrors(['workflow' => "No active workflow configured for {$request->category} transactions."]);
    }

    return DB::transaction(function () use ($request, $user, $workflowService) {
        // Create base transaction
        $transaction = Transaction::create([
            'procurement_id' => $request->procurement_id,
            'category' => $request->category,
            'reference_number' => $this->referenceService->generate($request->category, ...),
            'status' => 'Created',
            'created_by_user_id' => $user->id,
        ]);

        // Assign workflow
        $workflowService->assignWorkflow($transaction, $user);

        // Create type-specific record (PR, PO, or VCH)
        $this->createTypeSpecificRecord($transaction, $request);

        // Optional: immediate endorsement
        if ($request->boolean('endorse_immediately')) {
            app(EndorsementService::class)->endorse(
                $transaction->fresh(),
                $user,
                $request->action_taken_id,
                $request->to_office_id ?? $this->getFirstWorkflowOffice($transaction),
                $request->notes
            );
        }

        return redirect()
            ->route('transactions.show', $transaction)
            ->with('success', 'Transaction created successfully');
    });
}
```

### Form Request Validation

```php
// app/Http/Requests/StoreTransactionRequest.php
public function rules(): array
{
    return [
        // ... existing rules ...
        'endorse_immediately' => 'boolean',
        'action_taken_id' => 'required_if:endorse_immediately,true|exists:action_taken,id',
        'to_office_id' => 'nullable|exists:offices,id',
    ];
}

public function withValidator($validator)
{
    $validator->after(function ($validator) {
        // Verify active workflow exists
        $category = $this->category ?? $this->route('category');
        if (!app(WorkflowAssignmentService::class)->hasActiveWorkflow($category)) {
            $validator->errors()->add('category', "No active workflow configured for {$category} transactions.");
        }

        // Verify user has office
        if (!$this->user()->office_id) {
            $validator->errors()->add('office', 'You must be assigned to an office to create transactions.');
        }
    });
}
```

### Transaction Creation Form Component

```tsx
// resources/js/Pages/Transactions/Create.tsx (updated)
export default function CreateTransaction({ procurement, category, workflowPreview }: Props) {
  const [endorseImmediately, setEndorseImmediately] = useState(false);

  return (
    <form onSubmit={handleSubmit}>
      {/* Existing form fields */}

      {/* Workflow Preview Section */}
      {workflowPreview ? (
        <WorkflowPreviewCard workflow={workflowPreview} />
      ) : (
        <Alert variant="destructive">
          <AlertTriangle className="h-4 w-4" />
          <AlertTitle>No Active Workflow</AlertTitle>
          <AlertDescription>
            No active workflow is configured for {category} transactions.
            Please contact an administrator.
          </AlertDescription>
        </Alert>
      )}

      {/* Immediate Endorsement Option */}
      {workflowPreview && (
        <div className="mt-4">
          <Checkbox
            id="endorse_immediately"
            checked={endorseImmediately}
            onCheckedChange={setEndorseImmediately}
          />
          <Label htmlFor="endorse_immediately">
            Immediately endorse to next office after creation
          </Label>

          {endorseImmediately && (
            <div className="mt-2 pl-6">
              <SelectField
                label="Action Taken"
                name="action_taken_id"
                options={actionTakenOptions}
                required
              />
              <p className="text-sm text-gray-500 mt-1">
                Will be endorsed to: {workflowPreview.steps[0]?.office_name}
              </p>
            </div>
          )}
        </div>
      )}

      {/* Submit Buttons */}
      <div className="flex gap-2 mt-6">
        <Button type="submit" disabled={!workflowPreview}>
          {endorseImmediately ? 'Create & Endorse' : 'Create Transaction'}
        </Button>
        <Button type="button" variant="outline" onClick={() => history.back()}>
          Cancel
        </Button>
      </div>
    </form>
  );
}
```

### Reference Files

- Transaction creation: Stories 2.5, 2.7, 2.8
- Workflow model: Story 3.1
- EndorsementService: Story 3.4
- WorkflowAssignmentService: This story

### Story Dependencies

**Depends on**:
- Story 3.1 (Workflow Schema) - workflows must exist
- Story 3.2 (Workflow Admin UI) - admin creates workflows
- Story 3.4 (Endorse Action) - for immediate endorsement option

**Blocks**:
- None (completes Epic 3 workflow integration)

---

## Tasks

### Task 1: Create Workflow Assignment Service
**Estimate**: 45 minutes
- Create `app/Services/WorkflowAssignmentService.php`
- Implement `getActiveWorkflow()` method
- Implement `hasActiveWorkflow()` method
- Implement `assignWorkflow()` method
- Implement `getWorkflowPreview()` method
- Create `NoActiveWorkflowException`
- Register in service container

**Verification**: Test service methods in tinker

### Task 2: Update Transaction Model
**Estimate**: 20 minutes
- Ensure `workflow_id`, `current_step_id` are fillable
- Ensure relationships properly defined
- Add `received_at` to fillable if not already

**Verification**: Model updates work

### Task 3: Update Transaction Form Requests
**Estimate**: 30 minutes
- Update `StorePurchaseRequestRequest`
- Update `StorePurchaseOrderRequest`
- Update `StoreVoucherRequest`
- Add workflow and office validation
- Add immediate endorsement fields

**Verification**: Validation works

### Task 4: Update Transaction Controllers
**Estimate**: 1 hour
- Update PR, PO, VCH store methods
- Inject WorkflowAssignmentService
- Call `assignWorkflow()` after creation
- Handle immediate endorsement option
- Pass workflow preview to create forms

**Verification**: Transactions created with workflow assigned

### Task 5: Create WorkflowPreviewCard Component
**Estimate**: 30 minutes
- Create `resources/js/Components/WorkflowPreviewCard.tsx`
- Display workflow name
- Show step list with offices and expected days
- Show total expected days
- Collapsible details

**Verification**: Component renders correctly

### Task 6: Update Transaction Create Pages
**Estimate**: 45 minutes
- Update PR, PO, VCH create pages
- Add WorkflowPreviewCard
- Add no-workflow warning
- Add immediate endorsement checkbox
- Conditional action_taken field

**Verification**: Forms display workflow info

### Task 7: Handle No-Workflow State
**Estimate**: 20 minutes
- Disable submit button when no workflow
- Show clear error message
- Prevent form submission server-side

**Verification**: Cannot create without workflow

### Task 8: Write Feature Tests
**Estimate**: 1.5 hours
- Create `tests/Feature/WorkflowAssignmentTest.php`:
  - Test transaction created with workflow assigned
  - Test current_step_id set to first step
  - Test current_office_id set to user's office
  - Test received_at set on creation
  - Test creation fails without active workflow
  - Test creation fails without user office
  - Test immediate endorsement creates action
  - Test immediate endorsement transitions status

**Verification**:
```bash
php artisan test --filter=WorkflowAssignment
```

### Task 9: Write Service Unit Tests
**Estimate**: 30 minutes
- Create `tests/Unit/Services/WorkflowAssignmentServiceTest.php`:
  - Test getActiveWorkflow returns correct workflow
  - Test getActiveWorkflow returns newest when multiple active
  - Test getActiveWorkflow returns null when none active
  - Test hasActiveWorkflow returns correct boolean
  - Test getWorkflowPreview returns correct structure

**Verification**:
```bash
php artisan test --filter=WorkflowAssignmentService
```

### Task 10: Update Seeder Integration
**Estimate**: 20 minutes
- Ensure transaction seeders assign workflows
- Update existing seeded transactions to have workflow data
- Verify seeded data consistency

**Verification**:
```bash
php artisan db:seed
```

---

## Acceptance Checklist

- [ ] Transactions automatically assigned active workflow on creation
- [ ] current_step_id set to first workflow step
- [ ] current_office_id set to creating user's office
- [ ] current_user_id set to creating user
- [ ] received_at set on creation
- [ ] Creation fails gracefully when no active workflow
- [ ] Creation fails gracefully when user has no office
- [ ] Transaction create forms show workflow preview
- [ ] No-workflow warning displayed when applicable
- [ ] "Create & Endorse" option works correctly
- [ ] Immediate endorsement transitions status to "In Progress"
- [ ] Feature tests pass
- [ ] Unit tests pass

**Definition of Done**: Transactions are automatically assigned appropriate workflows on creation, users see workflow preview before creating, and optional immediate endorsement allows starting the workflow in one step.

---

## Dev Agent Record

**Story**: 3.11 - Workflow Assignment on Transaction Creation
**Status**: Draft
**Assigned**:
**Start Date**:
**Completion Date**:

### Files Created
- [ ] `app/Services/WorkflowAssignmentService.php`
- [ ] `app/Exceptions/NoActiveWorkflowException.php`
- [ ] `resources/js/Components/WorkflowPreviewCard.tsx`
- [ ] `tests/Feature/WorkflowAssignmentTest.php`
- [ ] `tests/Unit/Services/WorkflowAssignmentServiceTest.php`

### Files Modified
- [ ] `app/Models/Transaction.php`
- [ ] `app/Http/Controllers/PurchaseRequestController.php`
- [ ] `app/Http/Controllers/PurchaseOrderController.php`
- [ ] `app/Http/Controllers/VoucherController.php`
- [ ] `app/Http/Requests/StorePurchaseRequestRequest.php`
- [ ] `app/Http/Requests/StorePurchaseOrderRequest.php`
- [ ] `app/Http/Requests/StoreVoucherRequest.php`
- [ ] `resources/js/Pages/Transactions/CreatePR.tsx` (or similar)
- [ ] `resources/js/Pages/Transactions/CreatePO.tsx` (or similar)
- [ ] `resources/js/Pages/Transactions/CreateVCH.tsx` (or similar)
- [ ] `database/seeders/TransactionSeeder.php`

### Test Results
- [ ] Feature tests: X passing
- [ ] Unit tests: X passing
- [ ] All project tests: X passing

### Implementation Notes
*(To be filled by dev agent)*

### Time Log
*(To be filled by dev agent)*

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
