# Story 3.10: Timeline Visualization

**Status**: Draft
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As a user, I want to see a visual timeline showing completed workflow steps, current position, and upcoming steps with ETAs, so that I can understand transaction progress at a glance like tracking a package delivery.

---

## Acceptance Criteria

1. **Timeline Component**: Create a reusable `TransactionTimeline` component displaying:
   - Horizontal or vertical step sequence
   - Each step shows:
     - Step number and office name
     - Expected days for the step
     - Status indicator (completed, current, upcoming)
   - Visual connector lines between steps
   - Responsive design (horizontal on desktop, vertical on mobile)

2. **Completed Steps Display**: For completed steps show:
   - Green checkmark icon
   - Office name
   - Completion date/time
   - User who completed the receive action
   - Actual days taken vs expected days
   - Green styling

3. **Current Step Display**: For the active step show:
   - Animated/highlighted indicator (blue pulse or similar)
   - Office name
   - Current holder (user name)
   - Time at step (X days)
   - Expected days / ETA
   - Delay indicator if overdue
   - Blue styling with emphasis

4. **Upcoming Steps Display**: For future steps show:
   - Gray/muted styling
   - Office name
   - Expected days
   - Estimated arrival date (computed from current position)
   - Grayed-out connector

5. **Timeline on Transaction Detail**: On Transaction Detail page:
   - Timeline prominently displayed above action history
   - Full workflow visible
   - Expandable/collapsible on mobile
   - Quick visual progress indicator

6. **Progress Bar**: Compact progress indicator showing:
   - Overall percentage complete (steps completed / total steps)
   - Color based on delay status (green = on track, yellow = warning, red = overdue)
   - Can be shown in list views as compact representation

7. **Action History Integration**: Below timeline show:
   - Chronological list of all actions
   - Each entry: action type, user, from/to office, timestamp, notes
   - Out-of-workflow actions flagged with warning indicator
   - Expandable details for each action

8. **Timeline Data Structure**: Backend provides structured data:
   ```typescript
   interface TimelineStep {
     step_order: number;
     office: Office;
     expected_days: number;
     status: 'completed' | 'current' | 'upcoming';
     // For completed steps
     completed_at?: string;
     completed_by?: User;
     actual_days?: number;
     // For current step
     current_holder?: User;
     days_at_step?: number;
     eta?: string;
     is_overdue?: boolean;
     // For upcoming steps
     estimated_arrival?: string;
   }

   interface TransactionTimeline {
     steps: TimelineStep[];
     progress_percentage: number;
     total_steps: number;
     completed_steps: number;
     is_out_of_workflow: boolean;
   }
   ```

---

## Dev Notes

### Timeline Visual Design

**Desktop (Horizontal)**
```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Transaction Timeline                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ✓ Budget Office      ◉ BAC Office         ○ Accounting      ○ Releasing  │
│   │  Completed         │  Current             │  Upcoming        │  Final   │
│   │  Oct 25, 2025      │  John Doe            │  Expected        │  Expected│
│   │  2 days (exp: 2)   │  3 days at step      │  2 days          │  1 day   │
│   └────────────────────┴──────────────────────┴──────────────────┴─────────│
│                                                                             │
│   [============================>                    ] 50% (2/4 steps)       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Mobile (Vertical)**
```
┌─────────────────────────┐
│ Transaction Timeline    │
├─────────────────────────┤
│ ✓ Budget Office         │
│   Completed Oct 25      │
│   2 days (exp: 2)       │
│   │                     │
│   │                     │
│ ◉ BAC Office           │
│   Current - John Doe    │
│   3 days at step        │
│   │                     │
│   │                     │
│ ○ Accounting            │
│   Upcoming              │
│   Expected: 2 days      │
│   │                     │
│   │                     │
│ ○ Releasing             │
│   Final Step            │
│   Expected: 1 day       │
├─────────────────────────┤
│ [=====>    ] 50%        │
└─────────────────────────┘
```

### Timeline Service

```php
// app/Services/TimelineService.php
class TimelineService
{
    public function __construct(
        protected EtaCalculationService $etaService
    ) {}

    public function getTimeline(Transaction $transaction): array
    {
        $workflow = $transaction->workflow;
        if (!$workflow) {
            return $this->getEmptyTimeline();
        }

        $steps = $workflow->steps()->ordered()->with('office')->get();
        $currentStepOrder = $transaction->currentStep?->step_order ?? 0;
        $actions = $transaction->actions()
            ->whereIn('action_type', ['receive', 'complete'])
            ->with(['toUser', 'toOffice'])
            ->get()
            ->keyBy('workflow_step_id');

        $timelineSteps = [];
        $completedCount = 0;
        $runningEta = now();

        foreach ($steps as $step) {
            $action = $actions->get($step->id);

            if ($step->step_order < $currentStepOrder) {
                // Completed step
                $timelineSteps[] = [
                    'step_order' => $step->step_order,
                    'office' => $step->office,
                    'expected_days' => $step->expected_days,
                    'status' => 'completed',
                    'completed_at' => $action?->created_at?->toDateTimeString(),
                    'completed_by' => $action?->toUser,
                    'actual_days' => $this->calculateActualDays($step, $actions),
                ];
                $completedCount++;
            } elseif ($step->step_order === $currentStepOrder) {
                // Current step
                $timelineSteps[] = [
                    'step_order' => $step->step_order,
                    'office' => $step->office,
                    'expected_days' => $step->expected_days,
                    'status' => 'current',
                    'current_holder' => $transaction->currentUser,
                    'days_at_step' => $transaction->days_at_current_step,
                    'eta' => $transaction->eta_current_step,
                    'is_overdue' => $transaction->delay_days > 0,
                ];
                $runningEta = Carbon::parse($transaction->eta_current_step ?? now());
            } else {
                // Upcoming step
                $runningEta = $this->etaService->addBusinessDays($runningEta, $step->expected_days);
                $timelineSteps[] = [
                    'step_order' => $step->step_order,
                    'office' => $step->office,
                    'expected_days' => $step->expected_days,
                    'status' => 'upcoming',
                    'estimated_arrival' => $runningEta->toDateString(),
                ];
            }
        }

        return [
            'steps' => $timelineSteps,
            'progress_percentage' => $steps->count() > 0
                ? round(($completedCount / $steps->count()) * 100)
                : 0,
            'total_steps' => $steps->count(),
            'completed_steps' => $completedCount,
            'is_out_of_workflow' => $transaction->actions()
                ->where('is_out_of_workflow', true)
                ->exists(),
        ];
    }
}
```

### Timeline React Component

```tsx
// resources/js/Components/TransactionTimeline.tsx
interface Props {
  timeline: TransactionTimeline;
  orientation?: 'horizontal' | 'vertical';
}

export function TransactionTimeline({ timeline, orientation = 'horizontal' }: Props) {
  const isMobile = useMediaQuery('(max-width: 768px)');
  const actualOrientation = isMobile ? 'vertical' : orientation;

  return (
    <div className={cn(
      'transaction-timeline',
      actualOrientation === 'vertical' ? 'flex-col' : 'flex-row'
    )}>
      {/* Progress bar */}
      <ProgressBar
        percentage={timeline.progress_percentage}
        label={`${timeline.completed_steps}/${timeline.total_steps} steps`}
      />

      {/* Steps */}
      <div className={cn(
        'flex gap-4',
        actualOrientation === 'vertical' ? 'flex-col' : 'flex-row items-start'
      )}>
        {timeline.steps.map((step, index) => (
          <TimelineStep
            key={step.step_order}
            step={step}
            isLast={index === timeline.steps.length - 1}
            orientation={actualOrientation}
          />
        ))}
      </div>

      {/* Out of workflow warning */}
      {timeline.is_out_of_workflow && (
        <Alert variant="warning">
          This transaction has deviated from the expected workflow.
        </Alert>
      )}
    </div>
  );
}

function TimelineStep({ step, isLast, orientation }: StepProps) {
  const statusStyles = {
    completed: 'bg-green-500 text-white',
    current: 'bg-blue-500 text-white animate-pulse',
    upcoming: 'bg-gray-300 text-gray-600',
  };

  const statusIcons = {
    completed: <Check className="h-4 w-4" />,
    current: <Circle className="h-4 w-4 fill-current" />,
    upcoming: <Circle className="h-4 w-4" />,
  };

  return (
    <div className={cn('timeline-step', `status-${step.status}`)}>
      {/* Step indicator */}
      <div className={cn('step-icon', statusStyles[step.status])}>
        {statusIcons[step.status]}
      </div>

      {/* Step content */}
      <div className="step-content">
        <h4 className="font-medium">{step.office.name}</h4>

        {step.status === 'completed' && (
          <>
            <p className="text-sm text-gray-500">
              {step.completed_by?.name} • {formatDate(step.completed_at)}
            </p>
            <p className="text-sm">
              {step.actual_days} days (expected: {step.expected_days})
            </p>
          </>
        )}

        {step.status === 'current' && (
          <>
            <p className="text-sm text-blue-600">
              {step.current_holder?.name ?? 'Awaiting receipt'}
            </p>
            <p className="text-sm">
              {step.days_at_step} days at step
              {step.is_overdue && (
                <Badge variant="destructive" className="ml-2">Overdue</Badge>
              )}
            </p>
          </>
        )}

        {step.status === 'upcoming' && (
          <p className="text-sm text-gray-400">
            Expected: {step.expected_days} days
            {step.estimated_arrival && ` • ETA: ${formatDate(step.estimated_arrival)}`}
          </p>
        )}
      </div>

      {/* Connector line */}
      {!isLast && (
        <div className={cn(
          'connector',
          step.status === 'completed' ? 'bg-green-500' : 'bg-gray-300'
        )} />
      )}
    </div>
  );
}
```

### Reference Files

- ETA Service: Story 3.9
- Transaction model: Stories 2.1, 3.3
- Transaction detail page: Story 2.9

### Story Dependencies

**Depends on**:
- Story 3.9 (ETA & Delay Calculations) - for ETA data
- Story 3.3 (Transaction Actions Schema) - for action history
- Story 3.1 (Workflow Schema) - for step information

**Blocks**:
- Epic 4 Dashboard visualizations

---

## Tasks

### Task 1: Create Timeline Service
**Estimate**: 1 hour
- Create `app/Services/TimelineService.php`
- Implement `getTimeline()` method
- Compute completed, current, upcoming step data
- Calculate progress percentage
- Handle out-of-workflow flag
- Register in service container

**Verification**: Test service in tinker

### Task 2: Update Transaction Controller
**Estimate**: 20 minutes
- Update transaction show method
- Inject TimelineService
- Pass timeline data to view
- Include action history with relationships

**Verification**: Timeline data in page props

### Task 3: Create TimelineStep Component
**Estimate**: 45 minutes
- Create `resources/js/Components/Timeline/TimelineStep.tsx`
- Handle completed, current, upcoming states
- Style with appropriate colors/icons
- Show relevant data per state

**Verification**: Component renders correctly

### Task 4: Create TransactionTimeline Component
**Estimate**: 1 hour
- Create `resources/js/Components/Timeline/TransactionTimeline.tsx`
- Horizontal layout for desktop
- Vertical layout for mobile
- Include progress bar
- Include out-of-workflow warning

**Verification**: Timeline renders in both orientations

### Task 5: Create ProgressBar Component
**Estimate**: 20 minutes
- Create `resources/js/Components/ProgressBar.tsx`
- Percentage display
- Color based on status
- Step count label

**Verification**: Progress bar renders correctly

### Task 6: Create ActionHistory Component
**Estimate**: 45 minutes
- Create `resources/js/Components/ActionHistory.tsx`
- Chronological action list
- Each action shows type, user, offices, timestamp
- Out-of-workflow warning indicator
- Expandable details

**Verification**: Action history renders correctly

### Task 7: Update Transaction Detail Page
**Estimate**: 45 minutes
- Update `resources/js/Pages/Transactions/Show.tsx`
- Add TransactionTimeline component
- Add ActionHistory component
- Proper layout and spacing
- Mobile responsive

**Verification**: Timeline visible on transaction detail

### Task 8: Create Compact Progress Indicator
**Estimate**: 30 minutes
- Create compact progress component for list views
- Small progress bar or step dots
- Color-coded by delay status
- Use in transaction list rows

**Verification**: Compact indicator in list view

### Task 9: Update TypeScript Interfaces
**Estimate**: 15 minutes
- Add `TimelineStep` interface
- Add `TransactionTimeline` interface
- Update Transaction interface with timeline relationship

**Verification**: TypeScript compiles

### Task 10: Write Component Tests
**Estimate**: 1 hour
- Create tests for TransactionTimeline component
- Test completed step rendering
- Test current step rendering (with/without holder)
- Test upcoming step rendering
- Test progress bar calculation
- Test responsive behavior

**Verification**:
```bash
npm run test
```

### Task 11: Write Feature Tests
**Estimate**: 45 minutes
- Create `tests/Feature/TransactionTimelineTest.php`:
  - Test timeline data included in transaction detail
  - Test completed steps have correct data
  - Test current step shows holder and ETA
  - Test progress percentage calculation

**Verification**:
```bash
php artisan test --filter=TransactionTimeline
```

---

## Acceptance Checklist

- [ ] Timeline service computes correct step statuses
- [ ] Completed steps show user and timestamp
- [ ] Current step shows holder and time at step
- [ ] Upcoming steps show expected days and ETA
- [ ] Progress bar shows correct percentage
- [ ] Timeline renders horizontally on desktop
- [ ] Timeline renders vertically on mobile
- [ ] Out-of-workflow warning displays
- [ ] Action history shows all actions chronologically
- [ ] Overdue indicator shows on delayed current step
- [ ] Compact progress indicator works in lists
- [ ] TypeScript interfaces defined
- [ ] Component tests pass
- [ ] Feature tests pass

**Definition of Done**: Users can view a delivery-tracking-style timeline on transaction details showing completed steps, current position with holder info, and upcoming steps with ETAs, providing at-a-glance understanding of transaction progress.

---

## Dev Agent Record

**Story**: 3.10 - Timeline Visualization
**Status**: Draft
**Assigned**:
**Start Date**:
**Completion Date**:

### Files Created
- [ ] `app/Services/TimelineService.php`
- [ ] `resources/js/Components/Timeline/TransactionTimeline.tsx`
- [ ] `resources/js/Components/Timeline/TimelineStep.tsx`
- [ ] `resources/js/Components/Timeline/ProgressBar.tsx`
- [ ] `resources/js/Components/ActionHistory.tsx`
- [ ] `resources/js/Components/CompactProgress.tsx`
- [ ] `tests/Feature/TransactionTimelineTest.php`

### Files Modified
- [ ] `app/Http/Controllers/TransactionController.php`
- [ ] `resources/js/Pages/Transactions/Show.tsx`
- [ ] `resources/js/Pages/Transactions/Index.tsx`
- [ ] `resources/js/types/models.ts`

### Test Results
- [ ] Component tests: X passing
- [ ] Feature tests: X passing
- [ ] All project tests: X passing

### Implementation Notes
*(To be filled by dev agent)*

### Time Log
*(To be filled by dev agent)*

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
