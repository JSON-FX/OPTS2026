# Story 3.12: Endorsement Expiry & Auto-Recall

**Status**: Draft
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As a user, I want endorsed-but-unreceived transactions to automatically return to the sender's office after the workflow step's expected days have elapsed, so that documents don't sit in limbo indefinitely and both offices are notified of the expiry.

---

## Acceptance Criteria

1. **Expiry Calculation on Endorsement**: When a transaction is endorsed (via `EndorsementService::endorse()`):
   - System calculates `expiry_at` = `endorsed_at` + workflow step's `expected_days` (in business days)
   - Uses `EtaCalculationService::addBusinessDays()` for calculation
   - `expiry_at` stored on the `transactions` table (nullable datetime column)
   - If no workflow step or `expected_days` is null/0, `expiry_at` is not set (no expiry)

2. **Expiry Cleared on Receive**: When a transaction is received (via `EndorsementService::receive()`):
   - `expiry_at` is set to `null`
   - The endorsement is no longer subject to expiry

3. **Auto-Recall on Expiry**: A scheduled command (`opts:check-expired-endorsements`) detects expired endorsements:
   - Finds transactions where:
     - `status` = "In Progress"
     - `endorsed_at` IS NOT NULL
     - `received_at` IS NULL
     - `expiry_at` IS NOT NULL AND `expiry_at` < now()
   - For each expired transaction:
     - Creates a `TransactionAction` with `action_type` = `recall`
     - Sets `from_office_id` to the current office (where the document was sent)
     - Sets `to_office_id` to the sender's office (extracted from the last `endorse` action's `from_office_id`)
     - Resets `endorsed_at` to null
     - Resets `received_at` to null
     - Sets `expiry_at` to null
     - Updates `current_office_id` back to the sender's office
     - Updates `current_user_id` to null (no specific holder)
   - Command is idempotent — already-recalled transactions won't match the query

4. **Recall Action Type**: Add `recall` to the transaction action types:
   - New constant `TransactionAction::TYPE_RECALL = 'recall'`
   - Added to `TransactionAction::TYPES` array
   - Alter `action_type` enum in migration to include `recall`
   - Recall actions record `remarks` = "Auto-recalled: endorsement expired after N business days"

5. **Notifications on Expiry**: When an endorsement expires and is auto-recalled:
   - **Sender office users** (original endorser's office): Notification with type `endorsement_expired`, message: "Transaction {reference_number} has been auto-recalled — {to_office_name} did not receive it within {expected_days} business day(s)"
   - **Recipient office users** (office that failed to receive): Notification with type `endorsement_expired`, message: "Transaction {reference_number} has expired and returned to {from_office_name} — it was not received within {expected_days} business day(s)"
   - **Administrators**: Same notification as sender office
   - Follow existing event→listener→notification pattern (`EndorsementExpired` event, `NotifyEndorsementExpired` listener, `EndorsementExpiredNotification` class)

6. **Endorsement Expiry Display**: On transaction detail pages (PR/PO/VCH Show):
   - When a transaction is endorsed but not yet received and `expiry_at` is set:
     - Show "Expires in N business days" countdown
     - Show expiry date
     - Color-coded: green (3+ days), yellow (1-2 days), red (expired/today)
   - When `expiry_at` is null, show nothing (no expiry applies)

7. **Endorse Form Display**: On the Endorse page (`Transactions/Endorse.tsx`):
   - Show read-only info: "The receiving office has {expected_days} business day(s) to receive this document before it auto-recalls"
   - This is informational only — the endorser cannot change the expiry period

8. **NotificationBell Update**: The `NotificationBell.tsx` component renders `endorsement_expired` type:
   - `endorsement_expired` → orange `Timer` icon (or `TimerOff`)
   - Added to Notifications Index type filter dropdown

9. **Schedule Registration**: Register the command in Laravel's scheduler:
   - Run `opts:check-expired-endorsements` daily (or hourly, configurable)
   - Add to `routes/console.php` or `app/Console/Kernel.php`

10. **TypeScript Interface Updates**: Update types to include:
    ```typescript
    // Add to Transaction interface
    expiry_at: string | null; // ISO datetime

    // Add to TransactionAction action_type union
    type ActionType = 'endorse' | 'receive' | 'complete' | 'hold' | 'cancel' | 'bypass' | 'recall';
    ```

---

## Dev Notes

### Expiry Calculation in EndorsementService

```php
// In EndorsementService::endorse() — after creating the endorse action
use App\Services\EtaCalculationService;

$etaService = app(EtaCalculationService::class);
$currentStep = $transaction->currentStep;

$expiryAt = null;
if ($currentStep && $currentStep->expected_days > 0) {
    $expiryAt = $etaService->addBusinessDays(
        now(), // endorsed_at
        $currentStep->expected_days
    );
}

$transaction->update([
    'endorsed_at' => now(),
    'expiry_at' => $expiryAt,
    // ... other fields
]);
```

### Clearing Expiry on Receive

```php
// In EndorsementService::receive()
$transaction->update([
    'received_at' => now(),
    'expiry_at' => null,
    // ... other fields
]);
```

### Scheduled Command

```php
// app/Console/Commands/CheckExpiredEndorsements.php
class CheckExpiredEndorsements extends Command
{
    protected $signature = 'opts:check-expired-endorsements';
    protected $description = 'Auto-recall transactions with expired endorsements';

    public function handle(): int
    {
        $expired = Transaction::where('status', 'In Progress')
            ->whereNotNull('endorsed_at')
            ->whereNull('received_at')
            ->whereNotNull('expiry_at')
            ->where('expiry_at', '<', now())
            ->get();

        $this->info("Found {$expired->count()} expired endorsements");

        foreach ($expired as $transaction) {
            $this->recallTransaction($transaction);
        }

        $this->info('Done.');
        return self::SUCCESS;
    }

    protected function recallTransaction(Transaction $transaction): void
    {
        // Find the last endorse action to determine sender
        $lastEndorse = $transaction->actions()
            ->where('action_type', TransactionAction::TYPE_ENDORSE)
            ->latest()
            ->first();

        if (!$lastEndorse) {
            $this->warn("No endorse action found for transaction {$transaction->id}");
            return;
        }

        $senderOfficeId = $lastEndorse->from_office_id;
        $recipientOfficeId = $lastEndorse->to_office_id;
        $expectedDays = $transaction->currentStep?->expected_days ?? 0;

        // Create recall action
        TransactionAction::create([
            'transaction_id' => $transaction->id,
            'action_type' => TransactionAction::TYPE_RECALL,
            'from_office_id' => $recipientOfficeId,
            'to_office_id' => $senderOfficeId,
            'from_user_id' => null, // system action
            'remarks' => "Auto-recalled: endorsement expired after {$expectedDays} business day(s)",
        ]);

        // Reset transaction state
        $transaction->update([
            'current_office_id' => $senderOfficeId,
            'current_user_id' => null,
            'endorsed_at' => null,
            'received_at' => null,
            'expiry_at' => null,
        ]);

        // Fire event for notifications
        event(new EndorsementExpired($transaction, $lastEndorse, $expectedDays));
    }
}
```

### Event and Listener Pattern

```php
// app/Events/EndorsementExpired.php
class EndorsementExpired
{
    public function __construct(
        public Transaction $transaction,
        public TransactionAction $lastEndorseAction,
        public int $expectedDays
    ) {}
}

// app/Listeners/NotifyEndorsementExpired.php
class NotifyEndorsementExpired
{
    public function handle(EndorsementExpired $event): void
    {
        $transaction = $event->transaction;
        $lastEndorse = $event->lastEndorseAction;
        $expectedDays = $event->expectedDays;

        $senderOfficeId = $lastEndorse->from_office_id;
        $recipientOfficeId = $lastEndorse->to_office_id;

        // Notify sender office users
        $senderUsers = User::where('office_id', $senderOfficeId)->get();
        Notification::send($senderUsers, new EndorsementExpiredNotification(
            $transaction, $lastEndorse, $expectedDays, 'sender'
        ));

        // Notify recipient office users (excluding sender office users to avoid duplicates)
        $recipientUsers = User::where('office_id', $recipientOfficeId)
            ->where('office_id', '!=', $senderOfficeId)
            ->get();
        Notification::send($recipientUsers, new EndorsementExpiredNotification(
            $transaction, $lastEndorse, $expectedDays, 'recipient'
        ));

        // Notify administrators (excluding those already notified)
        $alreadyNotifiedIds = $senderUsers->pluck('id')
            ->merge($recipientUsers->pluck('id'));
        $admins = User::role('Administrator')
            ->whereNotIn('id', $alreadyNotifiedIds)
            ->get();
        Notification::send($admins, new EndorsementExpiredNotification(
            $transaction, $lastEndorse, $expectedDays, 'admin'
        ));
    }
}
```

### Notification Class

```php
// app/Notifications/EndorsementExpiredNotification.php
class EndorsementExpiredNotification extends Notification
{
    public function __construct(
        protected Transaction $transaction,
        protected TransactionAction $lastEndorseAction,
        protected int $expectedDays,
        protected string $recipientRole // 'sender', 'recipient', 'admin'
    ) {}

    public function via($notifiable): array
    {
        return ['database'];
    }

    public function toArray($notifiable): array
    {
        $senderOffice = $this->lastEndorseAction->fromOffice;
        $recipientOffice = $this->lastEndorseAction->toOffice;

        $message = match ($this->recipientRole) {
            'sender', 'admin' => "Transaction {$this->transaction->reference_number} has been auto-recalled — {$recipientOffice->name} did not receive it within {$this->expectedDays} business day(s)",
            'recipient' => "Transaction {$this->transaction->reference_number} has expired and returned to {$senderOffice->name} — it was not received within {$this->expectedDays} business day(s)",
        };

        return [
            'type' => 'endorsement_expired',
            'transaction_id' => $this->transaction->id,
            'reference_number' => $this->transaction->reference_number,
            'category' => $this->transaction->category,
            'sender_office_id' => $senderOffice->id,
            'sender_office_name' => $senderOffice->name,
            'recipient_office_id' => $recipientOffice->id,
            'recipient_office_name' => $recipientOffice->name,
            'expected_days' => $this->expectedDays,
            'message' => $message,
        ];
    }
}
```

### Migration

```php
// database/migrations/xxxx_xx_xx_add_expiry_at_and_recall_action_type.php
public function up(): void
{
    Schema::table('transactions', function (Blueprint $table) {
        $table->timestamp('expiry_at')->nullable()->after('endorsed_at');
    });

    // Add 'recall' to action_type enum
    DB::statement("ALTER TABLE transaction_actions MODIFY COLUMN action_type ENUM('endorse', 'receive', 'complete', 'hold', 'cancel', 'bypass', 'recall') NOT NULL");
}
```

### Expiry Countdown Component

```tsx
// In Show pages (PR/PO/VCH)
function EndorsementExpiryInfo({ transaction }: { transaction: Transaction }) {
    if (!transaction.expiry_at || transaction.received_at) return null;

    const expiryDate = new Date(transaction.expiry_at);
    const now = new Date();
    const daysRemaining = Math.ceil(
        (expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)
    );

    const colorClass = daysRemaining <= 0
        ? 'text-red-600 bg-red-50'
        : daysRemaining <= 2
            ? 'text-yellow-600 bg-yellow-50'
            : 'text-green-600 bg-green-50';

    return (
        <div className={`rounded-md p-3 ${colorClass}`}>
            {daysRemaining <= 0
                ? 'Endorsement has expired — awaiting auto-recall'
                : `Expires in ~${daysRemaining} day(s) (${format(expiryDate, 'MMM d, yyyy')})`
            }
        </div>
    );
}
```

### Reference Files

- EndorsementService: `app/Services/EndorsementService.php` (Story 3.4)
- EtaCalculationService: `app/Services/EtaCalculationService.php` (Story 3.9)
- TransactionAction model: `app/Models/TransactionAction.php` (Story 3.3)
- Transaction model: `app/Models/Transaction.php` (Story 2.1)
- OutOfWorkflowNotification pattern: `app/Notifications/OutOfWorkflowNotification.php` (Story 3.8)
- CheckOverdue command pattern: `app/Console/Commands/CheckOverdueTransactions.php` (Story 4.2.1)
- NotificationBell: `resources/js/Components/NotificationBell.tsx` (Story 3.8)
- Transaction detail pages: `resources/js/Pages/PurchaseRequests/Show.tsx`, `PurchaseOrders/Show.tsx`, `Vouchers/Show.tsx`

### Story Dependencies

**Depends on**:
- Story 3.4 (Endorse Action) — endorsement flow, `EndorsementService::endorse()`
- Story 3.5 (Receive Action) — receive clears expiry, `EndorsementService::receive()`
- Story 3.9 (ETA & Delay Calculations) — reuse `EtaCalculationService::addBusinessDays()`
- Story 3.8 (Out-of-Workflow Detection & Notifications) — notification infrastructure, bell icon, notification patterns
- Story 4.2.1 (Additional Notification Types) — overdue command pattern, notification type patterns

**Blocks**:
- None (terminal feature)

---

## Tasks

### Task 1: Create Migration for `expiry_at` Column and `recall` Action Type
**Estimate**: 20 minutes
- Create migration adding nullable `expiry_at` timestamp to `transactions` table (after `endorsed_at`)
- Alter `action_type` enum on `transaction_actions` to include `recall`
- Add `expiry_at` to `$fillable` and `$casts` on Transaction model
- Add `TYPE_RECALL` constant and update `TYPES` array on TransactionAction model
- Run migration

**Verification**: Migration runs cleanly, columns exist in database

### Task 2: Update EndorsementService — Set Expiry on Endorse
**Estimate**: 30 minutes
- In `EndorsementService::endorse()`, after creating the endorse action:
  - Calculate `expiry_at` using `EtaCalculationService::addBusinessDays()` with the current step's `expected_days`
  - Store `expiry_at` on the transaction
- Handle edge case: no workflow step or `expected_days` = 0 → `expiry_at` = null

**Verification**: Endorsing a transaction sets `expiry_at` in the database

### Task 3: Update EndorsementService — Clear Expiry on Receive
**Estimate**: 15 minutes
- In `EndorsementService::receive()`, set `expiry_at` to null
- Ensure receiving a transaction clears the expiry regardless of whether it was expired

**Verification**: Receiving a transaction clears `expiry_at`

### Task 4: Create CheckExpiredEndorsements Command
**Estimate**: 1 hour
- Create `app/Console/Commands/CheckExpiredEndorsements.php`
- Query for expired transactions (status = "In Progress", endorsed_at NOT NULL, received_at IS NULL, expiry_at < now)
- For each expired transaction:
  - Find last endorse action to determine sender office
  - Create recall `TransactionAction`
  - Reset transaction state (current_office_id, endorsed_at, received_at, expiry_at)
  - Fire `EndorsementExpired` event
- Register in scheduler (daily or hourly)
- Add console output for monitoring

**Verification**: `php artisan opts:check-expired-endorsements` runs and recalls expired endorsements

### Task 5: Create Event, Listener, and Notification
**Estimate**: 45 minutes
- Create `app/Events/EndorsementExpired.php` — carries Transaction, last endorse action, expected_days
- Create `app/Listeners/NotifyEndorsementExpired.php` — sends notifications to sender office, recipient office, and admins (deduplicated)
- Create `app/Notifications/EndorsementExpiredNotification.php` — database channel, role-aware messaging
- Laravel auto-discovery handles event registration

**Verification**: Running the command on expired endorsements sends notifications to correct users

### Task 6: Update TypeScript Interfaces
**Estimate**: 15 minutes
- Add `expiry_at: string | null` to Transaction interface in `resources/js/types/models.ts`
- Add `'recall'` to ActionType union type
- Add `'endorsement_expired'` to notification type constants

**Verification**: TypeScript compiles cleanly

### Task 7: Update Transaction Detail Pages — Expiry Display
**Estimate**: 45 minutes
- Create an `EndorsementExpiryInfo` component (or inline in Show pages)
- Show expiry countdown when transaction is endorsed but not received and `expiry_at` is set
- Color-coded: green (3+ days), yellow (1-2 days), red (expired/today)
- Add to `PurchaseRequests/Show.tsx`, `PurchaseOrders/Show.tsx`, `Vouchers/Show.tsx`

**Verification**: Detail pages show expiry info for endorsed-unreceived transactions

### Task 8: Update Endorse Page — Expiry Info
**Estimate**: 20 minutes
- On `Transactions/Endorse.tsx`, show read-only informational text about the expiry period
- Display: "The receiving office has {expected_days} business day(s) to receive this document before it auto-recalls"
- Only show when the workflow step has `expected_days` > 0

**Verification**: Endorse page shows expiry information

### Task 9: Update NotificationBell and Notifications Page
**Estimate**: 20 minutes
- Add `endorsement_expired` type to `NotificationBell.tsx` icon mapping (orange `Timer`/`TimerOff` icon)
- Add `endorsement_expired` option to type filter dropdown on `Notifications/Index.tsx`

**Verification**: New notification type renders with correct icon and is filterable

### Task 10: Write Unit Tests
**Estimate**: 1.5 hours
- Create `tests/Unit/Services/EndorsementExpiryTest.php`:
  - Test expiry_at calculated correctly on endorsement (business days)
  - Test expiry_at set to null when expected_days is 0
  - Test expiry_at cleared on receive
  - Test CheckExpiredEndorsements finds only eligible transactions
  - Test recall action created correctly
  - Test transaction state reset after recall
  - Test sender office resolved correctly from last endorse action
  - Test EndorsementExpiredNotification toArray output for sender role
  - Test EndorsementExpiredNotification toArray output for recipient role

**Verification**:
```bash
php artisan test --filter=EndorsementExpiry
```

### Task 11: Write Feature Tests
**Estimate**: 1 hour
- Create `tests/Feature/EndorsementExpiryTest.php`:
  - Test full endorsement → expiry → recall flow
  - Test endorsement → receive clears expiry (no recall)
  - Test command is idempotent (running twice doesn't double-recall)
  - Test notifications sent to sender office users
  - Test notifications sent to recipient office users
  - Test notifications sent to administrators (deduplicated)
  - Test transaction with no workflow step doesn't get expiry_at
  - Test recall action appears in transaction action history

**Verification**:
```bash
php artisan test --filter=EndorsementExpiry
```

---

## Acceptance Checklist

- [ ] `expiry_at` column added to transactions table
- [ ] `recall` action type added to transaction_actions enum
- [ ] Endorsing sets `expiry_at` based on workflow step's `expected_days`
- [ ] Endorsing with no expected_days does not set `expiry_at`
- [ ] Receiving clears `expiry_at`
- [ ] `opts:check-expired-endorsements` command finds expired endorsements
- [ ] Expired endorsements create recall action
- [ ] Transaction state reset (current_office_id, endorsed_at, received_at, expiry_at)
- [ ] Sender office users notified of auto-recall
- [ ] Recipient office users notified of expiry
- [ ] Administrators notified (deduplicated)
- [ ] Notification type `endorsement_expired` renders with correct icon
- [ ] Notifications page filter includes `endorsement_expired`
- [ ] Transaction detail pages show expiry countdown
- [ ] Endorse page shows expiry period information
- [ ] Command registered in scheduler
- [ ] Unit tests pass
- [ ] Feature tests pass

**Definition of Done**: Endorsed-but-unreceived transactions automatically return to the sender's office after the workflow step's expected days have elapsed, with both offices and administrators notified of the expiry via the in-app notification system.

---

## Dev Agent Record

**Story**: 3.12 - Endorsement Expiry & Auto-Recall
**Status**: Draft
**Assigned**:
**Start Date**:
**Completion Date**:

### Files Created
- [ ] `app/Console/Commands/CheckExpiredEndorsements.php`
- [ ] `app/Events/EndorsementExpired.php`
- [ ] `app/Listeners/NotifyEndorsementExpired.php`
- [ ] `app/Notifications/EndorsementExpiredNotification.php`
- [ ] `tests/Unit/Services/EndorsementExpiryTest.php`
- [ ] `tests/Feature/EndorsementExpiryTest.php`

### Files Modified
- [ ] `app/Models/Transaction.php` — Add `expiry_at` to fillable/casts
- [ ] `app/Models/TransactionAction.php` — Add `TYPE_RECALL` constant, update TYPES array
- [ ] `app/Services/EndorsementService.php` — Set expiry on endorse, clear on receive
- [ ] `resources/js/types/models.ts` — Add `expiry_at`, `recall` action type
- [ ] `resources/js/Pages/PurchaseRequests/Show.tsx` — Expiry countdown display
- [ ] `resources/js/Pages/PurchaseOrders/Show.tsx` — Expiry countdown display
- [ ] `resources/js/Pages/Vouchers/Show.tsx` — Expiry countdown display
- [ ] `resources/js/Pages/Transactions/Endorse.tsx` — Expiry info display
- [ ] `resources/js/Components/NotificationBell.tsx` — Add endorsement_expired icon
- [ ] `resources/js/Pages/Notifications/Index.tsx` — Add endorsement_expired filter
- [ ] `database/migrations/` — New migration for expiry_at + recall enum
- [ ] `routes/console.php` — Register scheduled command

### Test Results
*(To be filled by Dev Agent)*

### Implementation Notes
*(To be filled by Dev Agent)*

### Time Log
*(To be filled by Dev Agent)*

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
