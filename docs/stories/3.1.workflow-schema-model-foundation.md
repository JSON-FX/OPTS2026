# Story 3.1: Workflow Schema & Model Foundation

**Status**: Done
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As a developer, I need database tables and Eloquent models for workflow definitions with ordered office steps and expected completion days, so that the system can store and manage category-specific transaction routing configurations.

---

## Acceptance Criteria

1. **Workflow Steps Table Migration**: Migration created for `workflow_steps` table with columns:

    - `id` (primary key, auto-increment)
    - `workflow_id` (foreign key to workflows)
    - `office_id` (foreign key to offices)
    - `step_order` (integer, unsigned) - position in workflow sequence
    - `expected_days` (integer, unsigned) - SLA days to complete this step
    - `is_final_step` (boolean, default: false) - marks the last step in workflow
    - `created_at`, `updated_at`
    - Foreign key constraints with ON DELETE CASCADE for workflow_id, ON DELETE RESTRICT for office_id
    - Unique index on (`workflow_id`, `step_order`)
    - Unique index on (`workflow_id`, `office_id`) - each office appears once per workflow

2. **Workflow Table Enhancement**: Migration to alter existing `workflows` table adding:

    - `description` (text, nullable) - optional workflow description
    - `created_by_user_id` (foreign key to users, nullable)
    - Index on `created_by_user_id`

3. **Workflow Eloquent Model**: `app/Models/Workflow.php` created with:

    - Fillable: `category`, `name`, `description`, `is_active`, `created_by_user_id`
    - Relationships: `hasMany(WorkflowStep::class)`, `belongsTo(User::class, 'created_by_user_id')`
    - Scope: `scopeActive($query)` - filter by `is_active = true`
    - Scope: `scopeForCategory($query, $category)` - filter by transaction category
    - Accessor: `getStepsCountAttribute()` - returns count of workflow steps
    - Method: `getFirstStep()` - returns first WorkflowStep by step_order
    - Method: `getLastStep()` - returns final WorkflowStep (is_final_step = true)
    - Method: `getStepByOrder($order)` - returns WorkflowStep at given position
    - Method: `getNextStep($currentStepOrder)` - returns next WorkflowStep or null if at end

4. **WorkflowStep Eloquent Model**: `app/Models/WorkflowStep.php` created with:

    - Fillable: `workflow_id`, `office_id`, `step_order`, `expected_days`, `is_final_step`
    - Relationships: `belongsTo(Workflow::class)`, `belongsTo(Office::class)`
    - Scope: `scopeOrdered($query)` - order by `step_order ASC`
    - Accessor: `getIsFirstStepAttribute()` - returns true if step_order === 1
    - Method: `getNextStep()` - returns next WorkflowStep in same workflow or null
    - Method: `getPreviousStep()` - returns previous WorkflowStep or null

5. **TypeScript Interfaces**: Interfaces defined in `resources/js/types/models.ts`:

    ```typescript
    interface Workflow {
        id: number;
        category: TransactionCategory;
        name: string;
        description: string | null;
        is_active: boolean;
        created_by_user_id: number | null;
        created_at: string;
        updated_at: string;
        steps?: WorkflowStep[];
        steps_count?: number;
        created_by?: User;
    }

    interface WorkflowStep {
        id: number;
        workflow_id: number;
        office_id: number;
        step_order: number;
        expected_days: number;
        is_final_step: boolean;
        created_at: string;
        updated_at: string;
        workflow?: Workflow;
        office?: Office;
    }
    ```

6. **Model Factory**: `database/factories/WorkflowFactory.php` and `WorkflowStepFactory.php` created for testing

7. **Database Seeder Enhancement**: Update `WorkflowSeeder.php` to create sample workflows with steps:

    - PR Workflow: 5 steps (Originating Office → Budget → BAC → Accounting → Releasing)
    - PO Workflow: 4 steps (Originating Office → BAC → Accounting → Releasing)
    - VCH Workflow: 3 steps (Originating Office → Accounting → Cashier)
    - Each step with realistic expected_days (1-5 days)

8. **Migration Rollback**: Each migration includes proper `down()` method

9. **Test Coverage**: Feature tests verify:

    - Workflow-WorkflowStep relationship (cascade delete)
    - Unique constraints on step_order and office within workflow
    - Model methods (getFirstStep, getNextStep, etc.)
    - Factory-generated data validity

10. **Documentation**: Migration files include comments explaining workflow engine purpose

---

## Dev Notes

### Workflow Engine Concept

The workflow engine defines how transactions move through offices:

```
Workflow (PR)
├── Step 1: Originating Office (expected: 1 day)
├── Step 2: Budget Office (expected: 2 days)
├── Step 3: BAC Office (expected: 3 days)
├── Step 4: Accounting Office (expected: 2 days)
└── Step 5: Releasing Office (expected: 1 day) [FINAL]
```

Each transaction follows its assigned workflow. The `expected_days` per step enables ETA calculations and delay detection.

### Existing Schema Context

From Story 2.1, the `transactions` table already has:

-   `workflow_id` (FK to workflows, nullable)
-   `current_office_id` (FK to offices, nullable)
-   `current_user_id` (FK to users, nullable)

The placeholder `workflows` table (from Story 2.1) has:

-   `id`, `category`, `name`, `is_active`, timestamps

This story extends workflows with steps and enhances the model layer.

### Migration File Naming

```
2025_11_XX_000100_add_workflow_columns.php
2025_11_XX_000200_create_workflow_steps_table.php
```

### Key Design Decisions

1. **One Office Per Workflow**: Each office can only appear once in a workflow (unique constraint). This simplifies routing logic.

2. **Step Order**: Integer-based ordering (1, 2, 3...) allows inserting steps via renumbering. The `getNextStep` method uses step_order + 1 logic.

3. **Final Step Flag**: Explicit `is_final_step` boolean rather than relying on "last by order" allows flexibility for workflows that might branch (future enhancement).

4. **Cascade Delete**: Deleting a workflow cascades to delete its steps. Workflows should be deactivated (soft) rather than deleted if transactions reference them.

### Reference Files

-   Existing workflow migration: `database/migrations/2025_10_31_115900_create_workflows_table.php`
-   Transaction table with workflow_id: Story 2.1
-   Office model: `app/Models/Office.php`

### Story Dependencies

**Depends on**:

-   Story 1.4 (Office Repository Management) - requires offices table
-   Story 2.1 (Database Schema) - requires workflows placeholder table

**Blocks**:

-   Story 3.2 (Workflow Admin Management UI)
-   Story 3.3 (Transaction Actions Schema)
-   Story 3.11 (Workflow Assignment on Transaction Creation)

---

## Tasks

### Task 1: Create Workflow Table Enhancement Migration

**Estimate**: 20 minutes

-   Create migration file to alter `workflows` table
-   Add `description` (text, nullable)
-   Add `created_by_user_id` (FK to users, nullable)
-   Add index on `created_by_user_id`
-   Define `down()` method to reverse changes

**Verification**:

```bash
php artisan migrate --pretend
```

### Task 2: Create Workflow Steps Migration

**Estimate**: 30 minutes

-   Create migration file for `workflow_steps` table
-   Define all columns per AC#1
-   Add foreign key constraints (CASCADE for workflow, RESTRICT for office)
-   Add unique indexes on (workflow_id, step_order) and (workflow_id, office_id)
-   Define `down()` method

**Verification**:

```bash
php artisan migrate --pretend
```

### Task 3: Create/Update Workflow Model

**Estimate**: 45 minutes

-   Create or update `app/Models/Workflow.php`
-   Define fillable array with all fields
-   Implement relationships: `steps()`, `createdBy()`
-   Implement scopes: `scopeActive()`, `scopeForCategory()`
-   Implement accessor: `getStepsCountAttribute()`
-   Implement methods: `getFirstStep()`, `getLastStep()`, `getStepByOrder()`, `getNextStep()`
-   Add PHPDoc comments

**Verification**:

```bash
php artisan tinker
# Test: Workflow::first()->steps
```

### Task 4: Create WorkflowStep Model

**Estimate**: 30 minutes

-   Create `app/Models/WorkflowStep.php`
-   Define fillable array
-   Implement relationships: `workflow()`, `office()`
-   Implement scope: `scopeOrdered()`
-   Implement accessor: `getIsFirstStepAttribute()`
-   Implement methods: `getNextStep()`, `getPreviousStep()`
-   Add PHPDoc comments

**Verification**:

```bash
php artisan tinker
# Test: WorkflowStep::first()->office
```

### Task 5: Create Model Factories

**Estimate**: 30 minutes

-   Create `database/factories/WorkflowFactory.php`
    -   Generate realistic workflow names per category
    -   Set is_active default to true
-   Create `database/factories/WorkflowStepFactory.php`
    -   Generate step_order sequentially
    -   Set expected_days between 1-5
    -   Handle is_final_step based on context

**Verification**:

```bash
php artisan tinker
# Test: Workflow::factory()->hasSteps(5)->create()
```

### Task 6: Update Database Seeder

**Estimate**: 45 minutes

-   Update or create `database/seeders/WorkflowSeeder.php`
-   Create sample workflows for each category (PR, PO, VCH)
-   Create realistic workflow steps with proper ordering
-   Set appropriate expected_days for each office type
-   Mark final steps correctly

**Verification**:

```bash
php artisan db:seed --class=WorkflowSeeder
```

### Task 7: Add TypeScript Interfaces

**Estimate**: 20 minutes

-   Update `resources/js/types/models.ts`
-   Add `Workflow` interface with all fields
-   Add `WorkflowStep` interface with all fields
-   Ensure proper typing for relationships

**Verification**:

```bash
npm run build # TypeScript compilation check
```

### Task 8: Write Feature Tests

**Estimate**: 1 hour

-   Create `tests/Feature/Models/WorkflowTest.php`:
    -   Test workflow-step relationship
    -   Test cascade delete behavior
    -   Test `getFirstStep()`, `getNextStep()` methods
    -   Test scopes (active, forCategory)
-   Create `tests/Feature/Models/WorkflowStepTest.php`:
    -   Test step-workflow relationship
    -   Test step-office relationship
    -   Test unique constraints
    -   Test `getNextStep()`, `getPreviousStep()` methods
-   Create `tests/Feature/Migrations/WorkflowStepsTableTest.php`:
    -   Test table structure
    -   Test indexes and constraints

**Verification**:

```bash
php artisan test --filter=Workflow
```

### Task 9: Run Migrations and Verify

**Estimate**: 15 minutes

-   Run migrations: `php artisan migrate`
-   Run seeders: `php artisan db:seed --class=WorkflowSeeder`
-   Verify relationships work in tinker
-   Run full test suite

**Verification**:

```bash
php artisan migrate:fresh --seed
php artisan test
```

---

## Acceptance Checklist

-   [ ] Workflow table enhanced with description and created_by_user_id columns
-   [ ] workflow_steps table created with all columns and constraints
-   [ ] Unique indexes enforce one office per workflow and sequential ordering
-   [ ] Workflow model implements all relationships, scopes, and methods
-   [ ] WorkflowStep model implements all relationships, scopes, and methods
-   [ ] Model factories generate valid test data
-   [ ] Seeder creates realistic sample workflows for PR, PO, VCH
-   [ ] TypeScript interfaces match database schema
-   [ ] Feature tests cover model methods and relationships
-   [ ] All existing tests continue to pass
-   [ ] Migration rollbacks work correctly

**Definition of Done**: All acceptance criteria met, all tests passing, workflows with ordered steps can be created and queried with proper navigation between steps.

---

## Dev Agent Record

**Story**: 3.1 - Workflow Schema & Model Foundation
**Status**: Ready for Review
**Assigned**: James (Dev Agent)
**Agent Model Used**: claude-opus-4-5-20251101
**Start Date**: 2025-12-07
**Completion Date**: 2025-12-07

### Files Created

-   [x] `database/migrations/2025_12_07_032100_add_workflow_columns.php`
-   [x] `database/migrations/2025_12_07_032200_create_workflow_steps_table.php`
-   [x] `app/Models/Workflow.php`
-   [x] `app/Models/WorkflowStep.php`
-   [x] `database/factories/WorkflowFactory.php`
-   [x] `database/factories/WorkflowStepFactory.php`
-   [x] `database/seeders/WorkflowSeeder.php`
-   [x] `tests/Feature/Models/WorkflowTest.php`
-   [x] `tests/Feature/Models/WorkflowStepTest.php`
-   [x] `tests/Feature/Migrations/WorkflowStepsTableTest.php`

### Files Modified

-   [x] `database/seeders/DatabaseSeeder.php` - Added WorkflowSeeder to call list
-   [x] `resources/js/types/models.ts` - Added Workflow and WorkflowStep interfaces

### Test Results

-   [x] Migration tests: 8 passing
-   [x] Model tests: 28 passing (WorkflowTest: 14, WorkflowStepTest: 14)
-   [x] All Workflow-related tests: 36 passing (80 assertions)
-   Note: 28 pre-existing test failures unrelated to this story (PurchaseRequest/PurchaseOrder controller validation issues)

### Implementation Notes

1. **Migrations**: Created two migrations - one to enhance the existing workflows table with `description` and `created_by_user_id` columns, and one to create the new `workflow_steps` table with proper foreign key constraints (CASCADE for workflow, RESTRICT for office).

2. **Models**: Implemented Workflow and WorkflowStep models with all required relationships, scopes, accessors, and methods per AC. The Workflow model includes navigation methods (getFirstStep, getNextStep, etc.) for workflow traversal.

3. **Factories**: Created factories with helper states (pr(), po(), vch(), inactive(), final(), order(), etc.) for flexible test data generation.

4. **Seeder**: Created WorkflowSeeder with realistic sample workflows:

    - PR Workflow (5 steps): GSO → MBO → BAC → ACCT → MTO
    - PO Workflow (4 steps): GSO → BAC → ACCT → MTO
    - VCH Workflow (3 steps): GSO → ACCT → MTO

5. **TypeScript**: Added Workflow and WorkflowStep interfaces to models.ts matching the PHP model structure.

6. **Testing**: Comprehensive tests covering relationships, cascade delete, unique constraints, model methods, and factory generation.

### Debug Log References

No blocking issues encountered.

### Change Log

| Date       | Change                 | Reason                 |
| ---------- | ---------------------- | ---------------------- |
| 2025-12-07 | Initial implementation | Story 3.1 requirements |

---

## QA Results

### Review Date: 2025-12-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - This implementation demonstrates strong adherence to Laravel conventions and clean architecture principles. The code is well-structured, properly documented with PHPDoc annotations, and follows PSR-12 standards (verified via Pint).

**Highlights:**

-   Migrations are properly documented with story reference and clear purpose
-   Models use appropriate type hints and generics for relationships
-   Factory states are well-designed for flexible test data generation
-   Test coverage is comprehensive with clear separation of concerns

### Refactoring Performed

No refactoring required - the implementation is clean and follows best practices.

### Compliance Check

-   Coding Standards: ✓ PSR-12 compliant, strict types declared, proper PHPDoc
-   Project Structure: ✓ Files in correct locations per source-tree.md
-   Testing Strategy: ✓ Feature tests for models, migrations, and factories
-   All ACs Met: ✓ All 10 acceptance criteria fully implemented

### Improvements Checklist

All items have been addressed by the developer:

-   [x] Workflow table enhancement migration with description and created_by_user_id
-   [x] workflow_steps table migration with all columns and constraints
-   [x] Unique indexes on (workflow_id, step_order) and (workflow_id, office_id)
-   [x] Workflow model with relationships, scopes, and navigation methods
-   [x] WorkflowStep model with relationships, scopes, and navigation methods
-   [x] WorkflowFactory with category-specific states (pr, po, vch)
-   [x] WorkflowStepFactory with fluent state methods
-   [x] WorkflowSeeder with realistic sample data for PR/PO/VCH
-   [x] TypeScript interfaces in models.ts
-   [x] Comprehensive feature tests (36 tests, 80 assertions)
-   [x] Migration rollback verified working

### Security Review

**Status: PASS** - No security concerns identified.

-   Foreign key constraints properly enforce referential integrity
-   CASCADE delete on workflow prevents orphaned steps
-   RESTRICT delete on office prevents accidental data loss
-   No user input validation required (schema/model layer only)

### Performance Considerations

**Status: PASS** - Efficient design patterns used.

-   Indexes on all foreign keys for query optimization
-   Unique composite indexes support efficient lookups
-   `steps()` relationship includes default ordering (no N+1)
-   Model accessors use efficient single queries

**Future Consideration:** For high-traffic scenarios, consider caching workflow lookups since workflows change infrequently.

### Files Modified During Review

No files were modified during this review.

### Gate Status

**Gate: PASS** → docs/qa/gates/3.1-workflow-schema-model-foundation.yml
**Quality Score: 95/100**

### Requirements Traceability

| AC# | Requirement                    | Test Coverage                                                                               |
| --- | ------------------------------ | ------------------------------------------------------------------------------------------- |
| 1   | workflow_steps table migration | WorkflowStepsTableTest (8 tests)                                                            |
| 2   | workflows table enhancement    | test_workflows_table_has_new_columns                                                        |
| 3   | Workflow Eloquent Model        | WorkflowTest (14 tests)                                                                     |
| 4   | WorkflowStep Eloquent Model    | WorkflowStepTest (14 tests)                                                                 |
| 5   | TypeScript Interfaces          | npm run build verification                                                                  |
| 6   | Model Factories                | test_workflow_factory_generates_valid_data, test_workflow_step_factory_generates_valid_data |
| 7   | Database Seeder                | php artisan migrate:fresh --seed                                                            |
| 8   | Migration Rollback             | php artisan migrate:rollback --step=2                                                       |
| 9   | Test Coverage                  | 36 tests, 80 assertions                                                                     |
| 10  | Documentation                  | PHPDoc in migrations and models                                                             |

### Recommended Status

**✓ Ready for Done** - All acceptance criteria met, comprehensive test coverage, clean implementation following project standards. Story owner may proceed to mark as Done.
