# Story 4.1.3: Dashboard SLA Performance Panel

**Status**: Done
**Epic**: Epic 4.1 - Dashboard & Summary Views
**Story Statement**: As an Administrator or Endorser, I want to see SLA performance metrics on the dashboard, so that I can identify bottleneck offices and monitor workflow efficiency.

---

## Acceptance Criteria

1. **SLA Performance Section**: Dashboard displays a "Performance" panel showing:
   - **Average Turnaround Time by Office**: For each office that handles transactions, show:
     - Office name
     - Average business days to process (from receive to next endorse/complete)
     - Expected days (from workflow step definition)
     - Performance indicator: green (avg <= expected), yellow (avg <= expected*1.5), red (avg > expected*1.5)
   - Only offices with completed actions in the last 30 days shown
   - Sortable by average turnaround or office name

2. **Out-of-Workflow Incident Summary**:
   - Current month count of out-of-workflow endorsements
   - Previous month count for comparison
   - Trend indicator (up/down arrow with percentage change)
   - Clicking count navigates to notification page filtered by `out_of_workflow`

3. **Transaction Volume Summary**:
   - Current month vs previous month transaction creation counts
   - Broken down by category (PR, PO, VCH)
   - Trend indicators per category
   - Visual: simple bar comparison or numeric with trend arrow

4. **Role-Based Visibility**:
   - **Administrator**: sees full performance data for all offices
   - **Endorser**: sees all offices but own office row highlighted
   - **Viewer**: sees performance data (read-only, no action links)

5. **TypeScript Interfaces**: Add to types:
   ```typescript
   interface OfficePerformance {
     office_id: number;
     office_name: string;
     office_abbreviation: string;
     avg_turnaround_days: number;
     expected_days: number;
     performance_rating: 'good' | 'warning' | 'poor';
     actions_count: number; // number of completed actions in period
   }

   interface IncidentSummary {
     current_month: number;
     previous_month: number;
     trend_percentage: number; // positive = increase, negative = decrease
   }

   interface VolumeSummary {
     category: TransactionCategory;
     current_month: number;
     previous_month: number;
     trend_percentage: number;
   }

   interface SlaPerformanceData {
     office_performance: OfficePerformance[];
     incidents: IncidentSummary;
     volume: VolumeSummary[];
   }
   ```

6. **Performance**: SLA calculations use efficient aggregate queries:
   - Use database-level `AVG()` and `COUNT()` with `GROUP BY`
   - Filter to last 30/60 days to keep queries fast
   - No N+1 loading patterns

7. **Dashboard Integration**: Panel fits into existing dashboard layout:
   - Positioned below the Activity Feed + Stagnant Panel row
   - Full-width section with sub-panels for Office Performance, Incidents, and Volume
   - Responsive: sub-panels stack vertically on mobile

---

## Tasks / Subtasks

- [x] Task 1: Extend DashboardService with SLA performance methods (AC: 1, 6)
  - [x] Add `getOfficePerformance(int $days = 30)` to `DashboardService`
  - [x] Query `transaction_actions` for receive→endorse/complete pairs, calculate average turnaround per office
  - [x] Join with `workflow_steps` to get `expected_days` per office step
  - [x] Compute performance rating based on avg vs expected
  - [x] Unit test: verify turnaround calculation accuracy

- [x] Task 2: Add incident summary method (AC: 2, 6)
  - [x] Add `getIncidentSummary()` to `DashboardService`
  - [x] Count out-of-workflow actions in current month and previous month
  - [x] Calculate trend percentage
  - [x] Unit test: verify month-over-month comparison

- [x] Task 3: Add volume summary method (AC: 3, 6)
  - [x] Add `getVolumeSummary()` to `DashboardService`
  - [x] Count transactions created in current month vs previous month, grouped by category
  - [x] Calculate trend percentages
  - [x] Unit test: verify counts and trends

- [x] Task 4: Extend DashboardController (AC: 4, 7)
  - [x] Add `sla_performance` data to Inertia props in `index()`
  - [x] Include `OfficePerformance[]`, `IncidentSummary`, `VolumeSummary[]`

- [x] Task 5: Add TypeScript interfaces (AC: 5)
  - [x] Add `OfficePerformance`, `IncidentSummary`, `VolumeSummary`, `SlaPerformanceData` to types

- [x] Task 6: Build Office Performance table component (AC: 1, 4)
  - [x] Create `resources/js/Components/OfficePerformanceTable.tsx`
  - [x] Table with columns: Office, Avg Days, Expected Days, Performance, Actions Count
  - [x] Performance indicator: green/yellow/red badge or icon
  - [x] Sortable columns
  - [x] Highlight current user's office

- [x] Task 7: Build Incident & Volume summary components (AC: 2, 3)
  - [x] Create `resources/js/Components/IncidentSummaryCard.tsx` — current vs previous month with trend
  - [x] Create `resources/js/Components/VolumeSummaryCard.tsx` — per-category current vs previous with trends
  - [x] Trend arrows: green down-arrow for incidents (fewer is better), category-neutral trend for volume
  - [x] Clickable incident count → notification page

- [x] Task 8: Integrate into Dashboard layout (AC: 7)
  - [x] Add SLA performance section to `Dashboard.tsx`
  - [x] Layout: 3 sub-panels in a grid (Office Performance table full-width, Incidents + Volume side by side)
  - [x] Section heading: "Performance Metrics"
  - [x] Responsive stacking

- [x] Task 9: Write feature tests (AC: 1-4, 6)
  - [x] Extend `tests/Feature/DashboardTest.php`
  - [x] Test SLA performance data in Inertia props
  - [x] Test office performance calculation with known data
  - [x] Test incident summary month-over-month
  - [x] Test volume summary by category
  - [x] Test empty state (no data in period)

---

## Dev Notes

### Existing Source Files to Reference

- **DashboardController**: `app/Http/Controllers/DashboardController.php` (from Story 4.1.1)
- **DashboardService**: `app/Services/DashboardService.php` (from Story 4.1.1, extended in 4.1.2)
- **TransactionAction model**: `app/Models/TransactionAction.php` — `action_type`, timestamps, office relationships
- **WorkflowStep model**: `app/Models/WorkflowStep.php` — `expected_days`, `office_id`, `step_order`
- **EtaCalculationService**: `app/Services/EtaCalculationService.php` — `businessDaysBetween()` for turnaround calculation
- **Dashboard page**: `resources/js/Pages/Dashboard.tsx` (from Stories 4.1.1 + 4.1.2)
- **Out-of-workflow data**: `transaction_actions.is_out_of_workflow` column
- **Notification routes**: `/notifications?type=out_of_workflow` for incident drill-down link

### Average Turnaround Calculation

Turnaround per office = time between a `receive` action at that office and the subsequent `endorse` or `complete` action from that office.

```php
// Find pairs: receive_at_office → next_endorse_from_office
// Using transaction_actions:
// 1. Get 'receive' actions with to_office_id = office
// 2. For each, find the next 'endorse'/'complete' action with from_office_id = office on same transaction
// 3. Calculate business days between

// Efficient approach: use a subquery or self-join
$turnarounds = DB::table('transaction_actions as receive')
    ->join('transaction_actions as action', function ($join) {
        $join->on('receive.transaction_id', '=', 'action.transaction_id')
            ->where('action.id', '>', DB::raw('receive.id'))
            ->whereIn('action.action_type', ['endorse', 'complete']);
    })
    ->where('receive.action_type', 'receive')
    ->where('receive.created_at', '>=', now()->subDays(30))
    ->select(
        'receive.to_office_id as office_id',
        DB::raw('AVG(DATEDIFF(action.created_at, receive.created_at)) as avg_calendar_days'),
        DB::raw('COUNT(*) as actions_count')
    )
    ->groupBy('receive.to_office_id')
    ->get();
```

Note: This gives calendar days — to convert to business days, multiply by ~5/7 as approximation, or compute precisely for each pair.

### Performance Rating Logic

```php
$rating = match(true) {
    $avgDays <= $expectedDays => 'good',
    $avgDays <= $expectedDays * 1.5 => 'warning',
    default => 'poor',
};
```

### Month Boundary Queries

```php
$currentMonthStart = now()->startOfMonth();
$previousMonthStart = now()->subMonth()->startOfMonth();
$previousMonthEnd = now()->subMonth()->endOfMonth();
```

### Testing

- **Test file**: `tests/Feature/DashboardTest.php` (extend from 4.1.1 and 4.1.2)
- **Testing framework**: PHPUnit/Pest with `RefreshDatabase`
- **Key test data setup**:
  - Create transactions with actions at specific dates to produce known turnaround times
  - Create out-of-workflow actions in current and previous months for incident counts
  - Create transactions in both months for volume comparison
- **Assertion patterns**: Verify computed averages match expected values within tolerance
- **TypeScript**: Run `npx tsc --noEmit` to verify compile

### Dependencies

- **Story 4.1.1** must be completed first (DashboardController, DashboardService, Dashboard.tsx exist)
- **Story 4.1.2** should be completed first (dashboard layout with Activity Feed and Stagnant Panel established)
- **Story 3.8** (out-of-workflow data — already Done)
- **Story 3.9** (ETA calculations — already Done)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-16 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
- Fixed SQLite/MySQL compatibility: replaced `DATEDIFF` SQL with PHP-based business day calculation using `EtaCalculationService::businessDaysBetween()`
- Fixed float/int assertion mismatch in tests: PHP `round()` returns float but JSON serialization converts whole-number floats to int

### Completion Notes List
- All 9 tasks completed, all 22 DashboardTest tests pass (6 new tests added for 4.1.3)
- TypeScript compiles clean (`npx tsc --noEmit`)
- PHP Pint formatting applied
- Office performance uses actual business days (via EtaCalculationService) instead of calendar day approximation
- Component naming: used `IncidentSummaryCard.tsx` and `VolumeSummaryCard.tsx` (suffixed with Card) to avoid name collision with TypeScript interface

### File List
- `app/Services/DashboardService.php` — Added `getOfficePerformance()`, `getIncidentSummary()`, `getVolumeSummary()` methods
- `app/Http/Controllers/DashboardController.php` — Added `slaPerformance` Inertia prop
- `resources/js/types/models.ts` — Added `OfficePerformance`, `IncidentSummary`, `VolumeSummary`, `SlaPerformanceData` interfaces
- `resources/js/Components/OfficePerformanceTable.tsx` — New: sortable office performance table with rating badges
- `resources/js/Components/IncidentSummaryCard.tsx` — New: out-of-workflow incident card with trend indicator and clickable count
- `resources/js/Components/VolumeSummaryCard.tsx` — New: transaction volume per-category card with trend arrows
- `resources/js/Pages/Dashboard.tsx` — Added Performance Metrics section with all three sub-panels
- `tests/Feature/DashboardTest.php` — Added 6 tests for SLA performance panel

### Change Log
| Date | Change | Details |
|------|--------|---------|
| 2026-02-18 | Implemented all 9 tasks | Backend service methods, controller, TS types, 3 React components, dashboard integration, feature tests |

---

## QA Results
*(To be filled by QA agent)*
