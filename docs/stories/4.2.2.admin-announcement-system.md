# Story 4.2.2: Admin Announcement System

**Status**: Draft
**Epic**: Epic 4.2 - Notification System Expansion
**Story Reference**: `/Users/jsonse/Documents/development/opts2026/docs/prd/epic-4.2-notification-system-expansion.md`

---

## Story

**As an** Administrator,
**I want** to create announcements with severity levels that display as banners and notifications,
**so that** I can communicate important information to all system users.

---

## Acceptance Criteria

1. **`announcements` Migration**: A new `announcements` table exists with the following columns:
   - `id` (auto-increment primary key)
   - `title` (string, 255, required)
   - `body` (text, required)
   - `severity` (enum: `Normal`, `Advisory`, `Emergency`, default `Normal`)
   - `is_active` (boolean, default `false`)
   - `starts_at` (nullable timestamp)
   - `ends_at` (nullable timestamp)
   - `created_by_user_id` (foreign key → `users.id`, restrict on delete)
   - `timestamps()`

2. **`Announcement` Model**: `app/Models/Announcement.php` exists with:
   - `$fillable` covering all writable columns
   - `$casts` for `is_active` (boolean), `starts_at` / `ends_at` (datetime), `severity` (string)
   - `scopeActive()` — filters where `is_active = true`
   - `scopeCurrent()` — filters where active AND (`starts_at` is null OR `starts_at <= now()`) AND (`ends_at` is null OR `ends_at >= now()`)
   - `createdBy()` BelongsTo relationship to `User`

3. **`AnnouncementController` CRUD**: `app/Http/Controllers/Admin/AnnouncementController.php` exists with:
   - `index()` — lists all announcements ordered by `created_at desc`, paginated 20 per page, Administrator-only
   - `create()` — renders the create form page
   - `store(StoreAnnouncementRequest $request)` — validates and creates announcement, sets `created_by_user_id = auth()->id()`, redirects to index with success flash
   - `edit(Announcement $announcement)` — renders the edit form page
   - `update(UpdateAnnouncementRequest $request, Announcement $announcement)` — validates and updates, redirects to index with success flash
   - `destroy(Announcement $announcement)` — deletes announcement, redirects to index with success flash
   - All methods are restricted to the `Administrator` role via route middleware

4. **Form Request Validation**: Two form request classes exist:
   - `app/Http/Requests/StoreAnnouncementRequest.php`: `title` (required, string, max:255), `body` (required, string), `severity` (required, in: Normal,Advisory,Emergency), `is_active` (boolean), `starts_at` (nullable, date), `ends_at` (nullable, date, after_or_equal:starts_at)
   - `app/Http/Requests/UpdateAnnouncementRequest.php`: Same rules as Store

5. **Admin Announcements Management Page**: Three Inertia page components exist at `resources/js/Pages/Admin/Announcements/`:
   - `Index.tsx` — table listing all announcements with columns: Title, Severity (badge), Status (Active/Inactive badge), Start Date, End Date, Created By, Actions (Edit/Delete). Includes "New Announcement" button. Follows exact visual pattern of `resources/js/Pages/Admin/Workflows/Index.tsx`.
   - `Create.tsx` — form with fields: Title (text input), Body (textarea), Severity (select: Normal/Advisory/Emergency), Is Active (switch/toggle), Starts At (date input, optional), Ends At (date input, optional). Uses `useForm` from `@inertiajs/react`. Follows pattern of `resources/js/Pages/Admin/Workflows/Create.tsx`.
   - `Edit.tsx` — same fields as Create, pre-populated with existing values.

6. **Routes**: The following named routes are registered in `routes/web.php` under the `auth` + `role:Administrator` middleware group:
   ```
   admin.announcements.index    GET    /admin/announcements
   admin.announcements.create   GET    /admin/announcements/create
   admin.announcements.store    POST   /admin/announcements
   admin.announcements.edit     GET    /admin/announcements/{announcement}/edit
   admin.announcements.update   PUT    /admin/announcements/{announcement}
   admin.announcements.destroy  DELETE /admin/announcements/{announcement}
   ```

7. **Navigation**: The "Announcements" link is added to the Admin dropdown in `AuthenticatedLayout.tsx` (both desktop and mobile views), appearing before the "Repositories" separator.

8. **`AnnouncementNotification`**: `app/Notifications/AnnouncementNotification.php` exists:
   - Uses `database` channel only
   - `toArray()` returns: `type: 'announcement'`, `announcement_id`, `title`, `severity`, `message` (format: `"Administrator announcement: {title}"`)
   - Dispatched to ALL active users when an announcement is created with `is_active = true`
   - Uses `Notification::send(User::where('is_active', true)->get(), new AnnouncementNotification($announcement))`

9. **`AnnouncementBanner` Component**: A new component `resources/js/Components/AnnouncementBanner.tsx` exists:
   - Reads `activeAnnouncements` from shared props (array of current announcements)
   - Renders one banner per active announcement using the shadcn/ui `Alert` component from `resources/js/Components/ui/alert.tsx`
   - Severity styling:
     - `Normal` → blue info banner (`bg-blue-50 border-blue-200 text-blue-800`)
     - `Advisory` → yellow warning banner (`bg-yellow-50 border-yellow-200 text-yellow-800`)
     - `Emergency` → red alert banner (`bg-red-50 border-red-200 text-red-800`) with `position: sticky; top: 0; z-index: 50`
   - Each banner is dismissible: clicking an "X" button stores the dismissed announcement ID in `localStorage` under the key `dismissed_announcements` (a JSON array of IDs). Dismissed banners are filtered out on mount via `useEffect`.
   - Displays `title` prominently and `body` text below

10. **Shared Props — `activeAnnouncements`**: `HandleInertiaRequests.php` shares `activeAnnouncements` to all authenticated pages:
    - Calls `Announcement::current()->get()` returning array of `{ id, title, body, severity }`
    - Only included for authenticated users

11. **`AuthenticatedLayout` Integration**: `resources/js/Layouts/AuthenticatedLayout.tsx` is updated to:
    - Import and render `<AnnouncementBanner />` immediately above the `<main>{children}</main>` element (after the nav and optional header)
    - Import `activeAnnouncements` from `usePage<PageProps>().props`

12. **`NotificationBell` Updates**: `resources/js/Components/NotificationBell.tsx` `getNotificationIcon()` function includes a case for `announcement` type:
    - `announcement` → megaphone/speaker icon (use `Megaphone` from lucide-react), colored `text-blue-500`

13. **`Notifications/Index.tsx` Updates**: The type filter dropdown includes `Announcements` as a new `<SelectItem value="announcement">` option.

14. **`PageProps` TypeScript Update**: `resources/js/types/index.d.ts` includes `activeAnnouncements` in the `PageProps` type:
    ```ts
    activeAnnouncements?: Array<{
        id: number;
        title: string;
        body: string;
        severity: 'Normal' | 'Advisory' | 'Emergency';
    }>;
    ```

15. **Testing**: Feature tests exist covering:
    - Administrator can access announcements index (200 response)
    - Non-administrator (Viewer, Endorser) cannot access announcements index (403 response)
    - Administrator can create an announcement with valid data
    - Administrator can update an announcement
    - Administrator can delete an announcement
    - `AnnouncementNotification` is sent to all active users when an active announcement is created
    - `AnnouncementNotification` is NOT sent when `is_active = false`
    - Announcements index page loads with correct Inertia component and `announcements` prop
    - Active, current announcements appear in `activeAnnouncements` shared props
    - Expired announcements (past `ends_at`) do NOT appear in `activeAnnouncements`

---

## Tasks / Subtasks

- [ ] Task 1: Create `announcements` table migration (AC: 1)
  - [ ] Create migration file at `database/migrations/2026_02_18_000100_create_announcements_table.php`
  - [ ] Schema: `id`, `title` (string 255), `body` (text), `severity` (enum Normal/Advisory/Emergency, default Normal), `is_active` (boolean, default false), `starts_at` (nullable timestamp), `ends_at` (nullable timestamp), `created_by_user_id` (foreignId → users, restrictOnDelete), `timestamps()`
  - [ ] Add index on `is_active` and composite index on `(is_active, starts_at, ends_at)` for scope query performance
  - [ ] Run `php artisan migrate --pretend` to verify before actual migration

- [ ] Task 2: Create `Announcement` model (AC: 2)
  - [ ] Create `app/Models/Announcement.php` with `declare(strict_types=1)`
  - [ ] Add `$fillable`: `['title', 'body', 'severity', 'is_active', 'starts_at', 'ends_at', 'created_by_user_id']`
  - [ ] Add `$casts`: `['is_active' => 'boolean', 'starts_at' => 'datetime', 'ends_at' => 'datetime']`
  - [ ] Add `scopeActive(Builder $query)` — `$query->where('is_active', true)`
  - [ ] Add `scopeCurrent(Builder $query)` — active + time-window filter (see Dev Notes for exact implementation)
  - [ ] Add `createdBy()` BelongsTo → `User`

- [ ] Task 3: Create Form Request classes (AC: 4)
  - [ ] Create `app/Http/Requests/StoreAnnouncementRequest.php` with validation rules
  - [ ] Create `app/Http/Requests/UpdateAnnouncementRequest.php` with same validation rules
  - [ ] Both `authorize()` methods return `true` (route middleware handles authorization)

- [ ] Task 4: Create `AnnouncementController` (AC: 3)
  - [ ] Create `app/Http/Controllers/Admin/AnnouncementController.php` with `declare(strict_types=1)`
  - [ ] `index()` — `Announcement::with('createdBy')->orderBy('created_at', 'desc')->paginate(20)`, render `Admin/Announcements/Index`
  - [ ] `create()` — render `Admin/Announcements/Create`
  - [ ] `store()` — validate via `StoreAnnouncementRequest`, create announcement with `created_by_user_id = $request->user()->id`, dispatch notification if `is_active = true`, redirect to index with success
  - [ ] `edit()` — load `createdBy`, render `Admin/Announcements/Edit`
  - [ ] `update()` — validate via `UpdateAnnouncementRequest`, update announcement, redirect to index with success
  - [ ] `destroy()` — delete announcement, redirect to index with success

- [ ] Task 5: Register routes (AC: 6)
  - [ ] Add `Route::resource('admin/announcements', ...)` with explicit names `admin.announcements.*` inside the existing `role:Administrator` middleware group in `routes/web.php`
  - [ ] Follow the exact pattern of the workflows resource route block (lines 121-129 of `routes/web.php`)

- [ ] Task 6: Create `AnnouncementNotification` class (AC: 8)
  - [ ] Create `app/Notifications/AnnouncementNotification.php` with `declare(strict_types=1)`
  - [ ] Follow `OutOfWorkflowNotification` pattern: `use Queueable`, `via()` returns `['database']`
  - [ ] Constructor receives `Announcement $announcement`
  - [ ] `toArray()` returns: `type: 'announcement'`, `announcement_id`, `title`, `severity`, `message`

- [ ] Task 7: Wire notification dispatch in `AnnouncementController::store()` (AC: 8)
  - [ ] After creating the announcement, if `$announcement->is_active` is true, dispatch `AnnouncementNotification` to all active users
  - [ ] Use `Notification::send(User::where('is_active', true)->get(), new AnnouncementNotification($announcement))`
  - [ ] Import `Illuminate\Support\Facades\Notification` and `App\Models\User`

- [ ] Task 8: Update `HandleInertiaRequests` to share `activeAnnouncements` (AC: 10)
  - [ ] Add `activeAnnouncements` key to the `share()` return array in `app/Http/Middleware/HandleInertiaRequests.php`
  - [ ] Use lazy evaluation: `fn () => $request->user() ? Announcement::current()->get(['id', 'title', 'body', 'severity'])->toArray() : []`
  - [ ] Import `App\Models\Announcement` at top of file

- [ ] Task 9: Update `PageProps` TypeScript type (AC: 14)
  - [ ] Add `activeAnnouncements` to `PageProps` in `resources/js/types/index.d.ts`

- [ ] Task 10: Create `AnnouncementBanner` component (AC: 9, 11)
  - [ ] Create `resources/js/Components/AnnouncementBanner.tsx`
  - [ ] Read `activeAnnouncements` from `usePage<PageProps>().props`
  - [ ] On mount (`useEffect`), read `localStorage.getItem('dismissed_announcements')` and filter out dismissed IDs
  - [ ] Render `Alert` component from `@/Components/ui/alert` for each non-dismissed announcement
  - [ ] Apply severity-based Tailwind classes (see Dev Notes)
  - [ ] Emergency banners: add `sticky top-0 z-50` to the banner wrapper
  - [ ] Dismiss button: `onClick` adds announcement ID to `dismissed_announcements` array in localStorage and removes banner from state
  - [ ] Include `AlertTitle` for `title` and `AlertDescription` for `body`

- [ ] Task 11: Integrate `AnnouncementBanner` into `AuthenticatedLayout` (AC: 11)
  - [ ] Import `AnnouncementBanner` in `resources/js/Layouts/AuthenticatedLayout.tsx`
  - [ ] Render `<AnnouncementBanner />` immediately before `<main>{children}</main>` (after the optional header block, line ~407)
  - [ ] Verify TypeScript compiles with `npx tsc --noEmit`

- [ ] Task 12: Add Announcements to Admin navigation (AC: 7)
  - [ ] In `AuthenticatedLayout.tsx`, add desktop `<DropdownMenuItem>` for Announcements inside the Admin dropdown (before `<DropdownMenuSeparator />`)
  - [ ] Add mobile nav link for Announcements in the Administrator-only mobile section (same position)

- [ ] Task 13: Create Admin Announcements page components (AC: 5)
  - [ ] Create `resources/js/Pages/Admin/Announcements/Index.tsx`
    - Props: `{ auth, announcements: PaginatedData<Announcement>, filters }`
    - Table columns: Title, Severity (Badge), Status (Active/Inactive Badge), Starts At, Ends At, Created By, Actions
    - Actions: Edit (Pencil icon), Delete (Trash2 icon with confirm dialog)
    - "New Announcement" button linking to `admin.announcements.create`
    - Pagination component following Workflows/Index pattern
  - [ ] Create `resources/js/Pages/Admin/Announcements/Create.tsx`
    - `useForm` with fields: `title`, `body`, `severity`, `is_active`, `starts_at`, `ends_at`
    - Severity Select with options: Normal, Advisory, Emergency
    - Is Active Switch/Toggle
    - Starts At and Ends At date inputs (type="datetime-local")
    - Submit calls `post(route('admin.announcements.store'))`
    - Cancel button routes back to index
  - [ ] Create `resources/js/Pages/Admin/Announcements/Edit.tsx`
    - Same as Create but pre-populated; submit calls `put(route('admin.announcements.update', announcement.id))`
  - [ ] Add `Announcement` TypeScript interface to `resources/js/types/models.ts`

- [ ] Task 14: Update `NotificationBell` for announcement type (AC: 12)
  - [ ] Add `case 'announcement': return <Megaphone className="h-4 w-4 text-blue-500 shrink-0" />` to `getNotificationIcon()` in `resources/js/Components/NotificationBell.tsx`
  - [ ] Import `Megaphone` from `lucide-react`

- [ ] Task 15: Update `Notifications/Index.tsx` type filter (AC: 13)
  - [ ] Add `<SelectItem value="announcement">Announcements</SelectItem>` to the type filter `<SelectContent>` in `resources/js/Pages/Notifications/Index.tsx`
  - [ ] Add `announcement` badge styling in the notification list

- [ ] Task 16: Write feature tests (AC: 15)
  - [ ] Create `tests/Feature/AnnouncementControllerTest.php`
  - [ ] Test: Administrator can access index (200)
  - [ ] Test: Viewer cannot access index (403)
  - [ ] Test: Endorser cannot access index (403)
  - [ ] Test: Administrator can create announcement with valid data
  - [ ] Test: Creating active announcement dispatches `AnnouncementNotification` to all active users
  - [ ] Test: Creating inactive announcement does NOT dispatch notification
  - [ ] Test: Administrator can update an announcement
  - [ ] Test: Administrator can delete an announcement
  - [ ] Test: Announcements index loads with correct Inertia component
  - [ ] Test: `activeAnnouncements` shared prop contains current active announcements
  - [ ] Test: Expired announcements (past `ends_at`) are excluded from `activeAnnouncements`
  - [ ] Test: Future announcements (future `starts_at`) are excluded from `activeAnnouncements`

---

## Dev Notes

### Source Tree — New Files to Create

```
app/
  Http/
    Controllers/
      Admin/
        AnnouncementController.php        ← NEW
    Requests/
      StoreAnnouncementRequest.php         ← NEW
      UpdateAnnouncementRequest.php        ← NEW
  Models/
    Announcement.php                       ← NEW
  Notifications/
    AnnouncementNotification.php           ← NEW
database/
  migrations/
    2026_02_18_000100_create_announcements_table.php  ← NEW
resources/js/
  Components/
    AnnouncementBanner.tsx                 ← NEW
  Pages/
    Admin/
      Announcements/
        Index.tsx                          ← NEW
        Create.tsx                         ← NEW
        Edit.tsx                           ← NEW
  types/
    models.ts                              ← MODIFY (add Announcement interface)
    index.d.ts                             ← MODIFY (add activeAnnouncements to PageProps)
```

### Source Tree — Existing Files to Modify

```
routes/web.php                                             ← add resource route
app/Http/Middleware/HandleInertiaRequests.php               ← add activeAnnouncements
resources/js/Layouts/AuthenticatedLayout.tsx               ← add banner + nav link
resources/js/Components/NotificationBell.tsx               ← add announcement icon
resources/js/Pages/Notifications/Index.tsx                 ← add announcement filter
```

### Migration Pattern

Follow `database/migrations/2026_02_12_063606_create_notifications_table.php` for migration structure (anonymous class, up/down methods). Follow `database/migrations/2025_10_31_120100_create_transactions_table.php` for `foreignId()->constrained()->restrictOnDelete()` pattern.

```php
// database/migrations/2026_02_18_000100_create_announcements_table.php
Schema::create('announcements', function (Blueprint $table) {
    $table->id();
    $table->string('title', 255);
    $table->text('body');
    $table->enum('severity', ['Normal', 'Advisory', 'Emergency'])->default('Normal');
    $table->boolean('is_active')->default(false);
    $table->timestamp('starts_at')->nullable();
    $table->timestamp('ends_at')->nullable();
    $table->foreignId('created_by_user_id')
        ->constrained('users')
        ->restrictOnDelete();
    $table->timestamps();

    $table->index('is_active');
    $table->index(['is_active', 'starts_at', 'ends_at']);
});
```

### Announcement Model — Scope Implementation

```php
// app/Models/Announcement.php
declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class Announcement extends Model
{
    use HasFactory;

    protected $fillable = [
        'title',
        'body',
        'severity',
        'is_active',
        'starts_at',
        'ends_at',
        'created_by_user_id',
    ];

    protected function casts(): array
    {
        return [
            'is_active' => 'boolean',
            'starts_at' => 'datetime',
            'ends_at'   => 'datetime',
        ];
    }

    /** Filter: only active announcements. */
    public function scopeActive(Builder $query): Builder
    {
        return $query->where('is_active', true);
    }

    /**
     * Filter: active AND within the optional time window.
     * starts_at = null means "effective immediately"
     * ends_at = null means "no expiry"
     */
    public function scopeCurrent(Builder $query): Builder
    {
        $now = now();

        return $query->active()
            ->where(fn (Builder $q) => $q->whereNull('starts_at')->orWhere('starts_at', '<=', $now))
            ->where(fn (Builder $q) => $q->whereNull('ends_at')->orWhere('ends_at', '>=', $now));
    }

    public function createdBy(): BelongsTo
    {
        return $this->belongsTo(User::class, 'created_by_user_id');
    }
}
```

### AnnouncementController Pattern

Follow `app/Http/Controllers/Admin/OfficeController.php` exactly — thin controller, delegate to Form Requests, Inertia responses and redirects only. Key differences:
- `store()` additionally dispatches the notification if `is_active` is true
- `index()` eager-loads `createdBy` with `with('createdBy')`

```php
// In store() after Announcement::create():
if ($announcement->is_active) {
    $users = \App\Models\User::where('is_active', true)->get();
    \Illuminate\Support\Facades\Notification::send(
        $users,
        new \App\Notifications\AnnouncementNotification($announcement)
    );
}
```

### AnnouncementNotification Pattern

Follow `app/Notifications/OutOfWorkflowNotification.php` exactly:

```php
// app/Notifications/AnnouncementNotification.php
declare(strict_types=1);

namespace App\Notifications;

use App\Models\Announcement;
use Illuminate\Bus\Queueable;
use Illuminate\Notifications\Notification;

class AnnouncementNotification extends Notification
{
    use Queueable;

    public function __construct(
        protected Announcement $announcement
    ) {}

    public function via(object $notifiable): array
    {
        return ['database'];
    }

    public function toArray(object $notifiable): array
    {
        return [
            'type'            => 'announcement',
            'announcement_id' => $this->announcement->id,
            'title'           => $this->announcement->title,
            'severity'        => $this->announcement->severity,
            'message'         => "Administrator announcement: {$this->announcement->title}",
        ];
    }
}
```

### Routes Registration

In `routes/web.php`, add inside the existing `Route::middleware(['auth', 'role:Administrator'])` group (after the existing `admin/repositories/action-taken` block at line ~183, before the closing `});`):

```php
Route::resource('admin/announcements', App\Http\Controllers\Admin\AnnouncementController::class)->except(['show'])->names([
    'index'   => 'admin.announcements.index',
    'create'  => 'admin.announcements.create',
    'store'   => 'admin.announcements.store',
    'edit'    => 'admin.announcements.edit',
    'update'  => 'admin.announcements.update',
    'destroy' => 'admin.announcements.destroy',
]);
```

Note: `show` is explicitly excluded via `->except(['show'])` — no detail view needed.

### HandleInertiaRequests — Adding `activeAnnouncements`

In `app/Http/Middleware/HandleInertiaRequests.php`, add to the `share()` return array alongside existing keys:

```php
// Add import at top:
use App\Models\Announcement;

// Add to share() array:
'activeAnnouncements' => fn () => $request->user()
    ? Announcement::current()
        ->get(['id', 'title', 'body', 'severity'])
        ->toArray()
    : [],
```

The existing `share()` method at line 31 of `HandleInertiaRequests.php` already uses lazy closures (`fn () =>`) for `pendingReceiptsCount` and `notifications` — follow that exact same pattern.

### AuthenticatedLayout Integration Points

In `resources/js/Layouts/AuthenticatedLayout.tsx`:

**Banner insertion** (line ~406, before `<main>{children}</main>`):
```tsx
// Add import at top:
import { AnnouncementBanner } from '@/Components/AnnouncementBanner';

// Replace:
<main>{children}</main>

// With:
<AnnouncementBanner />
<main>{children}</main>
```

**Desktop nav — Announcements link** (add before `<DropdownMenuSeparator />` at line ~153):
```tsx
<DropdownMenuItem asChild>
    <Link href={route('admin.announcements.index')}>
        Announcements
    </Link>
</DropdownMenuItem>
```

**Mobile nav — Announcements link** (add before the `<div className="px-3 py-2 text-xs font-semibold text-gray-500 uppercase">Repositories</div>` block in the mobile Admin section):
```tsx
<Link
    href={route('admin.announcements.index')}
    onClick={() => setSheetOpen(false)}
    className="block px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md"
>
    Announcements
</Link>
```

### AnnouncementBanner Component Implementation

The `Alert` component at `resources/js/Components/ui/alert.tsx` supports `className` prop for custom styling. It does NOT have built-in `blue` or `yellow` variants — only `default` and `destructive`. Use custom Tailwind classes directly on the `Alert` element.

```tsx
// resources/js/Components/AnnouncementBanner.tsx
import { useEffect, useState } from 'react';
import { usePage } from '@inertiajs/react';
import { Alert, AlertDescription, AlertTitle } from '@/Components/ui/alert';
import { X, Megaphone } from 'lucide-react';
import type { PageProps } from '@/types';

const STORAGE_KEY = 'dismissed_announcements';

type ActiveAnnouncement = {
    id: number;
    title: string;
    body: string;
    severity: 'Normal' | 'Advisory' | 'Emergency';
};

const severityClasses: Record<string, string> = {
    Normal:    'bg-blue-50 border-blue-200 text-blue-800',
    Advisory:  'bg-yellow-50 border-yellow-200 text-yellow-800',
    Emergency: 'bg-red-50 border-red-200 text-red-800',
};

export function AnnouncementBanner() {
    const { activeAnnouncements = [] } = usePage<PageProps>().props;
    const [visible, setVisible] = useState<ActiveAnnouncement[]>([]);

    useEffect(() => {
        const raw = localStorage.getItem(STORAGE_KEY);
        const dismissed: number[] = raw ? JSON.parse(raw) : [];
        setVisible(
            (activeAnnouncements as ActiveAnnouncement[]).filter(
                (a) => !dismissed.includes(a.id)
            )
        );
    }, []);

    const dismiss = (id: number) => {
        const raw = localStorage.getItem(STORAGE_KEY);
        const dismissed: number[] = raw ? JSON.parse(raw) : [];
        dismissed.push(id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dismissed));
        setVisible((prev) => prev.filter((a) => a.id !== id));
    };

    if (visible.length === 0) return null;

    return (
        <div>
            {visible.map((announcement) => (
                <div
                    key={announcement.id}
                    className={announcement.severity === 'Emergency' ? 'sticky top-0 z-50' : ''}
                >
                    <Alert className={`rounded-none border-x-0 ${severityClasses[announcement.severity]}`}>
                        <Megaphone className="h-4 w-4" />
                        <AlertTitle className="flex items-center justify-between">
                            {announcement.title}
                            <button
                                onClick={() => dismiss(announcement.id)}
                                className="ml-4 opacity-70 hover:opacity-100"
                                aria-label="Dismiss announcement"
                            >
                                <X className="h-4 w-4" />
                            </button>
                        </AlertTitle>
                        <AlertDescription>{announcement.body}</AlertDescription>
                    </Alert>
                </div>
            ))}
        </div>
    );
}
```

### TypeScript — `PageProps` and `models.ts` Updates

In `resources/js/types/index.d.ts`, add `activeAnnouncements` to the `PageProps` type (the file currently has `notifications`, `pendingReceiptsCount`, `flash`, `auth`):

```ts
activeAnnouncements?: Array<{
    id: number;
    title: string;
    body: string;
    severity: 'Normal' | 'Advisory' | 'Emergency';
}>;
```

In `resources/js/types/models.ts`, add the `Announcement` interface:

```ts
export interface Announcement {
    id: number;
    title: string;
    body: string;
    severity: 'Normal' | 'Advisory' | 'Emergency';
    is_active: boolean;
    starts_at: string | null;
    ends_at: string | null;
    created_by_user_id: number;
    created_at: string;
    updated_at: string;
    created_by?: User;
}
```

### Admin Pages — TypeScript `PaginatedData` Type

The `PaginatedData<T>` generic type is already used by existing pages (e.g., `Admin/Workflows/Index.tsx` line 4 imports it from `@/types/models`). Use the same import pattern:

```ts
import { PaginatedData, Announcement, User } from '@/types/models';
```

### NotificationBell Update

In `resources/js/Components/NotificationBell.tsx`, the `getNotificationIcon()` function starts at line 12. Add a new case before the `default`:

```tsx
// Add to imports:
import { Bell, AlertTriangle, CheckCircle, Megaphone, ExternalLink } from 'lucide-react';

// Add case in getNotificationIcon():
case 'announcement':
    return <Megaphone className="h-4 w-4 text-blue-500 shrink-0" />;
```

### Form Requests — `authorize()` Convention

All existing Form Requests in `app/Http/Requests/` return `true` from `authorize()` (authorization is handled at the route middleware level via `role:Administrator`). Follow this same pattern for `StoreAnnouncementRequest` and `UpdateAnnouncementRequest`. Reference: `app/Http/Requests/StoreOfficeRequest.php`.

### Laravel auto-discovery

Laravel 12.x uses event auto-discovery — no manual registration in `EventServiceProvider` or `AppServiceProvider` is needed for new events or listeners. Similarly, `AnnouncementNotification` does not need to be registered anywhere; it is dispatched directly via `Notification::send()`.

### Coding Standards Reminders

- All new PHP files must include `declare(strict_types=1);`
- Use PSR-12 formatting — run `./vendor/bin/pint` before committing
- Run `npx tsc --noEmit` to verify TypeScript compiles without errors
- Run `npm run lint` for ESLint compliance
- Wrap any multi-step DB mutations in `DB::transaction()` (not required for simple creates but keep in mind if store() logic grows)

### Dependencies

- **Story 3.8** (Done): Notification infrastructure — `notifications` table, `NotificationController`, `NotificationBell`, `Notifications/Index` page. The `AnnouncementNotification` stores to the same `notifications` table and flows through the existing bell infrastructure automatically.
- **RBAC** (Done via Spatie Laravel Permission): `Administrator` role exists. Route middleware `role:Administrator` is already in use by all admin routes.
- **Story 4.2.1** (Draft): No hard dependency — announcements and additional notification types are independent. Story 4.2.1 adds new notification types but does not affect announcement CRUD or the `Announcement` model.

---

### Testing

- **Test file location**: `tests/Feature/AnnouncementControllerTest.php`
- **Testing framework**: PHPUnit with `RefreshDatabase` trait (same as all other Feature tests)
- **Test pattern**: Follow `tests/Feature/OfficeControllerTest.php` for RBAC access tests; follow `tests/Feature/OutOfWorkflowNotificationTest.php` for notification assertion patterns
- **Role seeding**: In `setUp()`, seed roles directly (as done in `OfficeControllerTest.php`):
  ```php
  protected function setUp(): void
  {
      parent::setUp();
      $this->seed(\Database\Seeders\RoleSeeder::class);
      // OR manually:
      // Role::create(['name' => 'Administrator', 'guard_name' => 'web']);
  }
  ```
  Check whether `RoleSeeder` class exists at `database/seeders/RoleSeeder.php` before using it; if not, create roles directly as in `OfficeControllerTest.php`.
- **Key assertions**:
  - `Notification::fake()` then `Notification::assertSentTo($user, AnnouncementNotification::class)`
  - `Notification::assertNothingSent()` for inactive announcements
  - `$this->withoutVite()->actingAs($admin)->get(route('admin.announcements.index'))->assertInertia(fn ($page) => $page->component('Admin/Announcements/Index')->has('announcements'))`
  - For shared props: `$this->actingAs($admin)->get(route('dashboard'))->assertInertia(fn ($page) => $page->has('activeAnnouncements'))`
- **Inertia assertions**: Use `->assertInertia()` with `withoutVite()` to avoid Vite manifest errors in test environment (see existing tests for pattern)
- **Run tests**: `php artisan test tests/Feature/AnnouncementControllerTest.php`
- **TypeScript verification**: `npx tsc --noEmit` after all frontend changes

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-18 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

---

## QA Results
*(To be filled by QA agent)*
