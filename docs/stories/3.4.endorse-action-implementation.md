# Story 3.4: Endorse Action Implementation

**Status**: Ready for Review
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As an Endorser or Administrator, I want to endorse a transaction to send it to the next office in the workflow, so that transactions progress through the approval chain.

---

## Acceptance Criteria

1. **Endorse Button Visibility**: On the Transaction Detail page:
   - "Endorse" button visible only when:
     - User has Endorser or Administrator role
     - User's office matches transaction's current_office_id
     - Transaction has been received (received_at is not null)
     - Transaction status is "In Progress"
     - Transaction is not at the final workflow step
   - Button disabled with tooltip explanation when conditions not met

2. **Endorse Modal/Form**: Clicking "Endorse" opens a modal or navigates to form with:
   - Transaction summary (reference number, category, current office)
   - Current workflow step indicator
   - **Action Taken** (required, dropdown from action_taken repository)
   - **Target Office** (required, dropdown):
     - Default: Next office in workflow (auto-selected)
     - Options: All offices (allowing out-of-workflow selection)
     - Visual warning when selecting non-workflow office
   - **Notes** (optional, textarea, max 1000 characters)
   - Submit button: "Endorse Transaction"
   - Cancel button: Returns to transaction detail

3. **Endorse Action Processing**: On form submission:
   - Create `transaction_actions` record with:
     - `action_type`: 'endorse'
     - `from_office_id`: Current user's office
     - `to_office_id`: Selected target office
     - `from_user_id`: Current user
     - `action_taken_id`: Selected action
     - `workflow_step_id`: Current workflow step
     - `is_out_of_workflow`: true if target !== expected next office
     - `notes`: Entered notes
     - `ip_address`: Request IP
   - Update transaction:
     - `current_office_id`: Target office
     - `current_user_id`: null (cleared until received)
     - `endorsed_at`: now
     - `received_at`: null (cleared for new office)
   - Log to transaction_status_history if status changed
   - Trigger out-of-workflow notification if applicable (Story 3.8)

4. **Success Feedback**:
   - Success toast: "Transaction endorsed to [Office Name]"
   - Redirect to transaction detail page
   - Transaction detail shows updated current office
   - Endorsement appears in action history

5. **Validation & Error Handling**:
   - Server-side validation via Form Request
   - Verify user authorization (office match, role check)
   - Verify transaction state (status, received)
   - Return validation errors with descriptive messages
   - Handle concurrent modification (optimistic locking or check)

6. **Audit Trail**: Endorsement action fully logged per NFR4:
   - Actor (user ID, name)
   - From office, to office
   - Timestamp
   - IP address
   - Notes

7. **API Endpoint**: `POST /transactions/{id}/endorse`
   - Request body: `{ action_taken_id, to_office_id, notes? }`
   - Response: Updated transaction with actions

---

## Dev Notes

### Endorse UI Flow

```
Transaction Detail Page
         ↓
   [Endorse Button]  (visible when conditions met)
         ↓
   Endorse Modal/Form
   ┌─────────────────────────────────────┐
   │ Endorse Transaction                 │
   │                                     │
   │ Reference: PR-GF-2025-01-0001       │
   │ Current Office: Budget Office       │
   │ Workflow Step: 2 of 5               │
   │                                     │
   │ Action Taken: [Select Action  ▼]    │
   │                                     │
   │ Target Office: [BAC Office    ▼]    │
   │ ✓ Next in workflow                  │
   │   (or ⚠️ Out of workflow)           │
   │                                     │
   │ Notes: [________________________]   │
   │        [________________________]   │
   │                                     │
   │ [Cancel]          [Endorse Transaction]│
   └─────────────────────────────────────┘
         ↓
   Success Toast → Transaction Detail (updated)
```

### Service Layer Pattern

```php
// app/Services/EndorsementService.php
class EndorsementService
{
    public function endorse(
        Transaction $transaction,
        User $user,
        int $actionTakenId,
        int $toOfficeId,
        ?string $notes = null
    ): TransactionAction {
        return DB::transaction(function () use ($transaction, $user, $actionTakenId, $toOfficeId, $notes) {
            // Verify preconditions
            $this->verifyCanEndorse($transaction, $user);

            // Determine if out-of-workflow
            $expectedNextOffice = $this->getExpectedNextOffice($transaction);
            $isOutOfWorkflow = $expectedNextOffice?->id !== $toOfficeId;

            // Create action record
            $action = TransactionAction::create([
                'transaction_id' => $transaction->id,
                'action_type' => TransactionAction::TYPE_ENDORSE,
                'action_taken_id' => $actionTakenId,
                'from_office_id' => $user->office_id,
                'to_office_id' => $toOfficeId,
                'from_user_id' => $user->id,
                'workflow_step_id' => $transaction->current_step_id,
                'is_out_of_workflow' => $isOutOfWorkflow,
                'notes' => $notes,
                'ip_address' => request()->ip(),
            ]);

            // Update transaction
            $transaction->update([
                'current_office_id' => $toOfficeId,
                'current_user_id' => null,
                'endorsed_at' => now(),
                'received_at' => null,
            ]);

            // Fire event for notifications (Story 3.8)
            if ($isOutOfWorkflow) {
                event(new OutOfWorkflowEndorsement($action));
            }

            return $action;
        });
    }

    public function canEndorse(Transaction $transaction, User $user): bool
    {
        return $user->hasRole(['Endorser', 'Administrator'])
            && $user->office_id === $transaction->current_office_id
            && $transaction->received_at !== null
            && $transaction->status === 'In Progress'
            && !$transaction->currentStep?->is_final_step;
    }

    protected function getExpectedNextOffice(Transaction $transaction): ?Office
    {
        return $transaction->currentStep?->getNextStep()?->office;
    }
}
```

### Controller Implementation

```php
// app/Http/Controllers/TransactionEndorseController.php
class TransactionEndorseController extends Controller
{
    public function create(Transaction $transaction)
    {
        $this->authorize('endorse', $transaction);

        return Inertia::render('Transactions/Endorse', [
            'transaction' => $transaction->load(['currentOffice', 'currentStep', 'workflow.steps.office']),
            'actionTakenOptions' => ActionTaken::orderBy('name')->get(),
            'officeOptions' => Office::active()->orderBy('name')->get(),
            'expectedNextOffice' => $transaction->currentStep?->getNextStep()?->office,
        ]);
    }

    public function store(EndorseTransactionRequest $request, Transaction $transaction)
    {
        $this->authorize('endorse', $transaction);

        $action = $this->endorsementService->endorse(
            $transaction,
            $request->user(),
            $request->action_taken_id,
            $request->to_office_id,
            $request->notes
        );

        return redirect()
            ->route('transactions.show', $transaction)
            ->with('success', "Transaction endorsed to {$action->toOffice->name}");
    }
}
```

### Policy Authorization

```php
// app/Policies/TransactionPolicy.php
public function endorse(User $user, Transaction $transaction): bool
{
    return app(EndorsementService::class)->canEndorse($transaction, $user);
}
```

### Form Request

```php
// app/Http/Requests/EndorseTransactionRequest.php
public function rules(): array
{
    return [
        'action_taken_id' => 'required|exists:action_taken,id',
        'to_office_id' => 'required|exists:offices,id',
        'notes' => 'nullable|string|max:1000',
    ];
}
```

### Reference Files

- Transaction model: Story 2.1, 3.3
- TransactionAction model: Story 3.3
- ActionTaken repository: Story 1.6
- Office repository: Story 1.4
- Transaction detail page: Story 2.9

### Story Dependencies

**Depends on**:
- Story 3.3 (Transaction Actions Schema) - requires action recording capability
- Story 3.1 (Workflow Schema) - for workflow step navigation
- Story 2.9 (Procurement Detail View) - transaction detail page exists

**Blocks**:
- Story 3.8 (Out-of-Workflow Detection) - uses is_out_of_workflow flag

---

## Tasks

### Task 1: Create EndorsementService
**Estimate**: 1 hour
- [x] Create `app/Services/EndorsementService.php`
- [x] Implement `endorse()` method with DB transaction
- [x] Implement `canEndorse()` verification method
- [x] Implement `getExpectedNextOffice()` helper
- [x] Register service in AppServiceProvider

**Verification**: Test service methods in tinker

### Task 2: Create Transaction Policy
**Estimate**: 30 minutes
- [x] Create or update `app/Policies/TransactionPolicy.php`
- [x] Implement `endorse()` authorization method
- [x] Register policy in AuthServiceProvider (auto-discovered in Laravel 12)

**Verification**: Policy check works in tinker

### Task 3: Create Endorse Controller
**Estimate**: 45 minutes
- [x] Create `app/Http/Controllers/TransactionEndorseController.php`
- [x] Implement `create()` method (show endorse form)
- [x] Implement `store()` method (process endorsement)
- [x] Inject EndorsementService
- [x] Add authorization checks

**Verification**: Routes respond correctly

### Task 4: Create Form Request
**Estimate**: 20 minutes
- [x] Create `app/Http/Requests/EndorseTransactionRequest.php`
- [x] Define validation rules
- [x] Add authorization method using policy

**Verification**: Invalid submissions return errors

### Task 5: Add Routes
**Estimate**: 10 minutes
- [x] Add routes to `routes/web.php`:
  - `GET /transactions/{transaction}/endorse` → create
  - `POST /transactions/{transaction}/endorse` → store
- [x] Apply auth and role middleware

**Verification**: Routes registered correctly

### Task 6: Create Endorse Page Component
**Estimate**: 1.5 hours
- [x] Create `resources/js/Pages/Transactions/Endorse.tsx`
- [x] Display transaction summary section
- [x] Implement Action Taken dropdown
- [x] Implement Target Office dropdown with:
  - Auto-selection of expected next office
  - Visual indicator for out-of-workflow selection
- [x] Implement Notes textarea
- [x] Form submission with Inertia.post
- [x] Handle validation errors
- [x] Add Cancel button

**Verification**: Form renders and submits correctly

### Task 7: Update Transaction Detail Page
**Estimate**: 45 minutes
- [x] Update `resources/js/Pages/PurchaseRequests/Show.tsx`
- [x] Add Endorse button with visibility logic
- [x] Pass canEndorse prop from controller
- [x] Show disabled state with tooltip when conditions not met
- [x] Link to endorse page/modal

**Verification**: Button shows/hides correctly based on conditions

### Task 8: Update Transaction Show Controller
**Estimate**: 20 minutes
- [x] Update PurchaseRequestController show method to pass:
  - `canEndorse` boolean via EndorsementService
  - `cannotEndorseReason` for tooltip
  - Current step information
  - Workflow progress information

**Verification**: Props passed correctly to view

### Task 9: Write Feature Tests
**Estimate**: 1.5 hours
- [x] Create `tests/Feature/TransactionEndorseTest.php`:
  - Test endorse form loads for authorized user
  - Test endorse form forbidden for wrong office
  - Test endorse form forbidden for Viewer role
  - Test successful endorsement creates action
  - Test transaction updated after endorsement
  - Test out-of-workflow flag set correctly
  - Test validation errors returned
  - Test cannot endorse unreceived transaction
  - Test cannot endorse at final step

**Verification**:
```bash
php artisan test --filter=TransactionEndorse
```

### Task 10: Write Service Unit Tests
**Estimate**: 45 minutes
- [x] Create `tests/Unit/Services/EndorsementServiceTest.php`:
  - Test canEndorse returns correct boolean
  - Test endorse creates action with correct data
  - Test endorse updates transaction fields
  - Test out-of-workflow detection logic

**Verification**:
```bash
php artisan test --filter=EndorsementService
```

---

## Acceptance Checklist

- [ ] Endorse button visible only when all conditions met
- [ ] Endorse button shows disabled state with explanation when conditions not met
- [ ] Endorse form displays transaction summary
- [ ] Action Taken dropdown populated from repository
- [ ] Target Office dropdown defaults to expected next office
- [ ] Out-of-workflow warning displayed when selecting non-workflow office
- [ ] Notes field accepts optional input up to 1000 chars
- [ ] Form submission creates transaction_action record
- [ ] Transaction updated with new current_office and cleared received_at
- [ ] is_out_of_workflow flag set correctly
- [ ] IP address logged in action record
- [ ] Success toast displayed after endorsement
- [ ] Transaction detail shows updated state
- [ ] Validation errors displayed inline
- [ ] Authorization enforced (office match, role check)
- [ ] Feature tests pass
- [ ] Unit tests pass

**Definition of Done**: Endorsers can successfully endorse transactions to the next office, with proper validation, authorization, audit logging, and out-of-workflow detection.

---

## Dev Agent Record

**Story**: 3.4 - Endorse Action Implementation
**Status**: Ready for Review
**Assigned**: James (Dev Agent)
**Agent Model Used**: Claude Opus 4.5
**Start Date**: 2025-12-29
**Completion Date**: 2025-12-29

### Files Created
- [x] `app/Services/EndorsementService.php`
- [x] `app/Policies/TransactionPolicy.php`
- [x] `app/Http/Controllers/TransactionEndorseController.php`
- [x] `app/Http/Requests/EndorseTransactionRequest.php`
- [x] `resources/js/Pages/Transactions/Endorse.tsx`
- [x] `tests/Feature/TransactionEndorseTest.php`
- [x] `tests/Unit/Services/EndorsementServiceTest.php`

### Files Modified
- [x] `routes/web.php` - Added endorsement routes
- [x] `resources/js/Pages/PurchaseRequests/Show.tsx` - Added Endorse button with tooltip
- [x] `app/Http/Controllers/PurchaseRequestController.php` - Added canEndorse/cannotEndorseReason props
- [x] `app/Providers/AppServiceProvider.php` - Registered EndorsementService

### Test Results
- [x] Feature tests: 15 passing (51 assertions)
- [x] Unit tests: 19 passing (30 assertions)
- [x] Story-related tests: All passing

### Debug Log References
- None

### Completion Notes
- Implemented full endorsement workflow per acceptance criteria
- EndorsementService handles all business logic for endorsement
- TransactionPolicy uses service for authorization
- Endorse page shows workflow progress visualization
- Out-of-workflow detection working with visual warning
- Tooltip shows reason when Endorse button is disabled
- IP address captured in transaction_action record

### Change Log
| File | Change Type | Description |
|------|-------------|-------------|
| app/Services/EndorsementService.php | Created | Service for endorsement logic |
| app/Policies/TransactionPolicy.php | Created | Authorization for transaction actions |
| app/Http/Controllers/TransactionEndorseController.php | Created | Controller for endorse form and action |
| app/Http/Requests/EndorseTransactionRequest.php | Created | Form validation request |
| resources/js/Pages/Transactions/Endorse.tsx | Created | Endorsement form page |
| tests/Feature/TransactionEndorseTest.php | Created | Feature tests (15 tests) |
| tests/Unit/Services/EndorsementServiceTest.php | Created | Unit tests (19 tests) |
| routes/web.php | Modified | Added endorsement routes |
| resources/js/Pages/PurchaseRequests/Show.tsx | Modified | Added Endorse button with tooltip |
| app/Http/Controllers/PurchaseRequestController.php | Modified | Added canEndorse props |
| app/Providers/AppServiceProvider.php | Modified | Registered EndorsementService |

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
