# Story 3.8: Out-of-Workflow Detection & Notifications

**Status**: Done
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As an Administrator, I want to be notified when transactions are endorsed to offices outside the expected workflow, so that I can identify and correct misrouting promptly.

---

## Acceptance Criteria

1. **Out-of-Workflow Detection Logic**: System detects out-of-workflow endorsements when:
   - Transaction has an assigned workflow
   - Endorsed target office does NOT match the expected next step's office
   - `is_out_of_workflow` flag set to `true` on the transaction_action record
   - Detection occurs at endorsement time (Story 3.4)

2. **Notification Creation**: When out-of-workflow endorsement occurs:
   - Create notification for all Administrators
   - Create notification for users assigned to the expected receiving office
   - Notification contains:
     - Transaction reference number
     - Category (PR/PO/VCH)
     - Expected office (per workflow)
     - Actual target office (where it was sent)
     - User who performed the endorsement
     - Timestamp

3. **Notifications Table Migration**: Create `notifications` table:
   - `id` (UUID primary key)
   - `type` (string) - notification class name
   - `notifiable_type` (string) - polymorphic type
   - `notifiable_id` (bigint) - polymorphic ID
   - `data` (JSON) - notification payload
   - `read_at` (timestamp, nullable)
   - `created_at` (timestamp)
   - Standard Laravel notifications table structure

4. **Bell Icon & Badge**: In application header:
   - Bell icon with unread notification count badge
   - Badge hidden when count is 0
   - Badge shows count (max display "99+")
   - Click opens notification dropdown/panel

5. **Notification Panel/Dropdown**: Displays:
   - List of recent notifications (last 20)
   - Each notification shows:
     - Icon based on type (warning for out-of-workflow)
     - Summary message
     - Relative timestamp ("5 minutes ago")
     - Unread indicator (dot or background)
   - Click notification:
     - Marks as read
     - Navigates to relevant transaction detail
   - "Mark all as read" action
   - "View all notifications" link to full page

6. **Notifications Page**: Full notifications page at `/notifications`:
   - Paginated list of all notifications
   - Filter by type (all, out-of-workflow, received, overdue, etc.)
   - Filter by read/unread status
   - Bulk mark as read
   - Delete old notifications

7. **Out-of-Workflow Warning Banner**: On Transaction Detail for out-of-workflow transactions:
   - Yellow/amber warning banner
   - Message: "This transaction was routed outside the expected workflow"
   - Shows expected office vs actual office
   - Link to admin bypass tool (Story 5.x)

8. **Email Notifications (Optional/Phase 2)**: Prepare structure for:
   - Email notification channel
   - User preference for email notifications
   - Queue-based email sending

---

## Dev Notes

### Out-of-Workflow Detection Point

Detection happens in the `endorse()` method (Story 3.4):

```php
// In EndorsementService::endorse()
$expectedNextOffice = $this->getExpectedNextOffice($transaction);
$isOutOfWorkflow = $expectedNextOffice?->id !== $toOfficeId;

$action = TransactionAction::create([
    // ...
    'is_out_of_workflow' => $isOutOfWorkflow,
]);

if ($isOutOfWorkflow) {
    event(new OutOfWorkflowEndorsement($action));
}
```

### Event and Listener Pattern

```php
// app/Events/OutOfWorkflowEndorsement.php
class OutOfWorkflowEndorsement
{
    public function __construct(
        public TransactionAction $action
    ) {}
}

// app/Listeners/NotifyOutOfWorkflowEndorsement.php
class NotifyOutOfWorkflowEndorsement
{
    public function handle(OutOfWorkflowEndorsement $event): void
    {
        $action = $event->action;
        $transaction = $action->transaction;

        // Get expected office
        $expectedOffice = $transaction->currentStep?->getNextStep()?->office;

        // Notify all administrators
        $admins = User::role('Administrator')->get();
        Notification::send($admins, new OutOfWorkflowNotification($action, $expectedOffice));

        // Notify expected office users
        if ($expectedOffice) {
            $expectedUsers = User::where('office_id', $expectedOffice->id)->get();
            Notification::send($expectedUsers, new OutOfWorkflowNotification($action, $expectedOffice));
        }
    }
}
```

### Notification Class

```php
// app/Notifications/OutOfWorkflowNotification.php
class OutOfWorkflowNotification extends Notification
{
    public function __construct(
        protected TransactionAction $action,
        protected ?Office $expectedOffice
    ) {}

    public function via($notifiable): array
    {
        return ['database'];
    }

    public function toArray($notifiable): array
    {
        $transaction = $this->action->transaction;
        $actualOffice = $this->action->toOffice;

        return [
            'type' => 'out_of_workflow',
            'transaction_id' => $transaction->id,
            'reference_number' => $transaction->reference_number,
            'category' => $transaction->category,
            'expected_office_id' => $this->expectedOffice?->id,
            'expected_office_name' => $this->expectedOffice?->name ?? 'Unknown',
            'actual_office_id' => $actualOffice->id,
            'actual_office_name' => $actualOffice->name,
            'endorsed_by_user_id' => $this->action->from_user_id,
            'endorsed_by_name' => $this->action->fromUser->name,
            'message' => "Transaction {$transaction->reference_number} was sent to {$actualOffice->name} instead of expected {$this->expectedOffice?->name}",
        ];
    }
}
```

### Shared Props for Notification Count

```php
// app/Http/Middleware/HandleInertiaRequests.php
public function share(Request $request): array
{
    return [
        // ... other shared data
        'notifications' => [
            'unread_count' => $request->user()
                ? $request->user()->unreadNotifications()->count()
                : 0,
            'recent' => $request->user()
                ? $request->user()->notifications()
                    ->take(10)
                    ->get()
                    ->map(fn ($n) => [
                        'id' => $n->id,
                        'type' => $n->data['type'] ?? 'general',
                        'message' => $n->data['message'] ?? '',
                        'read_at' => $n->read_at,
                        'created_at' => $n->created_at->diffForHumans(),
                        'data' => $n->data,
                    ])
                : [],
        ],
    ];
}
```

### Bell Icon Component

```tsx
// resources/js/Components/NotificationBell.tsx
export function NotificationBell() {
  const { notifications } = usePage().props;
  const [isOpen, setIsOpen] = useState(false);

  return (
    <Popover open={isOpen} onOpenChange={setIsOpen}>
      <PopoverTrigger asChild>
        <Button variant="ghost" size="icon" className="relative">
          <Bell className="h-5 w-5" />
          {notifications.unread_count > 0 && (
            <Badge className="absolute -top-1 -right-1 h-5 w-5 p-0">
              {notifications.unread_count > 99 ? '99+' : notifications.unread_count}
            </Badge>
          )}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80">
        <NotificationList notifications={notifications.recent} />
      </PopoverContent>
    </Popover>
  );
}
```

### Reference Files

- Laravel Notifications: https://laravel.com/docs/notifications
- EndorsementService: Story 3.4
- Transaction detail: Story 2.9
- Navigation layout: Story 1.7

### Story Dependencies

**Depends on**:
- Story 3.4 (Endorse Action) - detection occurs during endorsement
- Story 3.3 (Transaction Actions) - is_out_of_workflow flag

**Blocks**:
- Epic 4 Dashboard notifications integration
- Story 5.x Admin Bypass tool (uses out-of-workflow data)

---

## Tasks

### Task 1: Create Notifications Migration
**Estimate**: 15 minutes
- Run Laravel notifications table migration
- `php artisan notifications:table && php artisan migrate`
- Verify table created

**Verification**: Table exists in database

### Task 2: Create Event and Listener
**Estimate**: 30 minutes
- Create `app/Events/OutOfWorkflowEndorsement.php`
- Create `app/Listeners/NotifyOutOfWorkflowEndorsement.php`
- Register in `EventServiceProvider`
- Dispatch event in EndorsementService

**Verification**: Event fires on out-of-workflow endorsement

### Task 3: Create Notification Class
**Estimate**: 30 minutes
- Create `app/Notifications/OutOfWorkflowNotification.php`
- Implement `via()` returning database channel
- Implement `toArray()` with notification data
- Test notification creation

**Verification**: Notification created in database

### Task 4: Add Notification Count to Shared Props
**Estimate**: 20 minutes
- Update `HandleInertiaRequests` middleware
- Add unread_count to shared props
- Add recent notifications array
- Test props available in frontend

**Verification**: Props visible in Vue/React devtools

### Task 5: Create NotificationBell Component
**Estimate**: 45 minutes
- Create `resources/js/Components/NotificationBell.tsx`
- Bell icon with badge counter
- Popover with notification list
- Click notification to navigate
- Mark as read on click

**Verification**: Bell shows count, popover works

### Task 6: Create NotificationList Component
**Estimate**: 30 minutes
- Create `resources/js/Components/NotificationList.tsx`
- Display notification items with icon, message, time
- Unread indicator styling
- Handle different notification types
- "Mark all as read" button

**Verification**: List renders correctly

### Task 7: Add Bell to Layout Header
**Estimate**: 15 minutes
- Update `AuthenticatedLayout.tsx`
- Add NotificationBell component to header
- Position appropriately

**Verification**: Bell visible in header

### Task 8: Create Notifications Page
**Estimate**: 1 hour
- Create `resources/js/Pages/Notifications/Index.tsx`
- Paginated notification list
- Filter by type dropdown
- Filter by read/unread
- Bulk actions (mark read, delete)
- Create corresponding controller

**Verification**: Page loads with notifications

### Task 9: Add Out-of-Workflow Banner
**Estimate**: 30 minutes
- Update Transaction Detail page
- Show warning banner when transaction has out-of-workflow action
- Display expected vs actual office
- Style with amber/yellow colors

**Verification**: Banner shows for out-of-workflow transactions

### Task 10: Create Notification API Endpoints
**Estimate**: 30 minutes
- Create `NotificationController`
- `GET /notifications` - list
- `POST /notifications/{id}/read` - mark single as read
- `POST /notifications/read-all` - mark all as read
- `DELETE /notifications/{id}` - delete single

**Verification**: API endpoints work

### Task 11: Write Feature Tests
**Estimate**: 1.5 hours
- Create `tests/Feature/OutOfWorkflowNotificationTest.php`:
  - Test out-of-workflow endorsement creates notifications
  - Test administrators receive notification
  - Test expected office users receive notification
  - Test notification data contains correct information
  - Test mark as read works
  - Test mark all as read works
  - Test notification count in shared props

**Verification**:
```bash
php artisan test --filter=OutOfWorkflow
```

---

## Acceptance Checklist

- [ ] Out-of-workflow endorsements set is_out_of_workflow flag
- [ ] Event fired on out-of-workflow detection
- [ ] Notifications created for Administrators
- [ ] Notifications created for expected office users
- [ ] Notification contains all required data
- [ ] Bell icon shows in header
- [ ] Badge displays unread count
- [ ] Notification dropdown shows recent items
- [ ] Clicking notification marks as read
- [ ] Clicking notification navigates to transaction
- [ ] "Mark all as read" works
- [ ] Notifications page shows full list
- [ ] Filters work (type, read status)
- [ ] Out-of-workflow banner shows on transaction detail
- [ ] Feature tests pass

**Definition of Done**: Out-of-workflow endorsements are detected, appropriate users are notified via the in-app notification system, and the bell icon displays unread counts with a functional notification panel.

---

## Dev Agent Record

**Story**: 3.8 - Out-of-Workflow Detection & Notifications
**Status**: Ready for review
**Assigned**: notifications-dev
**Start Date**: 2026-02-12
**Completion Date**: 2026-02-12

### Files Created
- [x] `app/Events/OutOfWorkflowEndorsement.php`
- [x] `app/Listeners/NotifyOutOfWorkflowEndorsement.php`
- [x] `app/Notifications/OutOfWorkflowNotification.php`
- [x] `app/Http/Controllers/NotificationController.php`
- [x] `resources/js/Components/NotificationBell.tsx`
- [x] `resources/js/Components/OutOfWorkflowBanner.tsx`
- [x] `resources/js/Pages/Notifications/Index.tsx`
- [x] `tests/Feature/OutOfWorkflowNotificationTest.php`
- [x] `database/migrations/2026_02_12_063606_create_notifications_table.php`

### Files Modified
- [x] `app/Services/EndorsementService.php` (dispatch OutOfWorkflowEndorsement event)
- [x] `app/Http/Middleware/HandleInertiaRequests.php` (lazy-loaded notification count + recent)
- [x] `resources/js/Layouts/AuthenticatedLayout.tsx` (replaced placeholder bell with NotificationBell)
- [x] `resources/js/Pages/PurchaseRequests/Show.tsx` (out-of-workflow warning banner)
- [x] `resources/js/Pages/PurchaseOrders/Show.tsx` (out-of-workflow warning banner)
- [x] `resources/js/Pages/Vouchers/Show.tsx` (out-of-workflow warning banner)
- [x] `resources/js/types/index.d.ts` (AppNotification, NotificationsData types)
- [x] `app/Http/Controllers/PurchaseRequestController.php` (outOfWorkflowInfo prop)
- [x] `app/Http/Controllers/PurchaseOrderController.php` (outOfWorkflowInfo prop)
- [x] `app/Http/Controllers/VoucherController.php` (outOfWorkflowInfo prop)
- [x] `routes/web.php` (notification routes)

### Test Results
- [x] Feature tests: 15 passing (52 assertions)
- [x] EndorsementService tests: 45 passing (no regressions)
- [x] TypeScript compilation: 0 errors

### Implementation Notes
- Used Laravel 12 event auto-discovery (no EventServiceProvider created)
- Notification count uses lazy loading (fn () =>) pattern matching existing pendingReceiptsCount
- NotificationBell uses existing shadcn/ui Popover component
- Out-of-workflow banner is a shared OutOfWorkflowBanner component used by all 3 show pages
- Notification routes use Inertia-compatible controller actions (router.post/delete), not REST API
- AC#8 (email notifications) skipped per instructions
- E2E/Playwright tests skipped per instructions
- Listener excludes admins from expected-office notifications to prevent duplicates

### Time Log
- 2026-02-12: Full implementation of all tasks

---

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Review Type: Pre-Implementation Story Review (Draft status)

### Code Quality Assessment

This is a **pre-implementation review** of the story specification. The story is well-structured with clear acceptance criteria and helpful dev notes with code examples. However, several issues must be addressed before development begins.

**Existing Implementation Already Done:**
- Out-of-workflow detection logic in `EndorsementService::endorse()` — COMPLETE (sets `is_out_of_workflow` flag)
- Placeholder Bell icon in `AuthenticatedLayout.tsx` — EXISTS (non-functional, with "Epic 4" comment)
- Shared props pattern for lazy counts (`pendingReceiptsCount`) — ESTABLISHED

### Issues Identified (Must Fix Before Development)

#### Issue 1: CRITICAL — No Playwright E2E Tests Specified
- **Severity**: High
- **Details**: Task 11 only specifies PHPUnit Feature tests. The tech stack mandates Playwright for E2E testing, and the project has a fully configured Playwright setup with role-based fixtures (`adminTest`, `endorserTest`, `viewerTest`).
- **Required**: Add a new **Task 12: Write Playwright E2E Tests** covering:
  - Bell icon visibility and unread count badge
  - Notification dropdown opens on click and shows recent notifications
  - Click notification marks as read and navigates to transaction detail
  - "Mark all as read" functionality
  - Notifications page loads with filters (type, read/unread)
  - Out-of-workflow warning banner on transaction detail pages
  - RBAC: notification visibility per role
- **Test file**: `tests/e2e/notifications.spec.ts`

#### Issue 2: HIGH — Wrong Transaction Detail Page Referenced
- **Severity**: High
- **Details**: Task 9 and Dev Agent Record reference `resources/js/Pages/Transactions/Show.tsx` for the out-of-workflow warning banner. This file does NOT exist. Transaction details are displayed on the individual show pages:
  - `resources/js/Pages/PurchaseRequests/Show.tsx`
  - `resources/js/Pages/PurchaseOrders/Show.tsx`
  - `resources/js/Pages/Vouchers/Show.tsx`
- **Fix**: Task 9 must update ALL THREE show pages with the warning banner, OR create a shared `OutOfWorkflowBanner` component imported by all three.

#### Issue 3: MEDIUM — Task 10 Uses REST API Pattern Instead of Inertia
- **Severity**: Medium
- **Details**: Task 10 describes REST API endpoints (`GET /notifications`, `POST /notifications/{id}/read`, etc.) but this project uses Inertia.js exclusively — no REST API layer. The notification mark-as-read actions should use `router.post()` / `router.delete()` via Inertia, not AJAX API calls.
- **Fix**: Rewrite Task 10 to use Inertia-compatible controller actions:
  - `NotificationController::index()` → Inertia page render
  - `NotificationController::markAsRead($id)` → `router.post` redirect
  - `NotificationController::markAllAsRead()` → `router.post` redirect
  - `NotificationController::destroy($id)` → `router.delete` redirect
  - Exception: The dropdown could use `router.post` for mark-as-read without full page navigation, which Inertia supports.

#### Issue 4: LOW — EventServiceProvider Reference
- **Severity**: Low
- **Details**: Task 2 says "Register in EventServiceProvider" but this file doesn't exist. Laravel 12 uses event auto-discovery by default.
- **Fix**: Remove the EventServiceProvider step. Laravel 12 auto-discovers events. If explicit registration is desired, use `AppServiceProvider::boot()` or create `EventServiceProvider` following Laravel 12 patterns.

#### Issue 5: LOW — AC#8 Scope Creep
- **Severity**: Low
- **Details**: AC#8 (Email Notifications) is marked "(Optional/Phase 2)" but its inclusion in acceptance criteria could confuse the dev agent into implementing it.
- **Fix**: Move AC#8 to a "Future Considerations" section below the ACs, not as a numbered AC. It should not be part of the acceptance checklist.

### Refactoring Performed

No code refactoring (story is in Draft — no implementation exists yet).

### Compliance Check

- Coding Standards: N/A (pre-implementation review)
- Project Structure: ✗ Task 9 references non-existent `Transactions/Show.tsx`; Task 10 uses non-Inertia API pattern
- Testing Strategy: ✗ Missing Playwright E2E tests requirement
- All ACs Met: N/A (pre-implementation)

### Improvements Checklist

- [ ] **Add Task 12: Playwright E2E Tests** — Create `tests/e2e/notifications.spec.ts` with role-based fixture tests for bell icon, dropdown, mark-as-read, navigation, notifications page, and out-of-workflow banner
- [ ] **Fix Task 9** — Change target from `Transactions/Show.tsx` to all three show pages (PR, PO, VCH) or create shared `OutOfWorkflowBanner` component
- [ ] **Fix Task 10** — Replace REST API endpoints with Inertia-compatible controller actions
- [ ] **Fix Task 2** — Remove EventServiceProvider reference; use Laravel 12 auto-discovery
- [ ] **Move AC#8** — Relocate email notifications to "Future Considerations" section, remove from numbered ACs
- [ ] **Update Dev Agent Record** — Add `tests/e2e/notifications.spec.ts` to Files Created list
- [ ] **Update Files Modified** — Replace `Transactions/Show.tsx` with `PurchaseRequests/Show.tsx`, `PurchaseOrders/Show.tsx`, `Vouchers/Show.tsx`
- [ ] **Add Notification Shared Props types** — Story should mention updating `resources/js/types/index.d.ts` with notification types in the PageProps interface
- [ ] **Consider using Popover from shadcn/ui** — Verify `@shadcn/popover` is installed or add to Task 5 prerequisites

### Security Review

- **Notification access control**: Story correctly scopes notifications to the notifiable user via Laravel's polymorphic relationship. No cross-user notification leakage risk.
- **Mark-as-read authorization**: Ensure the NotificationController verifies the notification belongs to the authenticated user before marking as read. Add a Policy or inline check.
- **No sensitive data in notification payload**: The `toArray()` data structure looks appropriate — no passwords, tokens, or PII beyond user names.

### Performance Considerations

- **N+1 risk in shared props**: The `unreadNotifications()->count()` query runs on EVERY Inertia request. Use Laravel's lazy loading (`fn () =>`) pattern already established with `pendingReceiptsCount`.
- **Notification list query**: Loading 10 recent notifications on every page load could be expensive. Consider lazy-loading or loading only on dropdown open via a separate Inertia partial reload.
- **Index on `read_at`**: Laravel's default notifications migration includes appropriate indexes, but verify `(notifiable_type, notifiable_id, read_at)` composite index exists for efficient unread count queries.

### Files Modified During Review

None (pre-implementation review — only story file QA Results section updated).

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.8-out-of-workflow-detection-notifications.yml
Risk profile: N/A (pre-implementation)
NFR assessment: N/A (pre-implementation)

### Recommended Status

✗ Changes Required — Story must address the 5 issues above (especially adding Playwright E2E tests and fixing file references) before moving to "Ready for Dev". See unchecked items in Improvements Checklist.
