# Story 3.8: Out-of-Workflow Detection & Notifications

**Status**: Draft
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As an Administrator, I want to be notified when transactions are endorsed to offices outside the expected workflow, so that I can identify and correct misrouting promptly.

---

## Acceptance Criteria

1. **Out-of-Workflow Detection Logic**: System detects out-of-workflow endorsements when:
   - Transaction has an assigned workflow
   - Endorsed target office does NOT match the expected next step's office
   - `is_out_of_workflow` flag set to `true` on the transaction_action record
   - Detection occurs at endorsement time (Story 3.4)

2. **Notification Creation**: When out-of-workflow endorsement occurs:
   - Create notification for all Administrators
   - Create notification for users assigned to the expected receiving office
   - Notification contains:
     - Transaction reference number
     - Category (PR/PO/VCH)
     - Expected office (per workflow)
     - Actual target office (where it was sent)
     - User who performed the endorsement
     - Timestamp

3. **Notifications Table Migration**: Create `notifications` table:
   - `id` (UUID primary key)
   - `type` (string) - notification class name
   - `notifiable_type` (string) - polymorphic type
   - `notifiable_id` (bigint) - polymorphic ID
   - `data` (JSON) - notification payload
   - `read_at` (timestamp, nullable)
   - `created_at` (timestamp)
   - Standard Laravel notifications table structure

4. **Bell Icon & Badge**: In application header:
   - Bell icon with unread notification count badge
   - Badge hidden when count is 0
   - Badge shows count (max display "99+")
   - Click opens notification dropdown/panel

5. **Notification Panel/Dropdown**: Displays:
   - List of recent notifications (last 20)
   - Each notification shows:
     - Icon based on type (warning for out-of-workflow)
     - Summary message
     - Relative timestamp ("5 minutes ago")
     - Unread indicator (dot or background)
   - Click notification:
     - Marks as read
     - Navigates to relevant transaction detail
   - "Mark all as read" action
   - "View all notifications" link to full page

6. **Notifications Page**: Full notifications page at `/notifications`:
   - Paginated list of all notifications
   - Filter by type (all, out-of-workflow, received, overdue, etc.)
   - Filter by read/unread status
   - Bulk mark as read
   - Delete old notifications

7. **Out-of-Workflow Warning Banner**: On Transaction Detail for out-of-workflow transactions:
   - Yellow/amber warning banner
   - Message: "This transaction was routed outside the expected workflow"
   - Shows expected office vs actual office
   - Link to admin bypass tool (Story 5.x)

8. **Email Notifications (Optional/Phase 2)**: Prepare structure for:
   - Email notification channel
   - User preference for email notifications
   - Queue-based email sending

---

## Dev Notes

### Out-of-Workflow Detection Point

Detection happens in the `endorse()` method (Story 3.4):

```php
// In EndorsementService::endorse()
$expectedNextOffice = $this->getExpectedNextOffice($transaction);
$isOutOfWorkflow = $expectedNextOffice?->id !== $toOfficeId;

$action = TransactionAction::create([
    // ...
    'is_out_of_workflow' => $isOutOfWorkflow,
]);

if ($isOutOfWorkflow) {
    event(new OutOfWorkflowEndorsement($action));
}
```

### Event and Listener Pattern

```php
// app/Events/OutOfWorkflowEndorsement.php
class OutOfWorkflowEndorsement
{
    public function __construct(
        public TransactionAction $action
    ) {}
}

// app/Listeners/NotifyOutOfWorkflowEndorsement.php
class NotifyOutOfWorkflowEndorsement
{
    public function handle(OutOfWorkflowEndorsement $event): void
    {
        $action = $event->action;
        $transaction = $action->transaction;

        // Get expected office
        $expectedOffice = $transaction->currentStep?->getNextStep()?->office;

        // Notify all administrators
        $admins = User::role('Administrator')->get();
        Notification::send($admins, new OutOfWorkflowNotification($action, $expectedOffice));

        // Notify expected office users
        if ($expectedOffice) {
            $expectedUsers = User::where('office_id', $expectedOffice->id)->get();
            Notification::send($expectedUsers, new OutOfWorkflowNotification($action, $expectedOffice));
        }
    }
}
```

### Notification Class

```php
// app/Notifications/OutOfWorkflowNotification.php
class OutOfWorkflowNotification extends Notification
{
    public function __construct(
        protected TransactionAction $action,
        protected ?Office $expectedOffice
    ) {}

    public function via($notifiable): array
    {
        return ['database'];
    }

    public function toArray($notifiable): array
    {
        $transaction = $this->action->transaction;
        $actualOffice = $this->action->toOffice;

        return [
            'type' => 'out_of_workflow',
            'transaction_id' => $transaction->id,
            'reference_number' => $transaction->reference_number,
            'category' => $transaction->category,
            'expected_office_id' => $this->expectedOffice?->id,
            'expected_office_name' => $this->expectedOffice?->name ?? 'Unknown',
            'actual_office_id' => $actualOffice->id,
            'actual_office_name' => $actualOffice->name,
            'endorsed_by_user_id' => $this->action->from_user_id,
            'endorsed_by_name' => $this->action->fromUser->name,
            'message' => "Transaction {$transaction->reference_number} was sent to {$actualOffice->name} instead of expected {$this->expectedOffice?->name}",
        ];
    }
}
```

### Shared Props for Notification Count

```php
// app/Http/Middleware/HandleInertiaRequests.php
public function share(Request $request): array
{
    return [
        // ... other shared data
        'notifications' => [
            'unread_count' => $request->user()
                ? $request->user()->unreadNotifications()->count()
                : 0,
            'recent' => $request->user()
                ? $request->user()->notifications()
                    ->take(10)
                    ->get()
                    ->map(fn ($n) => [
                        'id' => $n->id,
                        'type' => $n->data['type'] ?? 'general',
                        'message' => $n->data['message'] ?? '',
                        'read_at' => $n->read_at,
                        'created_at' => $n->created_at->diffForHumans(),
                        'data' => $n->data,
                    ])
                : [],
        ],
    ];
}
```

### Bell Icon Component

```tsx
// resources/js/Components/NotificationBell.tsx
export function NotificationBell() {
  const { notifications } = usePage().props;
  const [isOpen, setIsOpen] = useState(false);

  return (
    <Popover open={isOpen} onOpenChange={setIsOpen}>
      <PopoverTrigger asChild>
        <Button variant="ghost" size="icon" className="relative">
          <Bell className="h-5 w-5" />
          {notifications.unread_count > 0 && (
            <Badge className="absolute -top-1 -right-1 h-5 w-5 p-0">
              {notifications.unread_count > 99 ? '99+' : notifications.unread_count}
            </Badge>
          )}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80">
        <NotificationList notifications={notifications.recent} />
      </PopoverContent>
    </Popover>
  );
}
```

### Reference Files

- Laravel Notifications: https://laravel.com/docs/notifications
- EndorsementService: Story 3.4
- Transaction detail: Story 2.9
- Navigation layout: Story 1.7

### Story Dependencies

**Depends on**:
- Story 3.4 (Endorse Action) - detection occurs during endorsement
- Story 3.3 (Transaction Actions) - is_out_of_workflow flag

**Blocks**:
- Epic 4 Dashboard notifications integration
- Story 5.x Admin Bypass tool (uses out-of-workflow data)

---

## Tasks

### Task 1: Create Notifications Migration
**Estimate**: 15 minutes
- Run Laravel notifications table migration
- `php artisan notifications:table && php artisan migrate`
- Verify table created

**Verification**: Table exists in database

### Task 2: Create Event and Listener
**Estimate**: 30 minutes
- Create `app/Events/OutOfWorkflowEndorsement.php`
- Create `app/Listeners/NotifyOutOfWorkflowEndorsement.php`
- Register in `EventServiceProvider`
- Dispatch event in EndorsementService

**Verification**: Event fires on out-of-workflow endorsement

### Task 3: Create Notification Class
**Estimate**: 30 minutes
- Create `app/Notifications/OutOfWorkflowNotification.php`
- Implement `via()` returning database channel
- Implement `toArray()` with notification data
- Test notification creation

**Verification**: Notification created in database

### Task 4: Add Notification Count to Shared Props
**Estimate**: 20 minutes
- Update `HandleInertiaRequests` middleware
- Add unread_count to shared props
- Add recent notifications array
- Test props available in frontend

**Verification**: Props visible in Vue/React devtools

### Task 5: Create NotificationBell Component
**Estimate**: 45 minutes
- Create `resources/js/Components/NotificationBell.tsx`
- Bell icon with badge counter
- Popover with notification list
- Click notification to navigate
- Mark as read on click

**Verification**: Bell shows count, popover works

### Task 6: Create NotificationList Component
**Estimate**: 30 minutes
- Create `resources/js/Components/NotificationList.tsx`
- Display notification items with icon, message, time
- Unread indicator styling
- Handle different notification types
- "Mark all as read" button

**Verification**: List renders correctly

### Task 7: Add Bell to Layout Header
**Estimate**: 15 minutes
- Update `AuthenticatedLayout.tsx`
- Add NotificationBell component to header
- Position appropriately

**Verification**: Bell visible in header

### Task 8: Create Notifications Page
**Estimate**: 1 hour
- Create `resources/js/Pages/Notifications/Index.tsx`
- Paginated notification list
- Filter by type dropdown
- Filter by read/unread
- Bulk actions (mark read, delete)
- Create corresponding controller

**Verification**: Page loads with notifications

### Task 9: Add Out-of-Workflow Banner
**Estimate**: 30 minutes
- Update Transaction Detail page
- Show warning banner when transaction has out-of-workflow action
- Display expected vs actual office
- Style with amber/yellow colors

**Verification**: Banner shows for out-of-workflow transactions

### Task 10: Create Notification API Endpoints
**Estimate**: 30 minutes
- Create `NotificationController`
- `GET /notifications` - list
- `POST /notifications/{id}/read` - mark single as read
- `POST /notifications/read-all` - mark all as read
- `DELETE /notifications/{id}` - delete single

**Verification**: API endpoints work

### Task 11: Write Feature Tests
**Estimate**: 1.5 hours
- Create `tests/Feature/OutOfWorkflowNotificationTest.php`:
  - Test out-of-workflow endorsement creates notifications
  - Test administrators receive notification
  - Test expected office users receive notification
  - Test notification data contains correct information
  - Test mark as read works
  - Test mark all as read works
  - Test notification count in shared props

**Verification**:
```bash
php artisan test --filter=OutOfWorkflow
```

---

## Acceptance Checklist

- [ ] Out-of-workflow endorsements set is_out_of_workflow flag
- [ ] Event fired on out-of-workflow detection
- [ ] Notifications created for Administrators
- [ ] Notifications created for expected office users
- [ ] Notification contains all required data
- [ ] Bell icon shows in header
- [ ] Badge displays unread count
- [ ] Notification dropdown shows recent items
- [ ] Clicking notification marks as read
- [ ] Clicking notification navigates to transaction
- [ ] "Mark all as read" works
- [ ] Notifications page shows full list
- [ ] Filters work (type, read status)
- [ ] Out-of-workflow banner shows on transaction detail
- [ ] Feature tests pass

**Definition of Done**: Out-of-workflow endorsements are detected, appropriate users are notified via the in-app notification system, and the bell icon displays unread counts with a functional notification panel.

---

## Dev Agent Record

**Story**: 3.8 - Out-of-Workflow Detection & Notifications
**Status**: Draft
**Assigned**:
**Start Date**:
**Completion Date**:

### Files Created
- [ ] `app/Events/OutOfWorkflowEndorsement.php`
- [ ] `app/Listeners/NotifyOutOfWorkflowEndorsement.php`
- [ ] `app/Notifications/OutOfWorkflowNotification.php`
- [ ] `app/Http/Controllers/NotificationController.php`
- [ ] `resources/js/Components/NotificationBell.tsx`
- [ ] `resources/js/Components/NotificationList.tsx`
- [ ] `resources/js/Pages/Notifications/Index.tsx`
- [ ] `tests/Feature/OutOfWorkflowNotificationTest.php`

### Files Modified
- [ ] `app/Services/EndorsementService.php` (dispatch event)
- [ ] `app/Providers/EventServiceProvider.php`
- [ ] `app/Http/Middleware/HandleInertiaRequests.php`
- [ ] `resources/js/Layouts/AuthenticatedLayout.tsx`
- [ ] `resources/js/Pages/Transactions/Show.tsx` (warning banner)
- [ ] `routes/web.php`

### Test Results
- [ ] Feature tests: X passing
- [ ] All project tests: X passing

### Implementation Notes
*(To be filled by dev agent)*

### Time Log
*(To be filled by dev agent)*

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
