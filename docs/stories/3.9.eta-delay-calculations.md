# Story 3.9: ETA & Delay Calculations

**Status**: Done
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As a user, I want to see estimated completion times and delay indicators for transactions, so that I can track progress against SLAs and identify bottlenecks.

---

## Acceptance Criteria

1. **ETA Calculation Service**: Implement `EtaCalculationService` that computes:
   - **Current Step ETA**: `received_at + expected_days` for the current workflow step
   - **Overall Completion ETA**: Sum of remaining steps' expected_days from current position
   - **Time at Current Step**: Business days since received_at
   - Handle business days calculation (exclude weekends)
   - Return null for completed or cancelled transactions

2. **Delay Detection**: System calculates delay status:
   - **Delay Days**: `max(0, today - current_step_ETA)` in business days
   - **Stagnant Flag**: True when:
     - delay_days > 0, OR
     - No movement for `idle_threshold_days` (configurable, default: 2 days)
   - Delay severity levels:
     - On Track: 0 delay days
     - Warning: 1-2 delay days
     - Overdue: 3+ delay days

3. **Transaction Model Enhancements**: Add computed attributes:
   - `eta_current_step` - date when current step should complete
   - `eta_completion` - date when transaction should fully complete
   - `delay_days` - number of business days delayed
   - `is_stagnant` - boolean flag for stagnant transactions
   - `delay_severity` - enum: on_track, warning, overdue

4. **Transaction List Display**: On transaction list pages show:
   - ETA column with estimated completion date
   - Delay indicator (color-coded badge or icon)
   - Sort by ETA and delay days
   - Filter for stagnant/overdue transactions

5. **Transaction Detail Display**: On transaction detail show:
   - Current step ETA with days remaining/overdue
   - Overall completion ETA
   - Progress bar showing position in workflow
   - Delay warning banner if overdue
   - Time spent at current step

6. **Idle Threshold Configuration**: Admin-configurable setting:
   - Default: 2 business days
   - Stored in application config or database settings
   - Used for stagnant detection

7. **Business Days Calculation**: Service handles:
   - Exclude weekends (Saturday, Sunday)
   - Future: Configurable holidays (out of scope for this story)
   - Calculate business days between two dates
   - Add business days to a date

8. **TypeScript Interfaces**: Update types:
   ```typescript
   interface TransactionWithEta extends Transaction {
     eta_current_step: string | null; // ISO date
     eta_completion: string | null; // ISO date
     delay_days: number;
     is_stagnant: boolean;
     delay_severity: 'on_track' | 'warning' | 'overdue';
     days_at_current_step: number;
   }
   ```

---

## Dev Notes

### ETA Calculation Logic

```php
// app/Services/EtaCalculationService.php
class EtaCalculationService
{
    protected int $idleThresholdDays;

    public function __construct()
    {
        $this->idleThresholdDays = config('opts.idle_threshold_days', 2);
    }

    /**
     * Calculate ETA for current step completion.
     * Returns the date when the current step should be completed.
     */
    public function getCurrentStepEta(Transaction $transaction): ?Carbon
    {
        if (!$transaction->received_at || !$transaction->currentStep) {
            return null;
        }

        $expectedDays = $transaction->currentStep->expected_days;
        return $this->addBusinessDays(
            Carbon::parse($transaction->received_at),
            $expectedDays
        );
    }

    /**
     * Calculate ETA for overall transaction completion.
     * Sums expected_days for all remaining steps.
     */
    public function getCompletionEta(Transaction $transaction): ?Carbon
    {
        if ($transaction->status === 'Completed' || $transaction->status === 'Cancelled') {
            return null;
        }

        $currentStepOrder = $transaction->currentStep?->step_order ?? 0;
        $workflow = $transaction->workflow;

        if (!$workflow) {
            return null;
        }

        // Get remaining steps (including current)
        $remainingSteps = $workflow->steps()
            ->where('step_order', '>=', $currentStepOrder)
            ->get();

        // Calculate from received_at for current step, then add remaining
        $startDate = $transaction->received_at
            ? Carbon::parse($transaction->received_at)
            : now();

        $totalDays = $remainingSteps->sum('expected_days');

        // Subtract time already spent at current step
        if ($transaction->received_at) {
            $daysSpent = $this->businessDaysBetween(
                Carbon::parse($transaction->received_at),
                now()
            );
            $totalDays = max(0, $totalDays - $daysSpent);
        }

        return $this->addBusinessDays(now(), $totalDays);
    }

    /**
     * Calculate delay in business days for current step.
     */
    public function getDelayDays(Transaction $transaction): int
    {
        $eta = $this->getCurrentStepEta($transaction);

        if (!$eta || now()->lte($eta)) {
            return 0;
        }

        return $this->businessDaysBetween($eta, now());
    }

    /**
     * Determine if transaction is stagnant.
     */
    public function isStagnant(Transaction $transaction): bool
    {
        // Stagnant if delayed
        if ($this->getDelayDays($transaction) > 0) {
            return true;
        }

        // Stagnant if no movement for idle threshold
        $lastAction = $transaction->actions()->latest()->first();
        if (!$lastAction) {
            return false;
        }

        $daysSinceAction = $this->businessDaysBetween(
            Carbon::parse($lastAction->created_at),
            now()
        );

        return $daysSinceAction >= $this->idleThresholdDays;
    }

    /**
     * Get delay severity level.
     */
    public function getDelaySeverity(Transaction $transaction): string
    {
        $delayDays = $this->getDelayDays($transaction);

        return match(true) {
            $delayDays === 0 => 'on_track',
            $delayDays <= 2 => 'warning',
            default => 'overdue',
        };
    }

    /**
     * Calculate business days between two dates.
     */
    public function businessDaysBetween(Carbon $start, Carbon $end): int
    {
        $days = 0;
        $current = $start->copy();

        while ($current->lt($end)) {
            if (!$current->isWeekend()) {
                $days++;
            }
            $current->addDay();
        }

        return $days;
    }

    /**
     * Add business days to a date.
     */
    public function addBusinessDays(Carbon $date, int $days): Carbon
    {
        $result = $date->copy();
        $added = 0;

        while ($added < $days) {
            $result->addDay();
            if (!$result->isWeekend()) {
                $added++;
            }
        }

        return $result;
    }
}
```

### Transaction Model Accessors

```php
// In Transaction model
public function getEtaCurrentStepAttribute(): ?string
{
    $eta = app(EtaCalculationService::class)->getCurrentStepEta($this);
    return $eta?->toDateString();
}

public function getEtaCompletionAttribute(): ?string
{
    $eta = app(EtaCalculationService::class)->getCompletionEta($this);
    return $eta?->toDateString();
}

public function getDelayDaysAttribute(): int
{
    return app(EtaCalculationService::class)->getDelayDays($this);
}

public function getIsStagnantAttribute(): bool
{
    return app(EtaCalculationService::class)->isStagnant($this);
}

public function getDelaySeverityAttribute(): string
{
    return app(EtaCalculationService::class)->getDelaySeverity($this);
}

public function getDaysAtCurrentStepAttribute(): int
{
    if (!$this->received_at) {
        return 0;
    }

    return app(EtaCalculationService::class)->businessDaysBetween(
        Carbon::parse($this->received_at),
        now()
    );
}
```

### Delay Severity Badge Component

```tsx
// resources/js/Components/DelaySeverityBadge.tsx
const severityStyles = {
  on_track: 'bg-green-100 text-green-800',
  warning: 'bg-yellow-100 text-yellow-800',
  overdue: 'bg-red-100 text-red-800',
};

const severityLabels = {
  on_track: 'On Track',
  warning: 'Warning',
  overdue: 'Overdue',
};

export function DelaySeverityBadge({ severity, delayDays }: Props) {
  return (
    <Badge className={severityStyles[severity]}>
      {severityLabels[severity]}
      {delayDays > 0 && ` (${delayDays}d)`}
    </Badge>
  );
}
```

### Configuration

```php
// config/opts.php
return [
    'idle_threshold_days' => env('OPTS_IDLE_THRESHOLD_DAYS', 2),
];
```

### Reference Files

- Transaction model: Story 2.1
- Workflow model: Story 3.1
- Transaction list page: Story 2.x
- Transaction detail page: Story 2.9

### Story Dependencies

**Depends on**:
- Story 3.1 (Workflow Schema) - for expected_days data
- Story 3.3 (Transaction Actions) - for last action timestamp
- Story 3.5 (Receive Action) - for received_at timestamp

**Blocks**:
- Story 3.10 (Timeline Visualization) - uses ETA data
- Epic 4 Dashboard (stagnant transactions panel)

---

## Tasks

### Task 1: Create ETA Calculation Service
**Estimate**: 1.5 hours
- Create `app/Services/EtaCalculationService.php`
- Implement `getCurrentStepEta()` method
- Implement `getCompletionEta()` method
- Implement `getDelayDays()` method
- Implement `isStagnant()` method
- Implement `getDelaySeverity()` method
- Implement business days helper methods
- Register in service container

**Verification**: Test methods in tinker

### Task 2: Create Configuration
**Estimate**: 10 minutes
- Create `config/opts.php`
- Add `idle_threshold_days` setting
- Update `.env.example`

**Verification**: Config accessible via `config('opts.idle_threshold_days')`

### Task 3: Add Transaction Model Accessors
**Estimate**: 30 minutes
- Update `app/Models/Transaction.php`
- Add `eta_current_step` accessor
- Add `eta_completion` accessor
- Add `delay_days` accessor
- Add `is_stagnant` accessor
- Add `delay_severity` accessor
- Add `days_at_current_step` accessor
- Add `$appends` for API serialization

**Verification**: Test accessors in tinker

### Task 4: Update TypeScript Interfaces
**Estimate**: 15 minutes
- Update `resources/js/types/models.ts`
- Add ETA-related fields to Transaction interface
- Add DelaySeverity type

**Verification**: TypeScript compiles

### Task 5: Create DelaySeverityBadge Component
**Estimate**: 20 minutes
- Create `resources/js/Components/DelaySeverityBadge.tsx`
- Color-coded by severity
- Show delay days when applicable

**Verification**: Component renders correctly

### Task 6: Update Transaction List Page
**Estimate**: 45 minutes
- Update transaction list to show ETA column
- Show delay severity badge
- Add sort options for ETA and delay_days
- Add filter for stagnant/overdue transactions

**Verification**: List shows ETA data and filters work

### Task 7: Update Transaction Detail Page
**Estimate**: 45 minutes
- Show current step ETA with status
- Show overall completion ETA
- Add delay warning banner when overdue
- Show time spent at current step
- Integrate DelaySeverityBadge

**Verification**: Detail page shows ETA information

### Task 8: Create Stagnant Transactions Scope
**Estimate**: 20 minutes
- Add `scopeStagnant()` to Transaction model
- Filter transactions where is_stagnant = true
- May need raw SQL or cached calculation

**Verification**: Scope returns correct transactions

### Task 9: Write Unit Tests
**Estimate**: 1.5 hours
- Create `tests/Unit/Services/EtaCalculationServiceTest.php`:
  - Test getCurrentStepEta calculation
  - Test getCompletionEta calculation
  - Test getDelayDays calculation
  - Test isStagnant detection
  - Test getDelaySeverity levels
  - Test businessDaysBetween (including weekends)
  - Test addBusinessDays (including weekends)

**Verification**:
```bash
php artisan test --filter=EtaCalculation
```

### Task 10: Write Feature Tests
**Estimate**: 45 minutes
- Create `tests/Feature/TransactionEtaTest.php`:
  - Test ETA displayed on transaction detail
  - Test delay badge on transaction list
  - Test stagnant filter returns correct transactions

**Verification**:
```bash
php artisan test --filter=TransactionEta
```

---

## Acceptance Checklist

- [ ] ETA calculation service computes correct values
- [ ] Business days exclude weekends
- [ ] Current step ETA based on received_at + expected_days
- [ ] Completion ETA sums remaining steps
- [ ] Delay days calculated correctly
- [ ] Stagnant detection works (delay OR idle)
- [ ] Delay severity levels (on_track, warning, overdue) correct
- [ ] Transaction model accessors return proper values
- [ ] Transaction list shows ETA and delay columns
- [ ] Transaction list sortable by ETA
- [ ] Transaction list filterable by stagnant/overdue
- [ ] Transaction detail shows ETA information
- [ ] Delay warning banner shows when overdue
- [ ] DelaySeverityBadge displays correctly
- [ ] Idle threshold is configurable
- [ ] Unit tests pass
- [ ] Feature tests pass

**Definition of Done**: Users can see ETAs and delay indicators for transactions, stagnant transactions are identifiable, and the system accurately tracks progress against workflow SLAs.

---

## Dev Agent Record

**Story**: 3.9 - ETA & Delay Calculations
**Status**: Ready for review
**Assigned**: eta-dev
**Start Date**: 2026-02-12
**Completion Date**: 2026-02-12

### Files Created
- [x] `app/Services/EtaCalculationService.php`
- [x] `config/opts.php`
- [x] `resources/js/Components/DelaySeverityBadge.tsx`
- [x] `tests/Unit/Services/EtaCalculationServiceTest.php`
- [x] `tests/Feature/TransactionEtaTest.php`

### Files Modified
- [x] `app/Models/Transaction.php` - Added workflow() relationship, $appends, ETA accessors
- [x] `resources/js/types/models.ts` - Added DelaySeverity type, ETA fields to Transaction
- [x] `resources/js/Pages/Transactions/Pending.tsx` - Added ETA and Delay columns
- [x] `resources/js/Pages/PurchaseRequests/Show.tsx` - Added ETA info section, delay warning banner
- [x] `resources/js/Pages/PurchaseOrders/Show.tsx` - Added ETA info section, delay warning banner
- [x] `resources/js/Pages/Vouchers/Show.tsx` - Added ETA info section, delay warning banner
- [x] `.env.example` - Added OPTS_IDLE_THRESHOLD_DAYS

### Test Results
- [x] Unit tests: 26 passing
- [x] Feature tests: 4 passing
- [x] TypeScript: Compiles cleanly (no errors)

### Implementation Notes
- Transaction model now has `workflow()` BelongsTo relationship (was missing)
- ETA computed attributes are appended via `$appends` so they serialize automatically to Inertia
- Business days calculation excludes weekends (Sat/Sun)
- Idle threshold configurable via `config/opts.php` / `OPTS_IDLE_THRESHOLD_DAYS` env var (default: 2)
- Delay severity: on_track (0 days), warning (1-2 days), overdue (3+ days)
- Updated all 3 Show pages (PR/PO/VCH) instead of nonexistent Transactions/Show.tsx
- Updated Transactions/Pending.tsx (list page) instead of nonexistent Transactions/Index.tsx

### Time Log
- Implementation: ~30 minutes

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
