# Story 4.2.3: Notification Preferences

**Status**: Draft
**Epic**: Epic 4.2 - Notification System Expansion

---

## Story

**As a** user,
**I want** to configure which notification types I receive,
**so that** I only get alerts relevant to my workflow responsibilities.

---

## Acceptance Criteria

1. **`notification_preferences` Migration**: A new `notification_preferences` table exists with the following columns:
   - `id` (auto-increment primary key)
   - `user_id` (foreign key to `users.id`, unique, cascade on delete)
   - `out_of_workflow` (boolean, default `true`)
   - `received` (boolean, default `true`)
   - `overdue` (boolean, default `true`)
   - `completed` (boolean, default `true`)
   - `announcement` (boolean, default `true`)
   - `timestamps()`

2. **`NotificationPreference` Model**: `app/Models/NotificationPreference.php` exists with:
   - `$fillable` covering all writable columns
   - `$casts` for all boolean preference columns
   - `user()` BelongsTo relationship to `User`
   - Static `getDefaults()` method returning an array of all preferences set to `true`

3. **`User` Model Relationship**: `app/Models/User.php` is updated with:
   - `notificationPreference()` HasOne relationship to `NotificationPreference`
   - `getNotificationPreferences(): NotificationPreference` helper method that returns the user's preference record, creating one with all-enabled defaults if none exists (first-or-create pattern)

4. **Notification Preferences Section on Profile Page**: A new partial component `resources/js/Pages/Profile/Partials/NotificationPreferencesForm.tsx` exists and is rendered on the Profile/Edit page as a new card section:
   - Displays a toggle (shadcn/ui `Switch`) for each notification type: Out of Workflow, Received, Overdue, Completed, Announcements
   - Each toggle shows the notification type name and a short description
   - A "Save Preferences" button submits the form via Inertia `patch` to `notification-preferences.update`
   - Shows a "Saved." success transition after save (follows `UpdateProfileInformationForm.tsx` pattern)
   - Emergency announcements display a note: "Emergency announcements cannot be disabled"

5. **Notification Preference Route**: A new route is registered in `routes/web.php` under the `auth` middleware group:
   - `PATCH /notification-preferences` — `NotificationPreferenceController@update` — named `notification-preferences.update`
   - Note: No separate GET route needed — preference data is loaded via `ProfileController::edit()` and passed as an Inertia prop

6. **`NotificationPreferenceController`**: `app/Http/Controllers/NotificationPreferenceController.php` exists with:
   - `update(Request $request)` — validates boolean fields, updates or creates the user's notification preferences, redirects back with success flash

7. **ProfileController Integration**: `app/Http/Controllers/ProfileController.php` `edit()` method is updated to pass `notificationPreferences` to the Profile/Edit Inertia page, loaded from `$request->user()->getNotificationPreferences()`

8. **Preference Checking in Notification Dispatch**: All notification dispatchers (listeners and commands) check the target user's notification preferences before sending:
   - `NotifyOutOfWorkflowEndorsement` listener checks `out_of_workflow` preference
   - `NotifyTransactionReceived` listener (from 4.2.1) checks `received` preference
   - `NotifyTransactionCompleted` listener (from 4.2.1) checks `completed` preference
   - `CheckOverdueTransactions` command (from 4.2.1) checks `overdue` preference
   - `AnnouncementController::store()` (from 4.2.2) checks `announcement` preference
   - Filtering is done by loading preferences for each target user and skipping those who have disabled the type

9. **Emergency Announcement Bypass**: Announcements with `severity = 'Emergency'` bypass the `announcement` preference and are always delivered to all active users, regardless of the user's preference setting.

10. **Default Preferences for New Users**: When a user has no `notification_preferences` record (new users or existing users who haven't visited the preferences page), all notification types are treated as enabled. The `getNotificationPreferences()` method creates a default record on first access.

11. **Helper Method for Preference Checking**: A reusable static method exists on `NotificationPreference` (or as a service method) for checking whether a user should receive a given notification type:
    - `NotificationPreference::shouldNotify(User $user, string $type): bool`
    - Returns `true` if the user has the given type enabled (or has no preferences record)
    - Used by all listeners/commands for consistent preference checking

12. **TypeScript Types Updated**: `resources/js/types/models.ts` includes a `NotificationPreference` interface, and `Profile/Edit.tsx` props include `notificationPreferences`

13. **Testing**: Feature tests exist covering:
    - User can view their notification preferences on the profile page
    - User can update notification preferences (toggle individual types on/off)
    - Notification dispatch respects user preferences (disabled type = no notification)
    - Notification dispatch sends when preference is enabled
    - Default preferences: new user with no record receives all notifications
    - Emergency announcements bypass the `announcement` preference
    - `NotificationPreference::shouldNotify()` returns correct results
    - Validation rejects non-boolean values for preference fields

---

## Tasks / Subtasks

- [ ] Task 1: Create `notification_preferences` table migration (AC: 1)
  - [ ] Create migration file at `database/migrations/2026_02_18_000200_create_notification_preferences_table.php`
  - [ ] Schema: `id`, `user_id` (foreignId, unique, cascadeOnDelete), `out_of_workflow` (boolean, default true), `received` (boolean, default true), `overdue` (boolean, default true), `completed` (boolean, default true), `announcement` (boolean, default true), `timestamps()`
  - [ ] Run `php artisan migrate --pretend` to verify before actual migration

- [ ] Task 2: Create `NotificationPreference` model (AC: 2, 11)
  - [ ] Create `app/Models/NotificationPreference.php` with `declare(strict_types=1)`
  - [ ] Add `$fillable`: `['user_id', 'out_of_workflow', 'received', 'overdue', 'completed', 'announcement']`
  - [ ] Add `$casts` for all boolean columns
  - [ ] Add `user()` BelongsTo relationship
  - [ ] Add static `getDefaults(): array` method returning all preferences as `true`
  - [ ] Add static `shouldNotify(User $user, string $type): bool` method

- [ ] Task 3: Update `User` model with preference relationship (AC: 3, 10)
  - [ ] Add `notificationPreference()` HasOne relationship to `app/Models/User.php`
  - [ ] Add `getNotificationPreferences(): NotificationPreference` method using `firstOrCreate` pattern
  - [ ] Add `use Illuminate\Database\Eloquent\Relations\HasOne` import

- [ ] Task 4: Create `NotificationPreferenceController` (AC: 6)
  - [ ] Create `app/Http/Controllers/NotificationPreferenceController.php` with `declare(strict_types=1)`
  - [ ] `update(Request $request)` — validate boolean fields, `updateOrCreate` preferences, redirect back with success flash

- [ ] Task 5: Register routes (AC: 5)
  - [ ] Add `PATCH /notification-preferences` route in `routes/web.php` under existing `auth` middleware group
  - [ ] Name: `notification-preferences.update`

- [ ] Task 6: Update `ProfileController` to pass notification preferences (AC: 7)
  - [ ] Modify `edit()` method in `app/Http/Controllers/ProfileController.php` to include `notificationPreferences` in Inertia props
  - [ ] Load via `$request->user()->getNotificationPreferences()`

- [ ] Task 7: Create `NotificationPreferencesForm` partial component (AC: 4)
  - [ ] Create `resources/js/Pages/Profile/Partials/NotificationPreferencesForm.tsx`
  - [ ] Use shadcn/ui `Switch` from `@/Components/ui/switch` and `Label` from `@/Components/ui/label`
  - [ ] Display toggles for: Out of Workflow, Received, Overdue, Completed, Announcements
  - [ ] Each toggle has a name and description
  - [ ] Emergency bypass note below Announcements toggle
  - [ ] Submit via `useForm` + `patch(route('notification-preferences.update'))`
  - [ ] "Saved." transition on success (follow `UpdateProfileInformationForm.tsx` pattern)

- [ ] Task 8: Integrate `NotificationPreferencesForm` into Profile/Edit page (AC: 4)
  - [ ] Update `resources/js/Pages/Profile/Edit.tsx` to import and render `NotificationPreferencesForm`
  - [ ] Add as a new card section between "Update Password" and "Delete Account"
  - [ ] Pass `notificationPreferences` prop

- [ ] Task 9: Update TypeScript types (AC: 12)
  - [ ] Add `NotificationPreference` interface to `resources/js/types/models.ts`
  - [ ] Update `Profile/Edit.tsx` props type to include `notificationPreferences`

- [ ] Task 10: Add preference checking to existing `NotifyOutOfWorkflowEndorsement` listener (AC: 8)
  - [ ] In `app/Listeners/NotifyOutOfWorkflowEndorsement.php`, filter target users through `NotificationPreference::shouldNotify($user, 'out_of_workflow')` before sending
  - [ ] Import `NotificationPreference` model

- [ ] Task 11: Add preference checking to Story 4.2.1 listeners and command (AC: 8)
  - [ ] In `NotifyTransactionReceived` listener: filter users by `received` preference
  - [ ] In `NotifyTransactionCompleted` listener: filter users by `completed` preference
  - [ ] In `CheckOverdueTransactions` command: filter users by `overdue` preference

- [ ] Task 12: Add preference checking to announcement dispatch (AC: 8, 9)
  - [ ] In `AnnouncementController::store()` (from Story 4.2.2): filter users by `announcement` preference
  - [ ] Exception: if `$announcement->severity === 'Emergency'`, bypass preference check and send to all active users

- [ ] Task 13: Write feature tests (AC: 13)
  - [ ] Create `tests/Feature/NotificationPreferenceTest.php`
  - [ ] Test: user can view profile page with notification preferences
  - [ ] Test: user can update notification preferences
  - [ ] Test: validation rejects non-boolean preference values
  - [ ] Test: `shouldNotify()` returns `true` for enabled type
  - [ ] Test: `shouldNotify()` returns `false` for disabled type
  - [ ] Test: `shouldNotify()` returns `true` when no preferences record exists (defaults)
  - [ ] Test: `NotifyOutOfWorkflowEndorsement` skips user with `out_of_workflow = false`
  - [ ] Test: Emergency announcements bypass `announcement = false` preference
  - [ ] Test: `getNotificationPreferences()` creates default record if none exists
  - [ ] Verify TypeScript compiles with `npx tsc --noEmit`

---

## Dev Notes

### Source Tree -- New Files to Create

```
app/
  Http/
    Controllers/
      NotificationPreferenceController.php          <- NEW
  Models/
    NotificationPreference.php                      <- NEW
database/
  migrations/
    2026_02_18_000200_create_notification_preferences_table.php  <- NEW
resources/js/
  Pages/
    Profile/
      Partials/
        NotificationPreferencesForm.tsx             <- NEW
tests/
  Feature/
    NotificationPreferenceTest.php                  <- NEW
```

### Source Tree -- Existing Files to Modify

```
app/Models/User.php                                          <- add relationship + helper
app/Http/Controllers/ProfileController.php                   <- pass preferences to edit
app/Listeners/NotifyOutOfWorkflowEndorsement.php             <- add preference check
resources/js/Pages/Profile/Edit.tsx                          <- render new form partial
resources/js/types/models.ts                                 <- add NotificationPreference interface
routes/web.php                                               <- add route
```

### Migration Pattern

Follow `database/migrations/2026_02_12_063606_create_notifications_table.php` for migration structure. Follow `database/migrations/2025_10_31_120100_create_transactions_table.php` for `foreignId()->constrained()->cascadeOnDelete()` pattern.

```php
<?php
// database/migrations/2026_02_18_000200_create_notification_preferences_table.php

declare(strict_types=1);

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('notification_preferences', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')
                ->unique()
                ->constrained('users')
                ->cascadeOnDelete();
            $table->boolean('out_of_workflow')->default(true);
            $table->boolean('received')->default(true);
            $table->boolean('overdue')->default(true);
            $table->boolean('completed')->default(true);
            $table->boolean('announcement')->default(true);
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('notification_preferences');
    }
};
```

### NotificationPreference Model

```php
<?php
// app/Models/NotificationPreference.php

declare(strict_types=1);

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class NotificationPreference extends Model
{
    protected $fillable = [
        'user_id',
        'out_of_workflow',
        'received',
        'overdue',
        'completed',
        'announcement',
    ];

    protected function casts(): array
    {
        return [
            'out_of_workflow' => 'boolean',
            'received'        => 'boolean',
            'overdue'         => 'boolean',
            'completed'       => 'boolean',
            'announcement'    => 'boolean',
        ];
    }

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    /**
     * Get default preferences (all enabled).
     *
     * @return array<string, bool>
     */
    public static function getDefaults(): array
    {
        return [
            'out_of_workflow' => true,
            'received'        => true,
            'overdue'         => true,
            'completed'       => true,
            'announcement'    => true,
        ];
    }

    /**
     * Check if a user should receive a notification of the given type.
     * Returns true if user has no preferences record (defaults to all enabled).
     */
    public static function shouldNotify(User $user, string $type): bool
    {
        $preference = $user->notificationPreference;

        if ($preference === null) {
            return true; // No record = all enabled by default
        }

        return (bool) ($preference->{$type} ?? true);
    }
}
```

### User Model Updates

In `app/Models/User.php`, add the following after the existing `procurements()` method (after line 64):

```php
use Illuminate\Database\Eloquent\Relations\HasOne;

// Add relationship
public function notificationPreference(): HasOne
{
    return $this->hasOne(NotificationPreference::class);
}

/**
 * Get or create the user's notification preferences with defaults.
 * Uses firstOrCreate to handle concurrent requests safely.
 */
public function getNotificationPreferences(): NotificationPreference
{
    return NotificationPreference::firstOrCreate(
        ['user_id' => $this->id],
        NotificationPreference::getDefaults()
    );
}
```

The `use HasOne` import should be added alongside the existing `use BelongsTo` import at line 7.

### NotificationPreferenceController

```php
<?php
// app/Http/Controllers/NotificationPreferenceController.php

declare(strict_types=1);

namespace App\Http\Controllers;

use App\Models\NotificationPreference;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;

class NotificationPreferenceController extends Controller
{
    public function update(Request $request): RedirectResponse
    {
        $validated = $request->validate([
            'out_of_workflow' => ['required', 'boolean'],
            'received'        => ['required', 'boolean'],
            'overdue'         => ['required', 'boolean'],
            'completed'       => ['required', 'boolean'],
            'announcement'    => ['required', 'boolean'],
        ]);

        $request->user()->notificationPreference()->updateOrCreate(
            ['user_id' => $request->user()->id],
            $validated
        );

        return back()->with('success', 'Notification preferences updated.');
    }
}
```

### ProfileController Update

In `app/Http/Controllers/ProfileController.php`, modify the `edit()` method (line 20) to include notification preferences:

```php
// BEFORE (current, line 22-26):
return Inertia::render('Profile/Edit', [
    'mustVerifyEmail' => $request->user() instanceof MustVerifyEmail,
    'status' => session('status'),
    'offices' => Office::where('is_active', true)->get(),
]);

// AFTER:
return Inertia::render('Profile/Edit', [
    'mustVerifyEmail' => $request->user() instanceof MustVerifyEmail,
    'status' => session('status'),
    'offices' => Office::where('is_active', true)->get(),
    'notificationPreferences' => $request->user()->getNotificationPreferences(),
]);
```

### Routes Registration

In `routes/web.php`, add inside the existing `Route::middleware('auth')` group (after the notification routes block at line 35, before the procurements resource at line 37):

```php
// Notification Preferences (Story 4.2.3)
Route::patch('/notification-preferences', [\App\Http\Controllers\NotificationPreferenceController::class, 'update'])
    ->name('notification-preferences.update');
```

### Profile/Edit.tsx Update

In `resources/js/Pages/Profile/Edit.tsx`, add the new form section between UpdatePasswordForm and DeleteUserForm:

```tsx
// Add import at top:
import NotificationPreferencesForm from './Partials/NotificationPreferencesForm';
import { NotificationPreference } from '@/types/models';

// Update props type (line 9-13):
export default function Edit({
    mustVerifyEmail,
    status,
    offices,
    notificationPreferences,
}: PageProps<{
    mustVerifyEmail: boolean;
    status?: string;
    offices: Office[];
    notificationPreferences: NotificationPreference;
}>) {

// Add new card section between UpdatePasswordForm and DeleteUserForm (after line 37, before the DeleteUserForm card):
<div className="bg-white p-4 shadow sm:rounded-lg sm:p-8">
    <NotificationPreferencesForm
        preferences={notificationPreferences}
        className="max-w-xl"
    />
</div>
```

### NotificationPreferencesForm Component

Follow the exact pattern of `resources/js/Pages/Profile/Partials/UpdateProfileInformationForm.tsx` (uses `useForm`, `Transition` for success feedback, `FormEventHandler`). Use shadcn/ui `Switch` component from `resources/js/Components/ui/switch.tsx` and `Label` from `resources/js/Components/ui/label.tsx`.

```tsx
// resources/js/Pages/Profile/Partials/NotificationPreferencesForm.tsx
import PrimaryButton from '@/Components/PrimaryButton';
import { Switch } from '@/Components/ui/switch';
import { Label } from '@/Components/ui/label';
import { Transition } from '@headlessui/react';
import { useForm } from '@inertiajs/react';
import { FormEventHandler } from 'react';
import { NotificationPreference } from '@/types/models';

const NOTIFICATION_TYPES = [
    {
        key: 'out_of_workflow' as const,
        label: 'Out of Workflow',
        description: 'When a transaction is sent to an unexpected office',
    },
    {
        key: 'received' as const,
        label: 'Received',
        description: 'When a transaction is received at your office',
    },
    {
        key: 'overdue' as const,
        label: 'Overdue',
        description: 'When your transactions become overdue',
    },
    {
        key: 'completed' as const,
        label: 'Completed',
        description: 'When transactions you created are completed',
    },
    {
        key: 'announcement' as const,
        label: 'Announcements',
        description: 'Administrator announcements and notices',
    },
];

export default function NotificationPreferencesForm({
    preferences,
    className = '',
}: {
    preferences: NotificationPreference;
    className?: string;
}) {
    const { data, setData, patch, processing, recentlySuccessful } = useForm({
        out_of_workflow: preferences.out_of_workflow,
        received: preferences.received,
        overdue: preferences.overdue,
        completed: preferences.completed,
        announcement: preferences.announcement,
    });

    const submit: FormEventHandler = (e) => {
        e.preventDefault();
        patch(route('notification-preferences.update'));
    };

    return (
        <section className={className}>
            <header>
                <h2 className="text-lg font-medium text-gray-900">
                    Notification Preferences
                </h2>
                <p className="mt-1 text-sm text-gray-600">
                    Choose which notification types you want to receive.
                </p>
            </header>

            <form onSubmit={submit} className="mt-6 space-y-6">
                {NOTIFICATION_TYPES.map((type) => (
                    <div key={type.key} className="flex items-center justify-between">
                        <div className="space-y-0.5">
                            <Label htmlFor={type.key}>{type.label}</Label>
                            <p className="text-sm text-muted-foreground">
                                {type.description}
                            </p>
                        </div>
                        <Switch
                            id={type.key}
                            checked={data[type.key]}
                            onCheckedChange={(checked: boolean) =>
                                setData(type.key, checked)
                            }
                        />
                    </div>
                ))}

                <p className="text-xs text-gray-500">
                    Note: Emergency announcements are always delivered regardless of your preference settings.
                </p>

                <div className="flex items-center gap-4">
                    <PrimaryButton disabled={processing}>
                        Save Preferences
                    </PrimaryButton>

                    <Transition
                        show={recentlySuccessful}
                        enter="transition ease-in-out"
                        enterFrom="opacity-0"
                        leave="transition ease-in-out"
                        leaveTo="opacity-0"
                    >
                        <p className="text-sm text-gray-600">Saved.</p>
                    </Transition>
                </div>
            </form>
        </section>
    );
}
```

### TypeScript Types

Add to `resources/js/types/models.ts` (after the existing `Announcement` interface that Story 4.2.2 will add, or at the end of the file):

```ts
export interface NotificationPreference {
    id: number;
    user_id: number;
    out_of_workflow: boolean;
    received: boolean;
    overdue: boolean;
    completed: boolean;
    announcement: boolean;
    created_at: string;
    updated_at: string;
}
```

### Preference Checking in Existing Listener

In `app/Listeners/NotifyOutOfWorkflowEndorsement.php`, update the `handle()` method to filter users by preference before sending. The current listener sends to admins and expected-office users. Add filtering:

```php
use App\Models\NotificationPreference;

// In the handle() method, when collecting target users:
// Filter users who have out_of_workflow notifications enabled
$targetUsers = $targetUsers->filter(
    fn ($user) => NotificationPreference::shouldNotify($user, 'out_of_workflow')
);
```

The same pattern applies to all listeners and the overdue command from Stories 4.2.1 and 4.2.2.

**Important — avoid N+1 queries**: When fetching target users for notification dispatch, eager-load the `notificationPreference` relationship to avoid N+1 queries during filtering. For example:
```php
$admins = User::role('Administrator')->with('notificationPreference')->get();
```

### Preference Checking in Announcement Dispatch (Emergency Bypass)

In `AnnouncementController::store()` (from Story 4.2.2), update the notification dispatch:

```php
use App\Models\NotificationPreference;

// In store(), replace the existing notification dispatch:
if ($announcement->is_active) {
    $users = \App\Models\User::where('is_active', true)->get();

    if ($announcement->severity === 'Emergency') {
        // Emergency bypasses all preferences
        \Illuminate\Support\Facades\Notification::send(
            $users,
            new \App\Notifications\AnnouncementNotification($announcement)
        );
    } else {
        // Respect user preferences for non-emergency announcements
        $filteredUsers = $users->filter(
            fn ($user) => NotificationPreference::shouldNotify($user, 'announcement')
        );
        \Illuminate\Support\Facades\Notification::send(
            $filteredUsers,
            new \App\Notifications\AnnouncementNotification($announcement)
        );
    }
}
```

### Important Notes

- The `notification_preferences` table uses a **one-to-one** relationship with `users` (unique constraint on `user_id`) -- not one-to-many
- `cascadeOnDelete` ensures preferences are removed when a user is deleted
- All preferences default to `true` in both the migration (database default) and the model logic (`getDefaults()`) -- this ensures new users get all notifications without requiring any setup
- The `shouldNotify()` static method handles the case where no record exists (returns `true`), so it is safe to call before a user has ever visited the preferences page
- Laravel 12.x does not require model registration -- the new model is auto-discovered
- Emergency announcements (`severity = 'Emergency'`) always bypass the `announcement` preference (AC: 9). This is a business rule from the epic
- The preference form uses `patch()` method matching the `PATCH` route, consistent with the `UpdateProfileInformationForm.tsx` pattern

### Dependencies

- **Story 3.8** (Done): Notification infrastructure -- notifications table, `NotificationController`, `NotificationBell`, `Notifications/Index` page. Provides the `OutOfWorkflowNotification` and `NotifyOutOfWorkflowEndorsement` listener that this story modifies.
- **Story 4.2.1** (Draft): Additional notification types -- `TransactionReceivedNotification`, `TransactionOverdueNotification`, `TransactionCompletedNotification`, listeners, and overdue command. This story adds preference filtering to those dispatchers. **Must be implemented before this story.**
- **Story 4.2.2** (Draft): Admin announcement system -- `AnnouncementNotification`, `AnnouncementController::store()` dispatch logic. This story adds preference filtering to the announcement dispatch with emergency bypass. **Must be implemented before this story.**

---

### Testing

- **Test file location**: `tests/Feature/NotificationPreferenceTest.php`
- **Testing framework**: PHPUnit with `RefreshDatabase` trait
- **Test pattern**: Follow `tests/Feature/OutOfWorkflowNotificationTest.php` for test structure (setUp with role seeding, factory-based test data, notification assertions)
- **Role seeding**: Use `$this->seed(\Database\Seeders\RoleSeeder::class)` in `setUp()` (same as `OutOfWorkflowNotificationTest.php` line 33)
- **Key assertions**:
  - `$this->actingAs($user)->patch(route('notification-preferences.update'), [...])` for form submission tests
  - `$this->assertDatabaseHas('notification_preferences', ['user_id' => $user->id, 'out_of_workflow' => false])`
  - `Notification::fake()` + `Notification::assertSentTo()` / `Notification::assertNotSentTo()` for preference-respecting dispatch
  - `NotificationPreference::shouldNotify($user, 'out_of_workflow')` direct assertion
  - `$this->withoutVite()->actingAs($user)->get(route('profile.edit'))->assertInertia(fn ($page) => $page->has('notificationPreferences'))` for profile page
- **Inertia assertions**: Use `->assertInertia()` with `$this->withoutVite()` to avoid Vite manifest errors (see `OutOfWorkflowNotificationTest.php` line 323 for pattern)
- **Run tests**: `php artisan test tests/Feature/NotificationPreferenceTest.php`
- **TypeScript verification**: `npx tsc --noEmit` after all frontend changes

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-18 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

---

## QA Results
*(To be filled by QA agent)*
