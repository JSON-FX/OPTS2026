# Story 3.2: Workflow Admin Management UI

**Status**: Draft
**Epic**: Epic 3 - Workflow Engine & Endorsement System
**Story Statement**: As an Administrator, I want to create and manage transaction workflows with ordered office steps and expected completion days, so that I can configure how PR, PO, and VCH transactions route through the organization.

---

## Acceptance Criteria

1. **Workflow List Page**: Admin can access Workflow Management at `/admin/workflows`:
   - Table displays: Name, Category (PR/PO/VCH), Steps Count, Status (Active/Inactive), Created Date
   - Filter by category (dropdown: All, PR, PO, VCH)
   - Filter by status (dropdown: All, Active, Inactive)
   - Search by workflow name
   - Sort by name, category, steps count, created date
   - Pagination if records exceed 20
   - "New Workflow" button visible

2. **Create Workflow Page**: Admin can create new workflow at `/admin/workflows/create`:
   - Form fields:
     - Name (required, max 255 characters)
     - Category (required, dropdown: PR, PO, VCH)
     - Description (optional, textarea)
     - Active (toggle, default: true)
   - Workflow Steps section with dynamic step builder:
     - Add Step button adds new step row
     - Each step row contains: Office (dropdown from offices repository), Expected Days (number input, min 1)
     - Drag-and-drop or up/down arrows to reorder steps
     - Remove button (X) to delete step row
     - Minimum 2 steps required to save workflow
     - Visual indicator for final step (auto-set on last step)
   - Save button creates workflow with all steps atomically
   - Cancel button returns to list with confirmation if unsaved changes
   - Validation prevents duplicate offices within same workflow
   - Success toast on creation, redirect to workflow list

3. **Edit Workflow Page**: Admin can edit workflow at `/admin/workflows/{id}/edit`:
   - Pre-populated form with existing workflow data and steps
   - Same form fields and step builder as create
   - Warning banner if workflow is assigned to active transactions
   - Cannot change category if transactions are using this workflow
   - Can add, remove, reorder steps (with warning about active transactions)
   - Save button updates workflow and steps atomically
   - Success toast on update

4. **View Workflow Page**: Admin can view workflow details at `/admin/workflows/{id}`:
   - Display workflow name, category, description, status
   - Visual step sequence showing:
     - Step number and office name
     - Expected days with visual indicator (progress bar or badge)
     - Total expected days for complete workflow
   - Edit button links to edit page
   - Back button returns to list

5. **Delete/Deactivate Workflow**:
   - Soft delete via "Deactivate" action (sets is_active = false)
   - Cannot deactivate if workflow is the only active workflow for its category
   - Hard delete only if no transactions reference the workflow
   - Confirmation modal before deactivation/deletion
   - Success toast on completion

6. **RBAC Enforcement**:
   - Only Administrator role can access workflow management pages
   - Viewer and Endorser receive 403 Forbidden
   - Navigation menu shows "Workflows" under Admin section only for Administrators

7. **Form Validation**:
   - Server-side validation via Laravel Form Request
   - Client-side validation with inline error messages
   - Prevent submission with duplicate offices in steps
   - Prevent submission with less than 2 steps
   - Prevent submission with expected_days < 1

8. **TypeScript & React Components**:
   - `WorkflowIndex.tsx` - list page with filters and table
   - `WorkflowCreate.tsx` - create form with step builder
   - `WorkflowEdit.tsx` - edit form with step builder
   - `WorkflowShow.tsx` - detail view with step visualization
   - `WorkflowStepBuilder.tsx` - reusable step builder component
   - Props interfaces defined for all components

---

## Dev Notes

### UI/UX Design Reference

**Workflow Step Builder Component:**
```
┌─────────────────────────────────────────────────────────────┐
│ Workflow Steps                                    [+ Add Step] │
├─────────────────────────────────────────────────────────────┤
│ ≡  1. [Budget Office        ▼] Expected Days: [2 ] [X]      │
│ ≡  2. [BAC Office           ▼] Expected Days: [3 ] [X]      │
│ ≡  3. [Accounting Office    ▼] Expected Days: [2 ] [X]      │
│ ≡  4. [Releasing Office     ▼] Expected Days: [1 ] ★ Final  │
└─────────────────────────────────────────────────────────────┘
│ Total: 4 steps, 8 expected days                             │
└─────────────────────────────────────────────────────────────┘
```

- `≡` = drag handle for reordering
- `★ Final` = auto-applied to last step
- `[X]` = remove step button

### Controller & Routes Structure

```php
// routes/web.php
Route::middleware(['auth', 'role:Administrator'])->prefix('admin')->group(function () {
    Route::resource('workflows', WorkflowController::class);
});

// app/Http/Controllers/Admin/WorkflowController.php
class WorkflowController extends Controller
{
    public function index()      // GET /admin/workflows
    public function create()     // GET /admin/workflows/create
    public function store()      // POST /admin/workflows
    public function show($id)    // GET /admin/workflows/{id}
    public function edit($id)    // GET /admin/workflows/{id}/edit
    public function update($id)  // PUT /admin/workflows/{id}
    public function destroy($id) // DELETE /admin/workflows/{id}
}
```

### Form Request Validation

```php
// app/Http/Requests/WorkflowRequest.php
public function rules(): array
{
    return [
        'name' => 'required|string|max:255',
        'category' => 'required|in:PR,PO,VCH',
        'description' => 'nullable|string',
        'is_active' => 'boolean',
        'steps' => 'required|array|min:2',
        'steps.*.office_id' => 'required|exists:offices,id',
        'steps.*.expected_days' => 'required|integer|min:1',
    ];
}

// Custom validation rule for unique offices within steps
public function withValidator($validator)
{
    $validator->after(function ($validator) {
        $officeIds = collect($this->steps)->pluck('office_id');
        if ($officeIds->count() !== $officeIds->unique()->count()) {
            $validator->errors()->add('steps', 'Each office can only appear once in the workflow.');
        }
    });
}
```

### Atomic Step Save Pattern

```php
// In WorkflowService
public function createWithSteps(array $workflowData, array $stepsData): Workflow
{
    return DB::transaction(function () use ($workflowData, $stepsData) {
        $workflow = Workflow::create($workflowData);

        foreach ($stepsData as $index => $stepData) {
            $workflow->steps()->create([
                'office_id' => $stepData['office_id'],
                'expected_days' => $stepData['expected_days'],
                'step_order' => $index + 1,
                'is_final_step' => $index === count($stepsData) - 1,
            ]);
        }

        return $workflow->load('steps.office');
    });
}
```

### Reference Files

- Workflow model: Story 3.1
- Office repository: Story 1.4
- Admin layout pattern: `resources/js/Layouts/AuthenticatedLayout.tsx`
- Table component pattern: `resources/js/Components/ui/table.tsx` (Shadcn)
- Form patterns: Existing admin pages from Epic 1

### Story Dependencies

**Depends on**:
- Story 3.1 (Workflow Schema & Model Foundation)
- Story 1.4 (Office Repository Management) - for office dropdown data
- Story 1.7 (Navigation, Layout & Access Control) - for admin layout

**Blocks**:
- Story 3.11 (Workflow Assignment) - needs workflows to exist

---

## Tasks

### Task 1: Create Workflow Controller
**Estimate**: 45 minutes
- Create `app/Http/Controllers/Admin/WorkflowController.php`
- Implement all 7 resource methods (index, create, store, show, edit, update, destroy)
- Use Inertia::render for all view methods
- Inject WorkflowService for business logic
- Add proper authorization checks

**Verification**: Routes respond correctly via browser/curl

### Task 2: Create Form Request Classes
**Estimate**: 30 minutes
- Create `app/Http/Requests/StoreWorkflowRequest.php`
- Create `app/Http/Requests/UpdateWorkflowRequest.php`
- Implement validation rules per AC#7
- Add custom validation for unique offices in steps
- Add category change prevention on update if transactions exist

**Verification**: Invalid form submissions return proper error messages

### Task 3: Create Workflow Service
**Estimate**: 45 minutes
- Create `app/Services/WorkflowService.php`
- Implement `createWithSteps()` method with transaction
- Implement `updateWithSteps()` method with transaction
- Implement `canDeactivate()` check
- Implement `canDelete()` check
- Register in AppServiceProvider

**Verification**: Service methods work correctly in tinker

### Task 4: Create WorkflowIndex Page Component
**Estimate**: 1 hour
- Create `resources/js/Pages/Admin/Workflows/Index.tsx`
- Implement data table with Shadcn Table component
- Add filter dropdowns (category, status)
- Add search input
- Add sorting on columns
- Add pagination
- Add "New Workflow" button
- Define TypeScript props interface

**Verification**: Page renders with workflow data, filters work

### Task 5: Create WorkflowStepBuilder Component
**Estimate**: 1.5 hours
- Create `resources/js/Components/WorkflowStepBuilder.tsx`
- Implement dynamic step rows with add/remove
- Implement office dropdown (populated from props)
- Implement expected_days number input
- Implement drag-and-drop reordering (using @dnd-kit or similar)
- Auto-calculate final step indicator
- Show total steps and total expected days
- Define TypeScript props interface

**Verification**: Component allows adding, removing, reordering steps

### Task 6: Create WorkflowCreate Page Component
**Estimate**: 45 minutes
- Create `resources/js/Pages/Admin/Workflows/Create.tsx`
- Implement form with name, category, description, active fields
- Integrate WorkflowStepBuilder component
- Implement form submission with Inertia.post
- Handle validation errors inline
- Add cancel button with unsaved changes confirmation
- Define TypeScript props interface

**Verification**: Can create new workflow with steps

### Task 7: Create WorkflowEdit Page Component
**Estimate**: 45 minutes
- Create `resources/js/Pages/Admin/Workflows/Edit.tsx`
- Pre-populate form with existing data
- Integrate WorkflowStepBuilder with existing steps
- Show warning if active transactions exist
- Disable category field if transactions exist
- Implement form submission with Inertia.put
- Define TypeScript props interface

**Verification**: Can edit existing workflow and steps

### Task 8: Create WorkflowShow Page Component
**Estimate**: 30 minutes
- Create `resources/js/Pages/Admin/Workflows/Show.tsx`
- Display workflow details in card layout
- Visualize steps as ordered list with expected days
- Show total expected days calculation
- Add Edit and Back buttons
- Define TypeScript props interface

**Verification**: Page displays workflow details correctly

### Task 9: Add Routes and Navigation
**Estimate**: 20 minutes
- Add workflow resource routes in `routes/web.php`
- Add "Workflows" link to admin navigation menu
- Ensure proper middleware (auth, role:Administrator)
- Update navigation component for admin section

**Verification**: Routes accessible, navigation works

### Task 10: Write Feature Tests
**Estimate**: 1.5 hours
- Create `tests/Feature/Admin/WorkflowManagementTest.php`:
  - Test index page loads with workflows
  - Test filtering by category and status
  - Test create workflow with steps
  - Test validation errors (empty name, < 2 steps, duplicate offices)
  - Test edit workflow
  - Test category change prevention with active transactions
  - Test deactivate workflow
  - Test delete workflow (without transactions)
  - Test RBAC (Viewer/Endorser get 403)

**Verification**:
```bash
php artisan test --filter=WorkflowManagement
```

### Task 11: Write Component Tests
**Estimate**: 45 minutes
- Create `resources/js/Pages/Admin/Workflows/__tests__/` directory
- Test WorkflowStepBuilder add/remove/reorder functionality
- Test form validation display
- Use React Testing Library with Vitest

**Verification**:
```bash
npm run test
```

---

## Acceptance Checklist

- [ ] Workflow list page displays all workflows with proper columns
- [ ] Filters work for category and status
- [ ] Search works for workflow name
- [ ] Sorting works on all columns
- [ ] Pagination works when records exceed 20
- [ ] Create workflow form validates all fields
- [ ] Step builder allows add, remove, reorder steps
- [ ] Duplicate office validation prevents submission
- [ ] Minimum 2 steps validation works
- [ ] Edit workflow pre-populates all data correctly
- [ ] Category change prevented when transactions exist
- [ ] View page displays workflow with step visualization
- [ ] Deactivate works with proper warnings
- [ ] Delete works only when no transactions reference workflow
- [ ] RBAC enforced (403 for non-Administrators)
- [ ] All feature tests pass
- [ ] All component tests pass
- [ ] TypeScript compilation succeeds

**Definition of Done**: Administrators can fully manage workflows (create, view, edit, deactivate, delete) with the step builder UI, all validation rules enforced, and proper RBAC protection.

---

## Dev Agent Record

**Story**: 3.2 - Workflow Admin Management UI
**Status**: Draft
**Assigned**:
**Start Date**:
**Completion Date**:

### Files Created
- [ ] `app/Http/Controllers/Admin/WorkflowController.php`
- [ ] `app/Http/Requests/StoreWorkflowRequest.php`
- [ ] `app/Http/Requests/UpdateWorkflowRequest.php`
- [ ] `app/Services/WorkflowService.php`
- [ ] `resources/js/Pages/Admin/Workflows/Index.tsx`
- [ ] `resources/js/Pages/Admin/Workflows/Create.tsx`
- [ ] `resources/js/Pages/Admin/Workflows/Edit.tsx`
- [ ] `resources/js/Pages/Admin/Workflows/Show.tsx`
- [ ] `resources/js/Components/WorkflowStepBuilder.tsx`
- [ ] `tests/Feature/Admin/WorkflowManagementTest.php`

### Files Modified
- [ ] `routes/web.php`
- [ ] `resources/js/Layouts/AuthenticatedLayout.tsx` (navigation)
- [ ] `app/Providers/AppServiceProvider.php` (service registration)

### Test Results
- [ ] Feature tests: X passing
- [ ] Component tests: X passing
- [ ] All project tests: X passing

### Implementation Notes
*(To be filled by dev agent)*

### Time Log
*(To be filled by dev agent)*

---

## QA Results

**Gate**:
**Quality Score**:
**Reviewer**:
**Review Date**:

### Evidence
*(To be filled by QA)*

### Issues Identified
*(To be filled by QA)*

### Recommendations
*(To be filled by QA)*
