# Story 4.2.1: Additional Notification Types (Received, Overdue, Completion)

**Status**: done
**Epic**: Epic 4.2 - Notification System Expansion
**Story Statement**: As a user, I want to receive notifications when transactions are received at my office, when my transactions become overdue, and when transactions I'm tracking are completed, so that I can take timely action on items requiring my attention.

---

## Acceptance Criteria

1. **TransactionReceivedNotification**: When a transaction is received at an office (via `EndorsementService::receive()`):
   - All users assigned to the receiving office (`office_id = to_office_id`) receive a notification
   - Notification data includes: `type: 'received'`, `transaction_id`, `reference_number`, `category`, `from_office_name`, `to_office_name`, `received_by_name`, `message`
   - Message format: `"Transaction {reference_number} has been received at {to_office_name}"`

2. **TransactionOverdueNotification**: A scheduled command detects overdue transactions and notifies:
   - Current holder user (the `current_user_id` on the transaction) receives a notification
   - All Administrators receive a notification
   - Notification data includes: `type: 'overdue'`, `transaction_id`, `reference_number`, `category`, `current_office_name`, `delay_days`, `message`
   - Message format: `"Transaction {reference_number} is overdue by {delay_days} business day(s) at {current_office_name}"`
   - Command: `php artisan opts:check-overdue`
   - Idempotent: uses a `last_overdue_notified_at` column on `transactions` to track last notification — won't re-notify within 24 hours
   - Only notifies for transactions in "In Progress" status with `delay_days > 0` (from `EtaCalculationService`)

3. **TransactionCompletedNotification**: When a transaction is completed (via `EndorsementService::complete()`):
   - The transaction creator (`created_by_user_id`) receives a notification
   - Notification data includes: `type: 'completed'`, `transaction_id`, `reference_number`, `category`, `completed_by_name`, `message`
   - Message format: `"Transaction {reference_number} ({category}) has been completed"`

4. **NotificationBell Updates**: The `NotificationBell.tsx` component renders new types with appropriate icons:
   - `received` → blue `Inbox` icon
   - `overdue` → red `Clock` icon
   - `completed` → green `CheckCircle` icon
   - Existing `out_of_workflow` → amber `AlertTriangle` icon (unchanged)

5. **Notifications Index Updates**: The `Notifications/Index.tsx` page type filter dropdown includes:
   - All Types (existing)
   - Out of Workflow (existing)
   - Received (new)
   - Overdue (new)
   - Completed (new)
   - Type badge styling per notification type in the list

6. **Event-Driven Architecture**: Follow the existing event→listener→notification pattern:
   - `TransactionReceived` event dispatched from `EndorsementService::receive()`
   - `TransactionCompleted` event dispatched from `EndorsementService::complete()`
   - Corresponding listeners handle notification dispatch
   - Overdue uses a scheduled command instead of events (batch processing)

7. **Migration**: Add `last_overdue_notified_at` (nullable timestamp) column to `transactions` table for idempotent overdue checking

8. **Testing**:
   - Unit test for each notification class (`toArray` output)
   - Feature test for `TransactionReceived` event dispatch + listener notification delivery
   - Feature test for `TransactionCompleted` event dispatch + listener notification delivery
   - Feature test for `opts:check-overdue` command: finds overdue, sends notifications, respects idempotency
   - Feature test for NotificationBell rendering with new types in shared props
   - Feature test for Notifications Index type filter with new types

---

## Tasks / Subtasks

- [x] Task 1: Add `last_overdue_notified_at` migration (AC: 7)
  - [x] Create migration adding nullable `last_overdue_notified_at` timestamp to `transactions` table
  - [x] Add column to `$fillable` and `$casts` on Transaction model

- [x] Task 2: Create TransactionReceivedNotification class (AC: 1)
  - [x] Create `app/Notifications/TransactionReceivedNotification.php`
  - [x] Follow `OutOfWorkflowNotification` pattern: database channel, `toArray()` with type/message/data
  - [x] Constructor receives `TransactionAction $action`
  - [x] Unit test: verify `toArray` returns correct structure

- [x] Task 3: Create TransactionReceived event + listener (AC: 1, 6)
  - [x] Create `app/Events/TransactionReceived.php` (carries `TransactionAction`)
  - [x] Create `app/Listeners/NotifyTransactionReceived.php`
  - [x] Listener sends `TransactionReceivedNotification` to all users in the receiving office
  - [x] Dispatch event from `EndorsementService::receive()` after successful receive
  - [x] Feature test: verify event fires and notifications sent to correct users

- [x] Task 4: Create TransactionCompletedNotification class (AC: 3)
  - [x] Create `app/Notifications/TransactionCompletedNotification.php`
  - [x] Constructor receives `Transaction $transaction` and `User $completedBy`
  - [x] Unit test: verify `toArray` returns correct structure

- [x] Task 5: Create TransactionCompleted event + listener (AC: 3, 6)
  - [x] Create `app/Events/TransactionCompleted.php` (carries `Transaction` and `User`)
  - [x] Create `app/Listeners/NotifyTransactionCompleted.php`
  - [x] Listener sends `TransactionCompletedNotification` to `created_by_user_id`
  - [x] Dispatch event from `EndorsementService::complete()` after successful completion
  - [x] Feature test: verify event fires and notification sent to creator

- [x] Task 6: Create TransactionOverdueNotification class (AC: 2)
  - [x] Create `app/Notifications/TransactionOverdueNotification.php`
  - [x] Constructor receives `Transaction $transaction`, `int $delayDays`
  - [x] Unit test: verify `toArray` returns correct structure

- [x] Task 7: Create `opts:check-overdue` Artisan command (AC: 2)
  - [x] Create `app/Console/Commands/CheckOverdueTransactions.php`
  - [x] Query transactions: status = "In Progress", has `current_step_id`, `last_overdue_notified_at` is null or > 24h ago — eager-load `currentStep` and `workflow.steps` to avoid N+1
  - [x] Use `EtaCalculationService::getDelayDays()` to detect overdue (requires `currentStep` loaded)
  - [x] Send `TransactionOverdueNotification` to current holder + all Administrators
  - [x] Update `last_overdue_notified_at` after successful notification
  - [x] Register in scheduler: add `->withSchedule(function (\Illuminate\Console\Scheduling\Schedule $schedule) { $schedule->command('opts:check-overdue')->dailyAt('08:00'); })` to `bootstrap/app.php` (before `->create()`)
  - [x] Feature test: command sends notifications for overdue, skips recently notified, skips non-overdue

- [x] Task 8: Update NotificationBell with new icons (AC: 4)
  - [x] Add icon cases for `received`, `overdue`, `completed` in `getNotificationIcon()` in `NotificationBell.tsx`
  - [x] Import `Inbox`, `Clock`, `CheckCircle` from lucide-react

- [x] Task 9: Update Notifications Index page (AC: 5)
  - [x] Add `received`, `overdue`, `completed` to type filter `<SelectContent>` in `Notifications/Index.tsx`
  - [x] Add type badge styling for each new notification type in the notification list
  - [x] Update `getNotificationIcon()` in Index page to match NotificationBell

- [x] Task 10: Write comprehensive feature tests (AC: 8)
  - [x] Test TransactionReceived event fires from `EndorsementService::receive()`
  - [x] Test TransactionCompleted event fires from `EndorsementService::complete()`
  - [x] Test overdue command idempotency (no duplicate notifications)
  - [x] Test overdue command skips non-overdue transactions
  - [x] Test notification type filter on Index page works for new types
  - [x] Test shared props include new notification types in bell count

---

## Dev Notes

### Existing Source Files to Modify

- **EndorsementService**: `app/Services/EndorsementService.php` — dispatch events from `receive()` (function at line 186, add dispatch before `return $action` at line 225) and `complete()` (function at line 364, add dispatch before `return $action` at line 393)
- **Transaction model**: `app/Models/Transaction.php` — add `last_overdue_notified_at` to `$fillable` and `$casts`
- **NotificationBell**: `resources/js/Components/NotificationBell.tsx` — add icon cases to `getNotificationIcon()` (line 12-18)
- **Notifications Index**: `resources/js/Pages/Notifications/Index.tsx` — add SelectItems (line 143-146) and badge styling (line 233-236)

### Existing Source Files to Reference (Pattern Examples)

- **OutOfWorkflowNotification**: `app/Notifications/OutOfWorkflowNotification.php` — follow this exact pattern for new notification classes (database channel, `toArray()` returning `type`, `message`, and entity data)
- **OutOfWorkflowEndorsement event**: `app/Events/OutOfWorkflowEndorsement.php` — follow this pattern for new events (constructor with model, `Dispatchable` + `SerializesModels`)
- **NotifyOutOfWorkflowEndorsement listener**: `app/Listeners/NotifyOutOfWorkflowEndorsement.php` — follow this pattern for new listeners (use `Notification::send()` to target user groups)
- **HandleInertiaRequests**: `app/Http/Middleware/HandleInertiaRequests.php` — shared props already include notification data (no changes needed, new types flow through existing infrastructure)
- **EtaCalculationService**: `app/Services/EtaCalculationService.php` — `getDelayDays()` and `isStagnant()` for overdue detection
- **NotificationController**: `app/Http/Controllers/NotificationController.php` — no changes needed, `data->type` filter already works generically
- **Existing test**: `tests/Feature/OutOfWorkflowNotificationTest.php` — follow test patterns for new notification tests

### Event Dispatch Points

In `EndorsementService::receive()` — after the DB transaction succeeds, add:
```php
// Fire received event for notification (Story 4.2.1)
$action->load(['transaction', 'fromOffice', 'toOffice']);
event(new TransactionReceived($action));
```

In `EndorsementService::complete()` — after the DB transaction succeeds, add:
```php
// Fire completed event for notification (Story 4.2.1)
event(new TransactionCompleted($transaction->fresh(), $user));
```

### Overdue Command Design

```php
// Command signature: opts:check-overdue
// 1. Get all "In Progress" transactions with currentStep loaded
// 2. For each: check EtaCalculationService::getDelayDays() > 0
// 3. If overdue AND (last_overdue_notified_at is null OR > 24h ago):
//    - Send TransactionOverdueNotification to current_user + admins
//    - Update last_overdue_notified_at = now()
// 4. Log count of notifications sent
```

### Important Notes

- Laravel 12.x uses event auto-discovery — no EventServiceProvider registration needed
- All notification types use `database` channel only (no email in this story)
- The `HandleInertiaRequests` middleware already shares notification data generically — new types will automatically appear in the bell and be counted correctly
- The `NotificationController::index()` type filter already uses generic `data->type` matching — new types will automatically be filterable

### Dependencies

- **Story 3.8** (Done): Notification infrastructure — notifications table, NotificationController, NotificationBell, Notifications Index page
- **Story 3.5** (Done): Receive action — `EndorsementService::receive()`
- **Story 3.6** (Done): Complete action — `EndorsementService::complete()`
- **Story 3.9** (Done): ETA calculations — `EtaCalculationService::getDelayDays()`

### Testing

- **Test location**: `tests/Feature/` — one file per notification type or grouped as `NotificationTypesTest.php` (notification `toArray` tests also go in Feature tests, following the existing `OutOfWorkflowNotificationTest.php` pattern)
- **Testing framework**: PHPUnit with `RefreshDatabase` trait
- **Test patterns**: Follow `tests/Feature/OutOfWorkflowNotificationTest.php` patterns
- **Key assertions**: `Notification::assertSentTo()`, `Event::assertDispatched()`, `$this->artisan('opts:check-overdue')->assertSuccessful()`
- **TypeScript**: Run `npx tsc --noEmit` to verify frontend compiles

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-18 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-02-20 | 1.1 | Implementation complete — all 10 tasks done | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### Debug Log References
No debug issues encountered.

### Completion Notes List
- All 10 tasks completed and tested
- 15 feature tests pass (43 assertions)
- Existing OutOfWorkflowNotification tests unaffected (15 pass, 52 assertions)
- TypeScript compiles clean (`npx tsc --noEmit`)
- PHP formatted with Pint
- 29 pre-existing test failures in unrelated test files (ProcurementBusinessRules, Dashboard, PurchaseRequest/Order controllers) — confirmed on main branch before changes

### File List
**New Files:**
- `database/migrations/2026_02_19_181126_add_last_overdue_notified_at_to_transactions_table.php` — Migration
- `app/Notifications/TransactionReceivedNotification.php` — Received notification class
- `app/Notifications/TransactionCompletedNotification.php` — Completed notification class
- `app/Notifications/TransactionOverdueNotification.php` — Overdue notification class
- `app/Events/TransactionReceived.php` — Received event
- `app/Events/TransactionCompleted.php` — Completed event
- `app/Listeners/NotifyTransactionReceived.php` — Received listener
- `app/Listeners/NotifyTransactionCompleted.php` — Completed listener
- `app/Console/Commands/CheckOverdueTransactions.php` — Overdue check command
- `tests/Feature/AdditionalNotificationTypesTest.php` — 15 feature tests

**Modified Files:**
- `app/Models/Transaction.php` — Added `last_overdue_notified_at` to `$fillable` and `$casts`
- `app/Services/EndorsementService.php` — Dispatch `TransactionReceived` and `TransactionCompleted` events
- `bootstrap/app.php` — Registered `opts:check-overdue` scheduler (daily at 08:00)
- `resources/js/Components/NotificationBell.tsx` — Added icons for received/overdue/completed types
- `resources/js/Pages/Notifications/Index.tsx` — Added type filter options and badge styling

---

## QA Results

### Review Date: 2026-02-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** — Clean, well-structured implementation that follows established patterns consistently. All 10 tasks implemented correctly with 15 tests (43 assertions). The event-driven architecture (Events → Listeners → Notifications) follows the existing OutOfWorkflowNotification pattern precisely, ensuring maintainability and consistency across the notification system.

**Strengths:**
- Consistent use of `declare(strict_types=1)` and proper PHPDoc annotations across all new files
- Event dispatch placed correctly *outside* DB transactions (preventing notification loss on transaction failure while ensuring data consistency)
- Overdue command is well-designed with idempotent 24h window, eager-loading to avoid N+1, and recipient deduplication
- Frontend implementation uses proper switch/case patterns with appropriate icon colors and badge styling
- Generic `NotificationController` type filter (`data->type`) and `HandleInertiaRequests` shared props automatically support new types without modification — good architectural foresight from the foundation

**Minor Observations (non-blocking):**
- `NotifyTransactionReceived` listener queries `User::where('office_id', ...)` which could include inactive users if the system ever soft-deletes or deactivates users. Currently not an issue since no user deactivation mechanism exists.
- `getTransactionRoute()` in `NotificationBell.tsx` always returns `null` — this is existing code, not introduced by this story, so it's not a concern for this review.

### Refactoring Performed

None required — implementation quality is high and follows established patterns.

### Compliance Check

- Coding Standards: ✓ Pint-formatted, strict types, proper PHPDoc
- Project Structure: ✓ Files placed in correct directories following established conventions
- Testing Strategy: ✓ 15 feature tests covering all notification classes, event dispatch, listener delivery, command idempotency, and UI integration
- All ACs Met: ✓ All 8 acceptance criteria verified (see traceability below)

### AC Traceability

| AC | Description | Test Coverage |
|----|-------------|---------------|
| AC1 | TransactionReceivedNotification | `test_transaction_received_notification_to_array`, `test_transaction_received_listener_sends_notifications` |
| AC2 | TransactionOverdueNotification + command | `test_transaction_overdue_notification_to_array`, `test_check_overdue_command_*` (4 tests) |
| AC3 | TransactionCompletedNotification | `test_transaction_completed_notification_to_array`, `test_transaction_completed_listener_sends_notification_to_creator` |
| AC4 | NotificationBell icons | `test_new_notification_types_appear_in_bell_count` + E2E verified |
| AC5 | Notifications Index filters/badges | `test_notifications_index_filters_by_*_type` (3 tests) + E2E verified |
| AC6 | Event-driven architecture | `test_transaction_received_event_fires_on_receive`, `test_transaction_completed_event_fires_on_complete` |
| AC7 | Migration | Verified: `last_overdue_notified_at` nullable timestamp added, model updated |
| AC8 | Testing | 15 feature tests, 43 assertions — all pass |

### E2E Testing Results (Playwright MCP against opts2026.test)

| Scenario | Result |
|----------|--------|
| Login as admin, dashboard loads | PASS |
| Notification bell shows count "3" with seeded notifications | PASS |
| Bell popover shows all 3 types with correct colored icons (Inbox blue, CheckCircle green, Clock red) | PASS |
| Bell popover shows correct message text for each type | PASS |
| Notifications Index page renders type badges (Received blue, Completed green, Overdue red) | PASS |
| Notifications Index page renders type-specific colored icons | PASS |
| Type filter dropdown shows all 5 options (All, Out of Workflow, Received, Overdue, Completed) | PASS |
| Filter by "Received" shows only received notification | PASS |
| Filter by "Overdue" shows only overdue notification | PASS |
| Filter by "Completed" shows only completed notification | PASS |
| "View all notifications" link from bell navigates to Index | PASS |

### Improvements Checklist

All items handled — no changes required:

- [x] Event dispatch correctly placed outside DB::transaction closures
- [x] Overdue command has idempotent 24h window check
- [x] Overdue command deduplicates recipients (current_user may also be admin)
- [x] Overdue command eager-loads relationships to prevent N+1
- [x] Migration has proper `down()` method for rollback
- [x] Frontend icons use correct colors per AC4 specification
- [x] Frontend type badges use correct color schemes per type
- [x] Type filter dropdown includes all new types per AC5

### Security Review

No security concerns. All notification dispatch uses server-side event/listener pattern — no user input flows directly into notification content. The overdue command runs server-side via scheduler with no external input surface. NotificationController already validates user ownership of notifications.

### Performance Considerations

No performance concerns for current scale. The overdue command queries with `whereNotNull('current_step_id')` and eager-loads relationships. For very large transaction volumes (10k+), consider:
- Adding a database index on `(status, current_step_id, last_overdue_notified_at)` for the overdue query
- Batching `Notification::send()` calls if recipient lists grow large

These are future optimization notes, not blocking issues.

### Files Modified During Review

No files modified during QA review.

### Gate Status

Gate: PASS → docs/qa/gates/4.2.1-additional-notification-types.yml

### Recommended Status

✓ Ready for Done
