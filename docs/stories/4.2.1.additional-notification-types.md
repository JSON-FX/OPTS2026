# Story 4.2.1: Additional Notification Types (Received, Overdue, Completion)

**Status**: Draft
**Epic**: Epic 4.2 - Notification System Expansion
**Story Statement**: As a user, I want to receive notifications when transactions are received at my office, when my transactions become overdue, and when transactions I'm tracking are completed, so that I can take timely action on items requiring my attention.

---

## Acceptance Criteria

1. **TransactionReceivedNotification**: When a transaction is received at an office (via `EndorsementService::receive()`):
   - All users assigned to the receiving office (`office_id = to_office_id`) receive a notification
   - Notification data includes: `type: 'received'`, `transaction_id`, `reference_number`, `category`, `from_office_name`, `to_office_name`, `received_by_name`, `message`
   - Message format: `"Transaction {reference_number} has been received at {to_office_name}"`

2. **TransactionOverdueNotification**: A scheduled command detects overdue transactions and notifies:
   - Current holder user (the `current_user_id` on the transaction) receives a notification
   - All Administrators receive a notification
   - Notification data includes: `type: 'overdue'`, `transaction_id`, `reference_number`, `category`, `current_office_name`, `delay_days`, `message`
   - Message format: `"Transaction {reference_number} is overdue by {delay_days} business day(s) at {current_office_name}"`
   - Command: `php artisan opts:check-overdue`
   - Idempotent: uses a `last_overdue_notified_at` column on `transactions` to track last notification — won't re-notify within 24 hours
   - Only notifies for transactions in "In Progress" status with `delay_days > 0` (from `EtaCalculationService`)

3. **TransactionCompletedNotification**: When a transaction is completed (via `EndorsementService::complete()`):
   - The transaction creator (`created_by_user_id`) receives a notification
   - Notification data includes: `type: 'completed'`, `transaction_id`, `reference_number`, `category`, `completed_by_name`, `message`
   - Message format: `"Transaction {reference_number} ({category}) has been completed"`

4. **NotificationBell Updates**: The `NotificationBell.tsx` component renders new types with appropriate icons:
   - `received` → blue `Inbox` icon
   - `overdue` → red `Clock` icon
   - `completed` → green `CheckCircle` icon
   - Existing `out_of_workflow` → amber `AlertTriangle` icon (unchanged)

5. **Notifications Index Updates**: The `Notifications/Index.tsx` page type filter dropdown includes:
   - All Types (existing)
   - Out of Workflow (existing)
   - Received (new)
   - Overdue (new)
   - Completed (new)
   - Type badge styling per notification type in the list

6. **Event-Driven Architecture**: Follow the existing event→listener→notification pattern:
   - `TransactionReceived` event dispatched from `EndorsementService::receive()`
   - `TransactionCompleted` event dispatched from `EndorsementService::complete()`
   - Corresponding listeners handle notification dispatch
   - Overdue uses a scheduled command instead of events (batch processing)

7. **Migration**: Add `last_overdue_notified_at` (nullable timestamp) column to `transactions` table for idempotent overdue checking

8. **Testing**:
   - Unit test for each notification class (`toArray` output)
   - Feature test for `TransactionReceived` event dispatch + listener notification delivery
   - Feature test for `TransactionCompleted` event dispatch + listener notification delivery
   - Feature test for `opts:check-overdue` command: finds overdue, sends notifications, respects idempotency
   - Feature test for NotificationBell rendering with new types in shared props
   - Feature test for Notifications Index type filter with new types

---

## Tasks / Subtasks

- [ ] Task 1: Add `last_overdue_notified_at` migration (AC: 7)
  - [ ] Create migration adding nullable `last_overdue_notified_at` timestamp to `transactions` table
  - [ ] Add column to `$fillable` and `$casts` on Transaction model

- [ ] Task 2: Create TransactionReceivedNotification class (AC: 1)
  - [ ] Create `app/Notifications/TransactionReceivedNotification.php`
  - [ ] Follow `OutOfWorkflowNotification` pattern: database channel, `toArray()` with type/message/data
  - [ ] Constructor receives `TransactionAction $action`
  - [ ] Unit test: verify `toArray` returns correct structure

- [ ] Task 3: Create TransactionReceived event + listener (AC: 1, 6)
  - [ ] Create `app/Events/TransactionReceived.php` (carries `TransactionAction`)
  - [ ] Create `app/Listeners/NotifyTransactionReceived.php`
  - [ ] Listener sends `TransactionReceivedNotification` to all users in the receiving office
  - [ ] Dispatch event from `EndorsementService::receive()` after successful receive
  - [ ] Feature test: verify event fires and notifications sent to correct users

- [ ] Task 4: Create TransactionCompletedNotification class (AC: 3)
  - [ ] Create `app/Notifications/TransactionCompletedNotification.php`
  - [ ] Constructor receives `Transaction $transaction` and `User $completedBy`
  - [ ] Unit test: verify `toArray` returns correct structure

- [ ] Task 5: Create TransactionCompleted event + listener (AC: 3, 6)
  - [ ] Create `app/Events/TransactionCompleted.php` (carries `Transaction` and `User`)
  - [ ] Create `app/Listeners/NotifyTransactionCompleted.php`
  - [ ] Listener sends `TransactionCompletedNotification` to `created_by_user_id`
  - [ ] Dispatch event from `EndorsementService::complete()` after successful completion
  - [ ] Feature test: verify event fires and notification sent to creator

- [ ] Task 6: Create TransactionOverdueNotification class (AC: 2)
  - [ ] Create `app/Notifications/TransactionOverdueNotification.php`
  - [ ] Constructor receives `Transaction $transaction`, `int $delayDays`
  - [ ] Unit test: verify `toArray` returns correct structure

- [ ] Task 7: Create `opts:check-overdue` Artisan command (AC: 2)
  - [ ] Create `app/Console/Commands/CheckOverdueTransactions.php`
  - [ ] Query transactions: status = "In Progress", has `current_step_id`, `last_overdue_notified_at` is null or > 24h ago — eager-load `currentStep` and `workflow.steps` to avoid N+1
  - [ ] Use `EtaCalculationService::getDelayDays()` to detect overdue (requires `currentStep` loaded)
  - [ ] Send `TransactionOverdueNotification` to current holder + all Administrators
  - [ ] Update `last_overdue_notified_at` after successful notification
  - [ ] Register in scheduler: add `->withSchedule(function (\Illuminate\Console\Scheduling\Schedule $schedule) { $schedule->command('opts:check-overdue')->dailyAt('08:00'); })` to `bootstrap/app.php` (before `->create()`)
  - [ ] Feature test: command sends notifications for overdue, skips recently notified, skips non-overdue

- [ ] Task 8: Update NotificationBell with new icons (AC: 4)
  - [ ] Add icon cases for `received`, `overdue`, `completed` in `getNotificationIcon()` in `NotificationBell.tsx`
  - [ ] Import `Inbox`, `Clock`, `CheckCircle` from lucide-react

- [ ] Task 9: Update Notifications Index page (AC: 5)
  - [ ] Add `received`, `overdue`, `completed` to type filter `<SelectContent>` in `Notifications/Index.tsx`
  - [ ] Add type badge styling for each new notification type in the notification list
  - [ ] Update `getNotificationIcon()` in Index page to match NotificationBell

- [ ] Task 10: Write comprehensive feature tests (AC: 8)
  - [ ] Test TransactionReceived event fires from `EndorsementService::receive()`
  - [ ] Test TransactionCompleted event fires from `EndorsementService::complete()`
  - [ ] Test overdue command idempotency (no duplicate notifications)
  - [ ] Test overdue command skips non-overdue transactions
  - [ ] Test notification type filter on Index page works for new types
  - [ ] Test shared props include new notification types in bell count

---

## Dev Notes

### Existing Source Files to Modify

- **EndorsementService**: `app/Services/EndorsementService.php` — dispatch events from `receive()` (function at line 186, add dispatch before `return $action` at line 225) and `complete()` (function at line 364, add dispatch before `return $action` at line 393)
- **Transaction model**: `app/Models/Transaction.php` — add `last_overdue_notified_at` to `$fillable` and `$casts`
- **NotificationBell**: `resources/js/Components/NotificationBell.tsx` — add icon cases to `getNotificationIcon()` (line 12-18)
- **Notifications Index**: `resources/js/Pages/Notifications/Index.tsx` — add SelectItems (line 143-146) and badge styling (line 233-236)

### Existing Source Files to Reference (Pattern Examples)

- **OutOfWorkflowNotification**: `app/Notifications/OutOfWorkflowNotification.php` — follow this exact pattern for new notification classes (database channel, `toArray()` returning `type`, `message`, and entity data)
- **OutOfWorkflowEndorsement event**: `app/Events/OutOfWorkflowEndorsement.php` — follow this pattern for new events (constructor with model, `Dispatchable` + `SerializesModels`)
- **NotifyOutOfWorkflowEndorsement listener**: `app/Listeners/NotifyOutOfWorkflowEndorsement.php` — follow this pattern for new listeners (use `Notification::send()` to target user groups)
- **HandleInertiaRequests**: `app/Http/Middleware/HandleInertiaRequests.php` — shared props already include notification data (no changes needed, new types flow through existing infrastructure)
- **EtaCalculationService**: `app/Services/EtaCalculationService.php` — `getDelayDays()` and `isStagnant()` for overdue detection
- **NotificationController**: `app/Http/Controllers/NotificationController.php` — no changes needed, `data->type` filter already works generically
- **Existing test**: `tests/Feature/OutOfWorkflowNotificationTest.php` — follow test patterns for new notification tests

### Event Dispatch Points

In `EndorsementService::receive()` — after the DB transaction succeeds, add:
```php
// Fire received event for notification (Story 4.2.1)
$action->load(['transaction', 'fromOffice', 'toOffice']);
event(new TransactionReceived($action));
```

In `EndorsementService::complete()` — after the DB transaction succeeds, add:
```php
// Fire completed event for notification (Story 4.2.1)
event(new TransactionCompleted($transaction->fresh(), $user));
```

### Overdue Command Design

```php
// Command signature: opts:check-overdue
// 1. Get all "In Progress" transactions with currentStep loaded
// 2. For each: check EtaCalculationService::getDelayDays() > 0
// 3. If overdue AND (last_overdue_notified_at is null OR > 24h ago):
//    - Send TransactionOverdueNotification to current_user + admins
//    - Update last_overdue_notified_at = now()
// 4. Log count of notifications sent
```

### Important Notes

- Laravel 12.x uses event auto-discovery — no EventServiceProvider registration needed
- All notification types use `database` channel only (no email in this story)
- The `HandleInertiaRequests` middleware already shares notification data generically — new types will automatically appear in the bell and be counted correctly
- The `NotificationController::index()` type filter already uses generic `data->type` matching — new types will automatically be filterable

### Dependencies

- **Story 3.8** (Done): Notification infrastructure — notifications table, NotificationController, NotificationBell, Notifications Index page
- **Story 3.5** (Done): Receive action — `EndorsementService::receive()`
- **Story 3.6** (Done): Complete action — `EndorsementService::complete()`
- **Story 3.9** (Done): ETA calculations — `EtaCalculationService::getDelayDays()`

### Testing

- **Test location**: `tests/Feature/` — one file per notification type or grouped as `NotificationTypesTest.php` (notification `toArray` tests also go in Feature tests, following the existing `OutOfWorkflowNotificationTest.php` pattern)
- **Testing framework**: PHPUnit with `RefreshDatabase` trait
- **Test patterns**: Follow `tests/Feature/OutOfWorkflowNotificationTest.php` patterns
- **Key assertions**: `Notification::assertSentTo()`, `Event::assertDispatched()`, `$this->artisan('opts:check-overdue')->assertSuccessful()`
- **TypeScript**: Run `npx tsc --noEmit` to verify frontend compiles

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-18 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

---

## QA Results
*(To be filled by QA agent)*
