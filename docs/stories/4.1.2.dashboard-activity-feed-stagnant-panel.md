# Story 4.1.2: Dashboard Activity Feed & Stagnant Transactions Panel

**Status**: Done
**Epic**: Epic 4.1 - Dashboard & Summary Views
**Story Statement**: As a user, I want to see recent system activity and a panel of stagnant/overdue transactions on the dashboard, so that I can stay informed of what's happening and identify items needing immediate attention.

---

## Acceptance Criteria

1. **Activity Feed Section**: Dashboard displays a "Recent Activity" panel showing:
   - Last 20 transaction actions system-wide (endorsements, receives, completions)
   - Each entry shows:
     - Action type icon (arrow-right for endorse, inbox for receive, check-circle for complete)
     - Transaction reference number (clickable link to transaction detail)
     - Actor name (who performed the action)
     - From office → To office (for endorse/receive)
     - Relative timestamp ("5 minutes ago", "2 hours ago")
   - Out-of-workflow actions flagged with amber warning indicator
   - Empty state: "No recent activity" when no actions exist
   - "View more" link at bottom (future: links to full activity log)

2. **Stagnant Transactions Panel**: Dashboard displays a "Needs Attention" panel showing:
   - Transactions flagged as stagnant (overdue or idle beyond threshold)
   - Sorted by `delay_days` descending (most overdue first)
   - Each entry shows:
     - Transaction reference number (clickable link)
     - Category badge (PR/PO/VCH)
     - Current office name
     - `DelaySeverityBadge` (Warning/Overdue with delay days)
     - Days at current step
   - Maximum 10 items displayed
   - Empty state: "All transactions are on track" with green checkmark
   - "View all stagnant" link (navigates to filtered transaction list)

3. **Dashboard Layout**: Arrange all dashboard sections in a cohesive layout:
   - Row 1: Summary cards (from Story 4.1.1)
   - Row 2: Office Workload table (from Story 4.1.1)
   - Row 3: Activity Feed (left/main) + Stagnant Panel (right/sidebar)
   - Responsive: stacks vertically on mobile

4. **Data Loading**: Controller provides activity and stagnant data:
   - Activity feed: latest 20 `TransactionAction` records with eager-loaded relationships
   - Stagnant list: active transactions where `is_stagnant = true`, limited to 10
   - Both datasets loaded in the existing `DashboardController@index` method (extend Story 4.1.1)

5. **TypeScript Interfaces**: Add to types:
   ```typescript
   interface ActivityFeedEntry {
     id: number;
     action_type: ActionType;
     transaction_reference_number: string;
     transaction_id: number;
     transaction_category: TransactionCategory;
     actor_name: string;
     from_office: string | null;
     to_office: string | null;
     is_out_of_workflow: boolean;
     created_at: string; // relative time string
   }

   interface StagnantTransaction {
     id: number;
     reference_number: string;
     category: TransactionCategory;
     current_office_name: string;
     delay_days: number;
     delay_severity: DelaySeverity;
     days_at_current_step: number;
     // For building the link to the correct show page
     purchase_request_id?: number;
     purchase_order_id?: number;
     voucher_id?: number;
   }
   ```

6. **Role-Based Behavior**:
   - All roles see activity feed and stagnant panel
   - Endorsers: stagnant panel highlights items at their office
   - Clickable links respect RBAC (link to transaction detail pages all roles can access)

7. **Performance**: Activity feed and stagnant panel load efficiently:
   - Activity feed: single query with joins, `LIMIT 20`
   - Stagnant list: avoid computing `is_stagnant` for ALL transactions — use query-level approximation or pre-filter active transactions, then compute

---

## Tasks / Subtasks

- [x] Task 1: Extend DashboardService with activity feed method (AC: 1, 4, 7)
  - [x] Add `getRecentActivity(int $limit = 20)` to `DashboardService`
  - [x] Query `transaction_actions` with joins to `transactions`, `users`, `offices`
  - [x] Select only needed columns, order by `created_at DESC`, limit 20
  - [x] Map results to `ActivityFeedEntry` structure
  - [x] Unit test: `DashboardServiceTest` — verify activity feed returns correct data

- [x] Task 2: Extend DashboardService with stagnant transactions method (AC: 2, 4, 7)
  - [x] Add `getStagnantTransactions(int $limit = 10)` to `DashboardService`
  - [x] Query active transactions (`status IN ('Created', 'In Progress')`) with workflow step data
  - [x] Compute stagnant status using `EtaCalculationService` (or raw SQL approximation for performance)
  - [x] Sort by `delay_days` desc, limit 10
  - [x] Include sub-entity IDs (purchase_request_id, etc.) for link building
  - [x] Unit test: verify stagnant detection and sorting

- [x] Task 3: Extend DashboardController (AC: 4)
  - [x] Add `activity_feed` and `stagnant_transactions` to Inertia props in `index()`
  - [x] Pass current user's office_id for highlighting

- [x] Task 4: Add TypeScript interfaces (AC: 5)
  - [x] Add `ActivityFeedEntry`, `StagnantTransaction` to `resources/js/types/models.ts`

- [x] Task 5: Build Activity Feed component (AC: 1, 3)
  - [x] Create `resources/js/Components/ActivityFeed.tsx`
  - [x] Action type icons using lucide-react (ArrowRight, Inbox, CheckCircle2)
  - [x] Clickable reference numbers linking to correct show page (PR/PO/VCH based on category)
  - [x] Out-of-workflow amber indicator
  - [x] Empty state
  - [x] "View more" link placeholder

- [x] Task 6: Build Stagnant Transactions Panel component (AC: 2, 3, 6)
  - [x] Create `resources/js/Components/StagnantPanel.tsx`
  - [x] Use existing `DelaySeverityBadge` for delay indicators
  - [x] Category badge (PR/PO/VCH) with color coding
  - [x] Clickable reference numbers
  - [x] Highlight items at current user's office
  - [x] Empty state with green checkmark
  - [x] "View all stagnant" link

- [x] Task 7: Integrate into Dashboard page layout (AC: 3)
  - [x] Update `Dashboard.tsx` to include ActivityFeed and StagnantPanel
  - [x] Two-column layout at bottom: ActivityFeed (2/3 width) + StagnantPanel (1/3 width)
  - [x] Responsive stacking on mobile

- [x] Task 8: Write feature tests (AC: 1-4, 6)
  - [x] Extend `tests/Feature/DashboardTest.php`
  - [x] Test activity feed data present in Inertia props
  - [x] Test stagnant transactions data present
  - [x] Test empty states (no actions, no stagnant)
  - [x] Test with seeded overdue transactions

---

## Dev Notes

### Existing Source Files to Reference

- **DashboardController**: `app/Http/Controllers/DashboardController.php` (created in Story 4.1.1)
- **DashboardService**: `app/Services/DashboardService.php` (created in Story 4.1.1)
- **TransactionAction model**: `app/Models/TransactionAction.php` — has `action_type`, `from_office_id`, `to_office_id`, `from_user_id`, `is_out_of_workflow`
- **EtaCalculationService**: `app/Services/EtaCalculationService.php` — `isStagnant()`, `getDelayDays()`, `getDelaySeverity()`, `getDaysAtCurrentStep()`
- **DelaySeverityBadge**: `resources/js/Components/DelaySeverityBadge.tsx` — reuse directly
- **Transaction model**: `app/Models/Transaction.php` — has `$appends` for ETA attributes, `purchaseRequest()`, `purchaseOrder()`, `voucher()` relationships
- **Dashboard page**: `resources/js/Pages/Dashboard.tsx` (updated in Story 4.1.1)
- **Types**: `resources/js/types/models.ts` — `ActionType`, `TransactionCategory`, `DelaySeverity`

### Activity Feed Query Pattern

```php
// Efficient activity feed query — single query with joins
$activity = TransactionAction::query()
    ->with([
        'fromUser:id,name',
        'fromOffice:id,name,abbreviation',
        'toOffice:id,name,abbreviation',
        'transaction:id,reference_number,category',
    ])
    ->select('id', 'transaction_id', 'action_type', 'from_user_id', 'from_office_id', 'to_office_id', 'is_out_of_workflow', 'created_at')
    ->whereIn('action_type', ['endorse', 'receive', 'complete'])
    ->orderByDesc('created_at')
    ->limit(20)
    ->get()
    ->map(fn ($action) => [
        'id' => $action->id,
        'action_type' => $action->action_type,
        'transaction_reference_number' => $action->transaction->reference_number,
        'transaction_id' => $action->transaction_id,
        'transaction_category' => $action->transaction->category,
        'actor_name' => $action->fromUser->name,
        'from_office' => $action->fromOffice?->abbreviation,
        'to_office' => $action->toOffice?->abbreviation,
        'is_out_of_workflow' => $action->is_out_of_workflow,
        'created_at' => $action->created_at->diffForHumans(),
    ]);
```

### Stagnant Transactions Query Strategy

Since `is_stagnant` is computed (not a DB column), we need a two-step approach:
1. Load active transactions with workflow step data (limited scope — only `In Progress` status)
2. Filter using `EtaCalculationService::isStagnant()` on each
3. Sort by delay_days desc, take top 10

For small-medium datasets (< 500 active transactions) this is fine. For larger datasets, consider a raw SQL approximation:
```sql
-- Approximate overdue: received_at + expected_days (business) < NOW()
WHERE received_at IS NOT NULL
AND DATEDIFF(NOW(), received_at) > expected_days
```

### Link Building for Transaction Detail

Transactions link to different show pages based on category:
- PR → `/purchase-requests/{purchase_request_id}`
- PO → `/purchase-orders/{purchase_order_id}`
- VCH → `/vouchers/{voucher_id}`

The stagnant query must include the sub-entity ID. Load via:
```php
$transaction->load(['purchaseRequest:id,transaction_id', 'purchaseOrder:id,transaction_id', 'voucher:id,transaction_id'])
```

### Testing

- **Test file**: `tests/Feature/DashboardTest.php` (extend from 4.1.1)
- **Testing framework**: PHPUnit/Pest with `RefreshDatabase`
- **Key scenarios**: Activity feed with mixed action types, stagnant panel with overdue transactions, empty states
- **Seed data**: Use factories to create transactions with `received_at` set to past dates to trigger stagnant detection
- **TypeScript**: Run `npx tsc --noEmit` to verify compile

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-16 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-02-16 | 1.1 | Implementation complete — all 8 tasks done | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (James - Dev Agent)

### Debug Log References
No debug issues encountered. All implementations worked on first pass.

### Completion Notes List
- Extended `DashboardService` with `getRecentActivity()` and `getStagnantTransactions()` methods
- Activity feed uses eager-loaded relationships (single query + N eager loads) for performance
- Stagnant transactions pre-loads office names in bulk to avoid N+1 from `currentHolder` accessor
- Both interfaces include `purchase_request_id`, `purchase_order_id`, `voucher_id` for frontend link building
- ActivityFeed component uses lucide-react icons (ArrowRight, Inbox, CheckCircle2) per AC
- StagnantPanel reuses existing `DelaySeverityBadge` component
- Dashboard layout: 2/3 + 1/3 grid on desktop, stacks on mobile via `lg:grid-cols-3`
- "View more" is a placeholder link (future: full activity log page)
- "View all stagnant" navigates to transactions index (future: pre-filtered for stagnant)
- 33 total dashboard tests pass (17 unit + 16 feature)
- TypeScript compiles clean with `npx tsc --noEmit`
- Pint passes on all changed files
- 28 pre-existing test failures in other test files (PurchaseOrderController, PurchaseRequestController, etc.) — not related to this story

### File List
- `app/Services/DashboardService.php` — Modified: added `getRecentActivity()`, `getStagnantTransactions()`, used Transaction import
- `app/Http/Controllers/DashboardController.php` — Modified: added `activityFeed` and `stagnantTransactions` Inertia props
- `resources/js/types/models.ts` — Modified: added `ActivityFeedEntry` and `StagnantTransaction` interfaces
- `resources/js/Components/ActivityFeed.tsx` — New: Activity feed component
- `resources/js/Components/StagnantPanel.tsx` — New: Stagnant transactions panel component
- `resources/js/Pages/Dashboard.tsx` — Modified: integrated ActivityFeed and StagnantPanel in layout
- `tests/Unit/Services/DashboardServiceTest.php` — Modified: added 8 unit tests for activity feed and stagnant methods
- `tests/Feature/DashboardTest.php` — Modified: added 7 feature tests for activity feed and stagnant panel

---

## QA Results
*(To be filled by QA agent)*
